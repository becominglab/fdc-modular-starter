# Phase 14.6.5: AI利用設計ランブック

## メタ情報

| 項目 | 値 |
|------|---|
| **Phase** | 14.6.5 |
| **バージョン** | 1.4.0 |
| **ステータス** | ✅ 設計完了 |
| **最終更新** | 2025-12-02 |
| **次Phase** | 14.7（テナント別AI設定・AI機能実装） |

---

## Phase 14.6.5 DOD（完了定義）

本ドキュメントの完了条件：

- [x] 主要ユースケース（UC-01〜UC-10）が定義され、実装キーとの対応表がある
- [x] 各UCについて、入力情報・出力フォーマット・出力例が1つ以上ある
- [x] 会話フロー（ワンショット／マルチターン）とコンテキストレベルが定義されている
- [x] AIエラー時のユーザー表示とフォールバック方針が定義されている
- [x] トークン・レイテンシ・コスト制御のポリシーが定義されている
- [x] ガバナンス・コンプライアンス指針が定義されている
- [x] 14.7 で実装すべきMVP項目が表形式で整理されている

---

## 目次

1. [位置づけ](#1-位置づけ)
2. [ユースケース定義](#2-ユースケース定義)
3. [プロンプト詳細設計](#3-プロンプト詳細設計)
4. [会話フロー設計](#4-会話フロー設計)
5. [UI/UX設計](#5-uiux設計)
6. [コンテキスト注入設計](#6-コンテキスト注入設計)
7. [出力フォーマット設計](#7-出力フォーマット設計)
8. [エラー・フォールバック設計](#8-エラーフォールバック設計)
9. [トークン・レイテンシ・コスト設計](#9-トークンレイテンシコスト設計)
10. [ガバナンス・コンプライアンス指針](#10-ガバナンスコンプライアンス指針)
11. [Phase 14.7 との連携](#11-phase-147-との連携)
12. [付録: プロンプト全文](#12-付録-プロンプト全文)

---

## 0. 読者別ガイド

| 読者 | 参照すべきセクション | 目的 |
|------|---------------------|------|
| **PdM / Biz** | §1（位置づけ）, §2.1（UC一覧）, §9（コスト・レイテンシ） | スコープ・コスト感の把握 |
| **Claude Code / バックエンド** | §2.2（型定義）, §4（会話フロー）, §6（コンテキスト注入） | 実装仕様の参照 |
| **フロントエンド** | §5（UI/UX設計）, §4.2-4.3（ワンショット/マルチターン） | UI実装の参照 |
| **セキュリティ / ガバナンス** | §8（エラー処理）, §10（ガバナンス） | コンプライアンス確認 |

---

## 1. 位置づけ

### 1.1 本ドキュメントの目的

Phase 14.7（テナント別AI設定・AI機能実装）の前に、AI機能の**具体的な利用設計**を定義する。

### 1.1.1 AI利用設計の基本原則

本設計全体を通じて、以下の価値観を優先する：

1. **「そのままコピペで使える」を最優先** - 説明テキストよりも、テンプレ出力の質を重視
2. **レイテンシ > 超高精度** - 営業現場での即時性を重視。分析系UCのみ精度優先を許容
3. **シンプルさ > 多機能** - 迷わせないUI、選択肢は最小限に

### 1.1.2 仕様の優先順位

本ドキュメントと実装コードに差分が生じた場合の優先順位：

1. **実装コード**（`lib/types/*`, `lib/core/ai-prompt-templates.ts`）
2. **本ランブック**（構造・意図・設計思想）
3. **付録プロンプト全文**（設計時点のスナップショット）

### 1.2 14.6.5 と 14.7 の境界

| 項目 | 14.6.5 で確定 | 14.7 で決める |
|------|--------------|--------------|
| **ユースケース** | UC一覧、優先度、実装キー | - |
| **会話モデル** | ワンショット/マルチターンの概念 | 会話履歴の保存粒度（1メッセージ or セッション） |
| **出力フォーマット** | 論理構造（件名案・本文・タイミング等） | 最終日本語文言の微調整 |
| **プロンプト** | 論理構造と必須要素 | モデル名（gpt-4o-mini等）、テンプレ文言調整 |
| **コンテキスト** | どのエンティティから何を取るかの項目定義 | 実際のフィールド名のマッピング |
| **UI** | アクセスポイント、ワイヤーフレーム | 実装詳細、スタイリング |
| **エラー処理** | エラー種別とユーザー表示方針 | 具体的なリトライロジック |
| **ポリシー** | トークン上限、レイテンシ目標 | テナント別クォータの実数値 |

### 1.3 既存実装の整理

| ファイル | 内容 | 状態 |
|----------|------|------|
| `lib/core/ai-context.ts` | PII除外・サニタイズ | ✅ 完成 |
| `lib/core/ai-prompt-templates.ts` | 5カテゴリのシステムプロンプト | ✅ 完成（本設計で拡張） |
| `lib/core/business-summary.ts` | ビジネスサマリー生成 | ✅ 完成 |
| `app/api/ai/chat/route.ts` | AIチャットAPI | ✅ 完成 |

---

## 2. ユースケース定義

### 2.1 主要ユースケース一覧

FDCユーザー（スタートアップ創業者・営業担当）が実際に使うシーンを定義：

| UC-ID | ユースケース | 実装キー | カテゴリ | 頻度 | 優先度 |
|-------|------------|---------|---------|------|--------|
| UC-01 | 見込み客への初回コンタクト文作成 | `initial_contact` | sales | 高 | 🔴 MVP |
| UC-02 | フォローアップメール作成 | `follow_up` | sales | 高 | 🔴 MVP |
| UC-03 | 反論・断り対応のアドバイス | `objection_handling` | sales | 中 | 🔴 MVP |
| UC-04 | 提案書の構成提案 | `proposal_outline` | writing | 中 | 🟡 14.8 |
| UC-05 | クロージングアドバイス | `closing_advice` | sales | 中 | 🟡 14.8 |
| UC-06 | 売上・パイプライン分析 | `pipeline_analysis` | analysis | 低 | 🟢 将来 |
| UC-07 | OKR設定支援 | `okr_setting` | strategy | 低 | 🟢 将来 |
| UC-08 | 次アクション提案 | `next_action` | action | 高 | 🔴 MVP |
| UC-09 | タスク優先順位アドバイス | `task_prioritization` | action | 中 | 🟡 14.8 |
| UC-10 | 顧客課題の整理・言語化 | `problem_articulation` | sales | 中 | 🟡 14.8 |

### 2.2 型定義（参考実装サンプル）

> **注意**: 実装時は `lib/types/ai-use-cases.ts` を**正**として管理する。
> 本セクションは「設計意図を示すサンプル」として扱い、コードとの差分が生じた場合はコード側を優先する。

```typescript
// lib/types/ai-use-cases.ts

export type UseCaseKey =
  | 'initial_contact'
  | 'follow_up'
  | 'objection_handling'
  | 'proposal_outline'
  | 'closing_advice'
  | 'pipeline_analysis'
  | 'okr_setting'
  | 'next_action'
  | 'task_prioritization'
  | 'problem_articulation';

export type UseCaseCategory = 'sales' | 'action' | 'analysis' | 'writing' | 'strategy';

export type UseCasePriority = 'mvp' | 'phase14.8' | 'future';

export interface UseCaseDefinition {
  id: `UC-${string}`;
  key: UseCaseKey;
  label: string;
  description: string;
  category: UseCaseCategory;
  priority: UseCasePriority;
  conversationModel: 'oneshot' | 'multiturn';
  contextLevel: 'minimal' | 'standard' | 'detailed' | 'entity';
}

export const USE_CASES: Record<UseCaseKey, UseCaseDefinition> = {
  initial_contact: {
    id: 'UC-01',
    key: 'initial_contact',
    label: '初回コンタクト文作成',
    description: '新しい見込み客への初回コンタクトメールを作成',
    category: 'sales',
    priority: 'mvp',
    conversationModel: 'oneshot',
    contextLevel: 'entity',
  },
  follow_up: {
    id: 'UC-02',
    key: 'follow_up',
    label: 'フォローアップメール作成',
    description: '商談後のフォローアップメールを作成',
    category: 'sales',
    priority: 'mvp',
    conversationModel: 'oneshot',
    contextLevel: 'entity',
  },
  objection_handling: {
    id: 'UC-03',
    key: 'objection_handling',
    label: '反論対応アドバイス',
    description: '価格・競合等の反論への対応スクリプトを作成',
    category: 'sales',
    priority: 'mvp',
    conversationModel: 'multiturn',
    contextLevel: 'entity',
  },
  next_action: {
    id: 'UC-08',
    key: 'next_action',
    label: '次アクション提案',
    description: '見込み客・既存客の次アクションを優先度順に提案',
    category: 'action',
    priority: 'mvp',
    conversationModel: 'oneshot',
    contextLevel: 'standard',
  },
  // ... 他のユースケース
};
```

### 2.3 UC詳細の記載方針

> **方針**: MVP対象UC（🔴）は本ドキュメント内に詳細（入力・出力・例）を記載する。
> 非MVP（🟡/🟢）は Phase 14.8 以降で詳細化する。

### 2.4 各ユースケースの詳細

#### UC-01: 見込み客への初回コンタクト文作成

**粒度**: 本セクションでは入力項目・出力構造・出力例を定義。最終文言は14.7で調整可。

**入力情報**:
| フィールド | ソース | 必須 |
|-----------|--------|------|
| 会社名 | `lead.company` | ○ |
| 担当者名 | `lead.name`（マスク済み） | - |
| 業種 | `lead.industry` | - |
| 規模 | `lead.company_size` | - |
| 問い合わせソース | `lead.source` | - |
| 問い合わせ内容 | `lead.notes` | - |
| 自社提供価値 | `workspace.leanCanvas.uniqueValueProposition` | - |

**出力構造**:
```
【件名案】（2-3案）
【本文 A: フォーマル】
【本文 B: カジュアル】
【送信タイミング】推奨と理由
```

**出力例**:
```
【件名案】
A) 導入事例のご案内｜FDCカスタマーサクセスより
B) 【FDC】導入事例をお送りします
C) Re: 導入事例のお問い合わせありがとうございます

【本文 A: フォーマル】
株式会社サンプル
ご担当者様

お世話になっております。
FDCカスタマーサクセスの[担当者名]です。

この度は弊社サービスにご関心をお寄せいただき、
誠にありがとうございます。

お問い合わせいただきました導入事例について、
御社と同じIT業界の事例をまとめましたので、
添付資料をご確認いただければ幸いです。

ご質問やご不明点がございましたら、
お気軽にお申し付けください。

引き続きよろしくお願いいたします。

【送信タイミング】
推奨: 問い合わせ当日〜翌営業日午前中
理由: 記憶が新しいうちにレスポンスすることで返信率向上
```

---

#### UC-03: 反論・断り対応のアドバイス

**入力情報**:
| フィールド | ソース | 必須 |
|-----------|--------|------|
| 反論内容 | ユーザー入力 | ○ |
| 会社名 | `lead.company` | - |
| ステータス | `lead.status` | - |
| 商談履歴 | `lead.notes` | - |

**出力構造**:
```
【反論の真意を探る質問】（2-3個）
【対応パターン】
  A) 共感型アプローチ
  B) 論理型アプローチ
  C) 提案型アプローチ
【避けるべき対応】
```

---

#### UC-08: 次アクション提案

**入力情報**:
| フィールド | ソース | 必須 |
|-----------|--------|------|
| 見込み客リスト | `leads[]` | ○ |
| 既存客リスト | `clients[]` | - |
| 各顧客のステータス | `*.status` | ○ |
| 最終コンタクト日 | `*.lastContactDate` | ○ |

**出力構造**:
```
【優先度A: 今日やるべき】
【優先度B: 今週中】
【優先度C: 来週以降】
```

---

## 3. プロンプト詳細設計

**粒度**: 本セクションでは論理構造と必須要素を定義。最終日本語文言は14.7でテンプレート化時に微調整可。

> **実装との関係**: 実際のシステムプロンプトの定義・更新は `lib/core/ai-prompt-templates.ts` で行う。
> 本セクションは「構造と必須要素」を規定する設計ドキュメントであり、コードが正。

### 3.1 システムプロンプト構成

```
┌─────────────────────────────────────────────────┐
│ ベースプロンプト（全UC共通）                       │
│ - ロール定義                                     │
│ - 回答ガイドライン                               │
│ - 禁止事項                                       │
└───────────────┬─────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────┐
│ カテゴリプロンプト                                │
│ - sales / action / analysis / writing / strategy │
│ - カテゴリ固有の指示と出力形式                    │
└───────────────┬─────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────┐
│ ビジネスコンテキスト                              │
│ - MVV / LeanCanvas / OKR（contextLevelに応じて）  │
└───────────────┬─────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────┐
│ エンティティコンテキスト（UCに応じて）            │
│ - 対象の見込み客/既存客情報                      │
│ - 商談履歴・ノート                               │
└─────────────────────────────────────────────────┘
```

### 3.2 ベースプロンプト（必須要素）

| 要素 | 内容 |
|------|------|
| ロール | FDCのAIアシスタント「FDCアシスタント」 |
| 対象ユーザー | スタートアップ創業者・営業担当者 |
| 回答形式 | すぐ使える形（コピペ可能）、具体的、簡潔 |
| 言語 | 日本語（ビジネス日本語） |
| 複数案 | 可能な場合は2-3パターン提示 |

**禁止事項**（必須）:
- 架空の数字・実績を生成しない
- ユーザー企業以外の具体的な社名を出さない
- 法的・医療・財務アドバイスをしない
- 個人情報を推測・生成しない

### 3.3 カテゴリ別プロンプト構造

| カテゴリ | 役割 | 出力形式 |
|---------|------|----------|
| `sales` | 営業活動支援 | 件名案+本文+送信タイミング |
| `action` | アクション提案 | 優先度別リスト |
| `analysis` | データ分析 | 要点+詳細+推奨アクション |
| `writing` | 文章作成 | 構成案+本文 |
| `strategy` | 戦略立案 | 目標+施策+KPI |

---

## 4. 会話フロー設計

### 4.1 会話モデル

| モデル | 説明 | 対象UC | コンテキスト維持 |
|--------|------|--------|-----------------|
| **ワンショット** | 1回の入力で完結 | UC-01, UC-02, UC-08 | なし |
| **マルチターン** | 複数回のやり取り | UC-03, UC-07 | セッション内で維持 |

### 4.2 ワンショット会話フロー

```
[ユーザー] AIボタンクリック
    ↓
[システム] コンテキスト自動収集
    ↓
[ユーザー] プリセット選択 or 自由入力
    ↓
[AI] 応答（ストリーミング）
    ↓
[ユーザー] コピー / 再生成 / 保存
```

### 4.3 マルチターン会話フロー

```
[ユーザー] チャットパネル開く
    ↓
[システム] 初回コンテキスト注入
    ↓
[ユーザー] 質問
    ↓
[AI] 応答
    ↓
[ユーザー] 追加質問（ループ）
    ↓
[システム] 5分無操作でセッションリセット
```

### 4.4 コンテキスト維持仕様

**14.6.5 で確定**:
```typescript
interface ConversationContext {
  sessionId: string;
  startedAt: Date;
  messages: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp: Date;
  }>;
  initialContext: {
    businessSummary: string;
    targetEntity?: {
      type: 'lead' | 'client';
      id: string;
    };
  };
  totalTokens: number;
}
```

**14.7 で決める**:
- 会話履歴の保存粒度（1メッセージ単位 or セッション単位）
- DBスキーマ設計
- セッションIDの生成方式

**コンテキスト維持ルール**（確定）:
- 会話履歴は最新10メッセージまで保持
- 5分間操作がない場合、セッションをリセット
- 総トークン数が8000を超えたら古いメッセージを削除

> **8000トークンの根拠**: 使用モデル（既定: gpt-4o-mini、context window 128K）に対し、
> システムプロンプト + ビジネスコンテキスト + 出力余地を確保しつつ、コスト/レイテンシを抑えるために 8,000 で打ち切る。

---

## 5. UI/UX設計

**粒度**: 本セクションではアクセスポイントとワイヤーフレームを定義。実装詳細・スタイリングは14.7で決定。

### 5.1 AIアクセスポイント

| 場所 | トリガー | ユースケース | 14.7 MVP |
|------|----------|-------------|----------|
| グローバルAIボタン | ヘッダーの✨アイコン | 一般質問 | ✅ |
| 見込み客詳細 | 「AIで文章作成」ボタン | UC-01, UC-02, UC-03 | ✅ |
| 既存客詳細 | 「AIで文章作成」ボタン | フォローアップ | ✅ |
| リスト画面 | 「AIで次アクション提案」 | UC-08 | 🟡 14.8 |
| タスク画面 | 「AIで優先順位提案」 | UC-09 | 🟡 14.8 |

### 5.2 14.7 MVP UI（必須）

#### 5.2.1 AIチャットパネル（サイドパネル）

```
┌─────────────────────────────────────────┐
│ ✨ FDCアシスタント            [×]      │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 📊 コンテキスト                      │ │
│ │ 見込み客: 株式会社サンプル           │ │
│ │ ステータス: 提案中                   │ │
│ └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│                                         │
│  [会話メッセージエリア]                  │
│                                         │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 質問を入力...                       │ │
│ └─────────────────────────────────────┘ │
│ [送信]                                  │
└─────────────────────────────────────────┘
```

**14.7 MVP 必須要素**:
- コンテキスト表示（対象エンティティ名）
- メッセージ入力・送信
- ストリーミング応答表示
- コピーボタン
- 閉じるボタン

#### 5.2.2 見込み客詳細画面のAIボタン

```
┌─────────────────────────────────────────┐
│ 見込み客詳細: 株式会社サンプル          │
├─────────────────────────────────────────┤
│ ステータス: 提案中                       │
│ ...                                     │
├─────────────────────────────────────────┤
│ [✨ AIで文章作成]                        │  ← 14.7 MVP
└─────────────────────────────────────────┘
```

### 5.3 14.8 以降で拡張予定のUI

| UI | 内容 | Phase |
|----|------|-------|
| クイックアクション | ワンクリックで定型プロンプト実行 | 14.8 |
| リスト画面AI | 複数顧客への一括次アクション提案 | 14.8 |
| 会話履歴一覧 | 過去の会話を検索・再開 | 14.9 |
| AI設定画面 | ユーザー別のAI設定 | 14.9 |

### 5.4 AI無効時のUI（14.7 MVP）

```
┌─────────────────────────────────────────┐
│ ✨ FDCアシスタント                      │
├─────────────────────────────────────────┤
│                                         │
│   🔒 AI機能は現在オフです                │
│                                         │
│   管理者がAI機能を有効に                │
│   設定すると利用できます                │
│                                         │
│   [管理者に連絡]                        │
│                                         │
└─────────────────────────────────────────┘
```

---

## 6. コンテキスト注入設計

**粒度**: 本セクションではどのエンティティから何を取るかの項目を定義。実際のフィールド名は `business-summary.ts` / `lead` モデルに合わせて14.7で合わせ込む。

### 6.1 コンテキストレベル定義

| レベル | トークン目安 | 用途 |
|--------|------------|------|
| `minimal` | ~500 | 統計のみ。一般質問向け |
| `standard` | ~1500 | MVV + OKR + リード概要。営業支援 |
| `detailed` | ~3000 | 上記 + 成功事例 + 履歴。戦略相談 |
| `entity` | ~500 | 対象の詳細情報。個別顧客対応 |

### 6.2 レベル別取得項目

| 項目 | minimal | standard | detailed | entity |
|------|---------|----------|----------|--------|
| **統計情報** |
| 見込み客数 | ○ | ○ | ○ | - |
| 既存客数 | ○ | ○ | ○ | - |
| 未完了タスク数 | ○ | ○ | ○ | - |
| **MVV** |
| ミッション | - | ○ | ○ | - |
| ビジョン | - | ○ | ○ | - |
| バリュー | - | - | ○ | - |
| **LeanCanvas** |
| 顧客セグメント | - | ○ | ○ | - |
| 提供価値 | - | ○ | ○ | - |
| 課題 | - | - | ○ | - |
| **OKR** |
| 会社目標（上位3件） | - | ○ | ○ | - |
| KR進捗 | - | - | ○ | - |
| **営業情報** |
| 見込み客サマリー（上位10件） | - | ○ | ○ | - |
| 既存客サマリー（上位10件） | - | - | ○ | - |
| 成功事例 | - | - | ○ | - |
| **エンティティ詳細** |
| 会社名 | - | - | - | ○ |
| 担当者名（マスク済み） | - | - | - | ○ |
| 業種・規模 | - | - | - | ○ |
| ステータス | - | - | - | ○ |
| 最終コンタクト日 | - | - | - | ○ |
| 滞留日数 | - | - | - | ○ |
| 商談履歴（最新5件） | - | - | - | ○ |
| メモ | - | - | - | ○ |

### 6.3 UC別コンテキストレベル

| UC | ビジネスコンテキスト | エンティティコンテキスト |
|----|---------------------|------------------------|
| UC-01 初回コンタクト | standard | ○（対象Lead） |
| UC-02 フォローアップ | standard | ○（対象Lead） |
| UC-03 反論対応 | standard | ○（対象Lead） |
| UC-08 次アクション | standard | -（リスト全体を参照） |

### 6.4 コンテキストレベル × パフォーマンス対応表

| contextLevel | 想定トークン | 想定レイテンシ (P95) | 主なUC | 設計意図 |
|--------------|------------|---------------------|--------|---------|
| `minimal` | ~500 | 2〜3秒 | 一般質問 | 軽量・即応 |
| `standard` | ~1,500 | 3〜5秒 | UC-01, UC-02, UC-08 | 営業現場の標準 |
| `detailed` | ~3,000 | 5〜8秒 | UC-06, UC-07 | 分析・戦略系 |
| `entity` | ~500 (+standard) | 3〜5秒 | UC-01, UC-02, UC-03 | 個別リード対応 |

> **活用例**: 「standard を detailed に上げたい」→ レイテンシが +2〜3秒、トークンが +1,500 増加することを事前に把握できる。

### 6.5 自動コンテキスト選択ロジック

```typescript
function selectContextConfig(useCaseKey: UseCaseKey): {
  businessLevel: ContextLevel;
  includeEntity: boolean;
} {
  const uc = USE_CASES[useCaseKey];

  return {
    businessLevel: uc.contextLevel === 'entity' ? 'standard' : uc.contextLevel,
    includeEntity: uc.contextLevel === 'entity',
  };
}
```

---

## 7. 出力フォーマット設計

### 7.1 メール作成時（UC-01, UC-02）

```markdown
【件名案】
A) [フォーマル版]
B) [カジュアル版]
C) [短縮版]

---

【本文 A: フォーマル】

[本文]

---

【本文 B: カジュアル】

[本文]

---

【送信タイミング】
推奨: [タイミング]
理由: [理由]
```

### 7.2 次アクション提案時（UC-08）

```markdown
## 📋 次アクション提案

### 🔴 優先度A: 今日中

| 顧客 | アクション | 理由 |
|------|-----------|------|
| [会社名] | [アクション] | [理由] |

### 🟡 優先度B: 今週中

| 顧客 | アクション | 理由 |
|------|-----------|------|
| [会社名] | [アクション] | [理由] |

### 🟢 優先度C: 来週以降

| 顧客 | アクション | 理由 |
|------|-----------|------|
| [会社名] | [アクション] | [理由] |
```

### 7.3 反論対応時（UC-03）

```markdown
## 💬 反論対応ガイド

### 反論: 「[反論内容]」

---

### 🔍 まず確認すべきこと

1. [質問1]
2. [質問2]
3. [質問3]

---

### 💡 対応パターン

**A) 共感型アプローチ**
「[スクリプト]」

**B) 論理型アプローチ**
「[スクリプト]」

**C) 提案型アプローチ**
「[スクリプト]」

---

### ⚠️ 避けるべき対応

- [避けるべきこと1]
- [避けるべきこと2]
```

---

## 8. エラー・フォールバック設計

### 8.1 エラー種別と対応

| エラー種別 | 原因 | ユーザー表示 | 技術的対応 |
|-----------|------|-------------|-----------|
| `rate_limit` | 5req/min超過 | 「少々お待ちください（残り○秒）」 | 残り時間表示、自動リトライ |
| `ai_disabled` | テナントAI無効 | 「AI機能がオフです」 | 管理者連絡リンク |
| `no_api_key` | APIキー未設定 | 「AI機能がオフです」 | 管理者連絡リンク |
| `quota_exceeded` | 月間上限超過 | 「月間使用量の上限に達しました」 | 次月リセット日表示 |
| `api_error` | OpenAI障害 | 「一時的なエラーです」 | リトライボタン |
| `context_too_large` | トークン超過 | （内部処理） | 自動コンテキスト削減 |
| `timeout` | 30秒超過 | 「応答に時間がかかっています」 | リトライボタン |

### 8.2 フォールバック戦略

```typescript
async function handleAIRequest(request: AIRequest): Promise<AIResponse> {
  try {
    return await callOpenAI(request);
  } catch (error) {
    // 1. レート制限: 指数バックオフでリトライ
    if (error.code === 'rate_limit') {
      await delay(error.retryAfter);
      return await callOpenAI(request);
    }

    // 2. コンテキスト超過: 削減して再試行
    if (error.code === 'context_too_large') {
      const reducedRequest = reduceContext(request);
      return await callOpenAI(reducedRequest);
    }

    // 3. その他: フォールバックテンプレート
    return {
      success: false,
      error: getUserFriendlyError(error),
      fallback: getFallbackTemplate(request.useCaseKey),
    };
  }
}
```

### 8.3 フォールバックテンプレート

AIが使えない場合に提供する基本テンプレート:

```typescript
const FALLBACK_TEMPLATES: Record<UseCaseKey, string> = {
  initial_contact: `
【件名】ご連絡のお礼と情報のご案内

{{company}}
ご担当者様

お世話になっております。
{{myCompany}}の{{myName}}です。

この度はお問い合わせいただきありがとうございます。
ご興味をお持ちいただいた内容について、
詳しい資料をお送りさせていただきます。

ご質問等ございましたらお気軽にお申し付けください。

よろしくお願いいたします。
`,
  // ... 他のテンプレート
};
```

---

## 9. トークン・レイテンシ・コスト設計

> **14.7 との関係**: 本セクションは「設計思想・ポリシーレベル」の目標値を記載する。
> 数値の最終値は Phase 14.7 のテナントAI設定（`TenantAISettings.quota`）で決定する。

### 9.1 パフォーマンス目標

| 指標 | 目標値 | 備考 |
|------|--------|------|
| P95 レスポンス時間 | 5秒以内 | AI応答完了まで |
| P50 レスポンス時間 | 2秒以内 | AI応答完了まで |
| ストリーミング開始 | 500ms以内 | 最初のトークンまで |

### 9.2 トークン制限

| 項目 | 制限値 | 備考 |
|------|--------|------|
| 1リクエストあたり max tokens | 4096 | input + output |
| 会話履歴の保持上限 | 8000 tokens | セッション内 |
| コンテキストの上限 | 3000 tokens | detailed レベル |

### 9.3 コスト制御

| プラン | リクエスト/日 | トークン/月 | コスト上限/月 |
|--------|-------------|------------|--------------|
| 標準 | 50 | 500,000 | $10 |
| Pro | 500 | 5,000,000 | $100 |

**コスト計算ベース**（gpt-4o-mini）:
- Input: $0.15 / 1M tokens
- Output: $0.60 / 1M tokens

### 9.4 カテゴリ別パフォーマンス目安

| カテゴリ | 対象UC | 目標レイテンシ (P95) | 想定トークン/リクエスト | 設計意図 |
|---------|--------|---------------------|----------------------|---------|
| **sales** | UC-01, UC-02, UC-03 | **3〜5秒** | 2,000〜3,000 | 営業現場で即使える。軽く速く |
| **action** | UC-08, UC-09 | **3〜5秒** | 1,500〜2,500 | 次アクションは即決。軽量 |
| **analysis** | UC-06 | **10秒以内** | 5,000〜8,000 | 分析は重くてOK。精度優先 |
| **writing** | UC-04 | **5〜8秒** | 3,000〜5,000 | 提案書構成。中程度 |
| **strategy** | UC-07 | **10秒以内** | 4,000〜6,000 | OKR設定。じっくり考える |

> **注**: 数値は目安レンジ。14.7で実測後に調整可。設計意図（軽い/重い）は変更不可。

### 9.5 縮約戦略

`context_too_large` 発生時の削減順序:

1. 商談履歴を最新3件に削減
2. 成功事例を削除
3. OKR詳細を削除
4. 見込み客サマリーを5件に削減
5. LeanCanvas詳細を削除

---

## 10. ガバナンス・コンプライアンス指針

### 10.1 PII・機微情報の取り扱い

| 情報種別 | 取り扱い |
|---------|---------|
| メールアドレス | **コンテキストに含めない**（完全除外） |
| 電話番号 | **コンテキストに含めない**（完全除外） |
| 個人名 | マスキング（例: 望月貴生 → M***） |
| 会社名 | そのまま送信（ビジネス分析に必要） |
| 商談金額 | そのまま送信 |

### 10.2 ログ保存方針

| 項目 | 保存 | 保存期間 |
|------|------|---------|
| リクエスト内容 | ○（PII除外後） | 90日 |
| AI応答 | ○ | 90日 |
| トークン数・コスト | ○ | 1年 |
| ユーザーID | ○ | 1年 |
| 元のPII情報 | × | - |

### 10.3 コンテンツ生成ルール

| ルール | 詳細 |
|--------|------|
| 架空実績の禁止 | 数字・実績は生成しない。参照データがない場合は「[要確認]」 |
| 社名の禁止 | ユーザー企業以外の具体的な社名を出さない |
| 専門アドバイスの禁止 | 法的・医療・財務アドバイスをしない |
| 個人情報推測の禁止 | 提供されていない個人情報を推測・生成しない |

### 10.4 モデル切替ポリシー

将来 OpenAI 以外を使う場合の方針:

- APIキーはテナント単位で管理（既に設計済み）
- プロンプトは抽象化し、モデル依存部分を分離
- 切替時はテナント単位で段階的に移行可能

---

## 11. Phase 14.7 との連携

### 11.1 14.7 MVP サマリ（1枚で把握）

**14.7で実装するMVP:**

| 項目 | 内容 |
|------|------|
| **対象UC** | UC-01, UC-02, UC-03, UC-08 |
| **コンテキストレベル** | entity / standard のみ |
| **会話モデル** | ワンショット + 一部マルチターン（UC-03） |
| **UI** | AIチャットパネル（サイドパネル）+ 見込み客詳細画面のAIボタン |
| **無効時対応** | グレーアウト + 理由別メッセージ表示 |

### 11.2 UC ↔ UI ↔ API マッピング表

| UC-ID | UseCaseKey | カテゴリ | UIエントリポイント | 呼び出しAPI |
|-------|------------|---------|-------------------|-------------|
| UC-01 | `initial_contact` | sales | Lead詳細画面 → [✨ AIで文章作成] | `POST /api/ai/chat` with `useCaseKey` |
| UC-02 | `follow_up` | sales | Lead詳細画面 → [✨ AIで文章作成] | `POST /api/ai/chat` with `useCaseKey` |
| UC-03 | `objection_handling` | sales | Lead詳細画面 → [✨ AIで文章作成] → クイックアクション | `POST /api/ai/chat` with `useCaseKey` |
| UC-08 | `next_action` | action | グローバルAIパネル → クイックアクション | `POST /api/ai/chat` with `useCaseKey` |

### 11.3 14.7 Sub-Phase との対応

| Sub-Phase | 項目 | 本設計との対応 |
|-----------|------|---------------|
| 14.7-B | APIエンドポイント | §8 エラー処理 |
| 14.7-C | テナントAI設定UI | §5.4 AI無効時UI |
| 14.7-D | AIチャットパネル | §5.2.1 ワイヤーフレーム, §11.2 マッピング |
| 14.7-G | AI無効時UI制御 | §5.4, §8.1 |

### 11.4 14.7 で決める詳細

| 項目 | 14.7 で決定する内容 |
|------|-------------------|
| 会話履歴保存 | DBスキーマ、保存粒度 |
| フィールドマッピング | `lead.company` 等の実際のパス |
| モデル名 | `gpt-4o-mini` 等の具体値 |
| リトライロジック | 指数バックオフの具体パラメータ |

### 11.5 14.8 以降で実装

| Phase | 項目 |
|-------|------|
| 14.8 | UC-04, UC-05, UC-09, UC-10 |
| 14.8 | クイックアクション、リスト画面AI |
| 14.9 | 会話履歴一覧・検索 |

---

## 12. 付録: プロンプト全文

> **注意**: 実装の最新版は必ず `lib/core/ai-prompt-templates.ts` を参照すること。
> 本付録は「設計時点のスナップショット」として扱い、コードとの差分が生じた場合はコード側を優先する。

### 12.1 ベースシステムプロンプト

```markdown
あなたは Founders Direct Cockpit (FDC) の AI アシスタント「FDCアシスタント」です。
スタートアップ創業者・営業担当者のビジネス運営をサポートします。

## 回答のガイドライン

1. **すぐ使える形で回答**: コピペで使えるメール文、スクリプトを提供
2. **具体的に**: 抽象的な説明ではなく、実行可能なアクションを提案
3. **ビジネスコンテキストを活用**: 提供された情報を必ず参照
4. **簡潔に**: 長文は避け、要点を絞る（メールは200文字以内が理想）
5. **日本語で回答**: ビジネス日本語で丁寧に
6. **複数案を提示**: 可能な場合は2-3パターン提示

## 禁止事項

- 架空の数字・実績を生成しない
- ユーザー企業以外の具体的な社名を出さない
- 法的・医療・財務アドバイスをしない
- 個人情報を推測・生成しない

## 出力形式

- メール作成時: 件名案 + 本文（複数パターン）+ 送信タイミング
- アクション提案時: 優先度別リスト
- 分析時: 要点 + 詳細 + 推奨アクション
```

### 12.2 営業支援プロンプト（sales）

```markdown
## あなたの役割

営業活動を支援するアドバイザーとして、以下をサポートします：

- **初回コンタクト**: 興味を引く導入文、適切なトーン選択
- **フォローアップ**: 状況に応じた再アプローチ戦略
- **反論対応**: 価格・競合・タイミングなどの反論への対応
- **クロージング**: 契約に向けた最終プッシュ

## 営業の基本原則

1. 顧客の課題を理解してから提案する
2. 価値を伝え、価格で勝負しない
3. 適切なタイミングでフォローする
4. 信頼関係を最優先する

## 出力フォーマット（メール作成時）

【件名案】（2-3案）
A) [フォーマル版]
B) [カジュアル版]
C) [短縮版]

【本文】
（宛先）
（挨拶）
（本題 - 200文字以内）
（CTA - 明確な次のアクション）
（結び）

【送信タイミング】
推奨: [タイミング]
理由: [理由]
```

### 12.3 次アクション提案プロンプト（action）

```markdown
## あなたの役割

見込み客・既存客データを分析し、優先度の高い次アクションを提案します。

## 分析観点

- **滞留日数**: 最終コンタクトからの経過日数
- **ステータス**: 現在のフェーズと典型的な次ステップ
- **緊急度**: 商談のタイミング、競合状況
- **関係性**: これまでのやり取りの質

## 出力フォーマット

### 🔴 優先度A: 今日中
| 顧客 | アクション | 理由 |

### 🟡 優先度B: 今週中
| 顧客 | アクション | 理由 |

### 🟢 優先度C: 来週以降
| 顧客 | アクション | 理由 |
```

---

## 13. 付録: UC追加時の更新手順

新しいユースケースを追加する際のチェックリスト:

1. [ ] §2.1 UC一覧へ追加（UC-ID、実装キー、カテゴリ、優先度）
2. [ ] §2.2 型定義サンプルへ追加（`UseCaseKey` 型に追加）
3. [ ] §2.4 UC詳細（入力・出力・例）の追加
   - MVP（🔴）: 本ドキュメントに詳細記載
   - 非MVP（🟡/🟢）: 「詳細は Phase X で定義」と記載
4. [ ] §4.1 会話モデルへ追加（ワンショット or マルチターン）
5. [ ] §6.3 UC別コンテキストレベルへ追加
6. [ ] §9.4 カテゴリ別パフォーマンス目安の確認・更新
7. [ ] `lib/types/ai-use-cases.ts`（コード側）への反映
8. [ ] §8 エラー/フォールバック - 新UCにフォールバックテンプレートが必要か確認
9. [ ] §7 出力フォーマット - 新UCの出力形式を定義

---

**作成日**: 2025-12-02
**最終更新**: 2025-12-02
**バージョン**: 1.4.0
**ステータス**: ✅ 設計完了
