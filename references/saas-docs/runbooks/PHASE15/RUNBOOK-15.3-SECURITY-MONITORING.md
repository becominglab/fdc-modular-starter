# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ­ã‚°æ©Ÿèƒ½ ãƒ©ãƒ³ãƒ–ãƒƒã‚¯

## æ¦‚è¦

SAã‚¿ãƒ–ã«è¿½åŠ ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ­ã‚°æ©Ÿèƒ½ã®å®Ÿè£…è¨ˆç”»ã€‚
æ‚ªæ„ã®ã‚ã‚‹æ”»æ’ƒã‚„ç•°å¸¸ãªå‹•ä½œã‚’æ¤œçŸ¥ã—ã€ç®¡ç†è€…ã«ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥ã™ã‚‹ã€‚

---

## 1. æ¤œçŸ¥å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ

### 1.1 èªè¨¼é–¢é€£

| ã‚¤ãƒ™ãƒ³ãƒˆ | æ¤œçŸ¥æ¡ä»¶ | é‡è¦åº¦ |
|---------|---------|--------|
| ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ | åŒä¸€IP/ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰5åˆ†é–“ã«10å›ä»¥ä¸Šã®èªè¨¼å¤±æ•— | Critical |
| ä¸æ­£ã‚»ãƒƒã‚·ãƒ§ãƒ³ | ç„¡åŠ¹ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã§ã®ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ | Warning |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¹—ã£å–ã‚Š | ç•°ãªã‚‹IP/UAã‹ã‚‰ã®åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½¿ç”¨ | Critical |
| å¤§é‡ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | 5åˆ†é–“ã«åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®10å›ä»¥ä¸Šã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | Warning |

### 1.2 APIä¸æ­£åˆ©ç”¨

| ã‚¤ãƒ™ãƒ³ãƒˆ | æ¤œçŸ¥æ¡ä»¶ | é‡è¦åº¦ |
|---------|---------|--------|
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é | 1åˆ†é–“ã«100ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¶…é | Warning |
| æ¨©é™æ˜‡æ ¼è©¦è¡Œ | æ¨©é™å¤–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ | Critical |
| SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | å…¥åŠ›å€¤ã«å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º | Critical |
| ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ« | `../` ã‚’å«ã‚€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | Critical |

### 1.3 ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç•°å¸¸

| ã‚¤ãƒ™ãƒ³ãƒˆ | æ¤œçŸ¥æ¡ä»¶ | é‡è¦åº¦ |
|---------|---------|--------|
| å¤§é‡ãƒ‡ãƒ¼ã‚¿å–å¾— | 1æ™‚é–“ã«1000ä»¶ä»¥ä¸Šã®ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾— | Warning |
| ã‚¯ãƒ­ã‚¹ãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ | ä»–ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ | Critical |
| ä¸€æ‹¬å‰Šé™¤ | 5åˆ†é–“ã«50ä»¶ä»¥ä¸Šã®å‰Šé™¤æ“ä½œ | Warning |
| ç®¡ç†è€…æ“ä½œç•°å¸¸ | æ·±å¤œå¸¯(0-5æ™‚)ã®ç®¡ç†è€…æ¨©é™æ“ä½œ | Info |

### 1.4 ã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸

| ã‚¤ãƒ™ãƒ³ãƒˆ | æ¤œçŸ¥æ¡ä»¶ | é‡è¦åº¦ |
|---------|---------|--------|
| ã‚¨ãƒ©ãƒ¼ç‡æ€¥å¢— | 5åˆ†é–“ã§ã‚¨ãƒ©ãƒ¼ç‡5%è¶…é | Critical |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹é…å»¶ | å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹1000msè¶…é | Warning |
| DBæ¥ç¶šéšœå®³ | Supabaseæ¥ç¶šå¤±æ•— | Critical |

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 security_events ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE security_events (
  id SERIAL PRIMARY KEY,
  event_type TEXT NOT NULL,
  severity TEXT NOT NULL CHECK (severity IN ('info', 'warning', 'critical')),
  source_ip INET,
  user_id INTEGER REFERENCES users(id),
  workspace_id INTEGER REFERENCES workspaces(id),
  endpoint TEXT,
  user_agent TEXT,
  details JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  notified_at TIMESTAMPTZ,
  acknowledged_at TIMESTAMPTZ,
  acknowledged_by INTEGER REFERENCES users(id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_security_events_type ON security_events(event_type);
CREATE INDEX idx_security_events_severity ON security_events(severity);
CREATE INDEX idx_security_events_created_at ON security_events(created_at DESC);
CREATE INDEX idx_security_events_source_ip ON security_events(source_ip);
CREATE INDEX idx_security_events_user_id ON security_events(user_id);
CREATE INDEX idx_security_events_unnotified ON security_events(severity)
  WHERE notified_at IS NULL;
```

### 2.2 rate_limit_tracking ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE rate_limit_tracking (
  id SERIAL PRIMARY KEY,
  identifier TEXT NOT NULL, -- IP or user_id
  identifier_type TEXT NOT NULL CHECK (identifier_type IN ('ip', 'user', 'session')),
  endpoint TEXT NOT NULL,
  request_count INTEGER DEFAULT 1,
  first_request_at TIMESTAMPTZ DEFAULT NOW(),
  last_request_at TIMESTAMPTZ DEFAULT NOW(),
  blocked_until TIMESTAMPTZ,

  UNIQUE(identifier, identifier_type, endpoint)
);

-- è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ1æ™‚é–“çµŒéã§å‰Šé™¤ï¼‰
CREATE INDEX idx_rate_limit_cleanup ON rate_limit_tracking(last_request_at);
```

---

## 3. APIè¨­è¨ˆ

### 3.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆAPI

```
GET  /api/admin/security-events     # ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§å–å¾—ï¼ˆSAå°‚ç”¨ï¼‰
POST /api/admin/security-events/:id/acknowledge  # ç¢ºèªæ¸ˆã¿ãƒãƒ¼ã‚¯
GET  /api/admin/security-events/stats  # çµ±è¨ˆæƒ…å ±
```

### 3.2 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

```json
{
  "events": [
    {
      "id": 1,
      "eventType": "brute_force_attempt",
      "severity": "critical",
      "sourceIp": "203.0.113.45",
      "userId": null,
      "endpoint": "/api/auth/login",
      "details": {
        "attemptCount": 15,
        "windowMinutes": 5,
        "targetEmail": "admin@example.com"
      },
      "createdAt": "2025-12-04T10:30:00Z",
      "notifiedAt": "2025-12-04T10:30:05Z",
      "acknowledgedAt": null
    }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "pageSize": 20
  }
}
```

---

## 4. é€šçŸ¥è¨­å®š

### 4.1 ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãƒ«ãƒ¼ãƒ«

| é‡è¦åº¦ | é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚° | é›†ç´„ |
|--------|---------------|------|
| Critical | å³åº§ã«é€ä¿¡ | ãªã—ï¼ˆå€‹åˆ¥é€ä¿¡ï¼‰ |
| Warning | 5åˆ†é–“éš”ã§é›†ç´„ | åŒä¸€ã‚¿ã‚¤ãƒ—ã‚’ã¾ã¨ã‚ã‚‹ |
| Info | æ—¥æ¬¡ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ | 24æ™‚é–“åˆ†ã‚’ã¾ã¨ã‚ã‚‹ |

### 4.2 é€šçŸ¥å…ˆè¨­å®š

```typescript
// ç’°å¢ƒå¤‰æ•°
ALERT_EMAIL=mochizuki@5dmgmt.com  // ãƒ—ãƒ©ã‚¤ãƒãƒª
ALERT_EMAIL_CC=security@5dmgmt.com  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³

// é‡è¦åº¦åˆ¥ã®é€šçŸ¥å…ˆï¼ˆå°†æ¥æ‹¡å¼µï¼‰
CRITICAL_ALERT_EMAIL=urgent@5dmgmt.com
```

### 4.3 ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

**ä»¶åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:**
- Critical: `ğŸš¨ [FDC CRITICAL] ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’æ¤œçŸ¥`
- Warning: `âš ï¸ [FDC WARNING] ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é (3ä»¶)`
- Info: `â„¹ï¸ [FDC] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ`

---

## 5. UIè¨­è¨ˆï¼ˆSAã‚¿ãƒ–ï¼‰

### 5.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–                              [æ›´æ–°] [è¨­å®š]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸš¨ Criticalâ”‚ â”‚ âš ï¸ Warning â”‚ â”‚ â„¹ï¸ Info    â”‚ â”‚ ğŸ“Š ä»Šæ—¥è¨ˆ  â”‚â”‚
â”‚  â”‚     3      â”‚ â”‚    12      â”‚ â”‚    45      â”‚ â”‚    60      â”‚â”‚
â”‚  â”‚ æœªå¯¾å¿œ:2   â”‚ â”‚ æœªå¯¾å¿œ:5   â”‚ â”‚            â”‚ â”‚            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  æœ€è¿‘ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆ                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸš¨ ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ     203.0.113.45    10:30  [å¯¾å¿œ]â”‚â”‚
â”‚  â”‚ âš ï¸ ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é          user123         10:25  [å¯¾å¿œ]â”‚â”‚
â”‚  â”‚ âš ï¸ æ¨©é™æ˜‡æ ¼è©¦è¡Œ            192.168.1.50    10:20  [âœ“]  â”‚â”‚
â”‚  â”‚ â„¹ï¸ æ·±å¤œç®¡ç†è€…æ“ä½œ          admin@test.com  03:15        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  æ”»æ’ƒå…ƒIP Top5 (24h)           å¤±æ•—èªè¨¼ Top5 (24h)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 203.0.113.45   45å› â”‚       â”‚ unknown@test.com  23å›  â”‚  â”‚
â”‚  â”‚ 198.51.100.22  23å› â”‚       â”‚ admin@fake.com    15å›  â”‚  â”‚
â”‚  â”‚ ...                 â”‚       â”‚ ...                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°                              [Ã—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ã‚¿ã‚¤ãƒ—: ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ                               â”‚
â”‚  é‡è¦åº¦: ğŸš¨ Critical                                        â”‚
â”‚  ç™ºç”Ÿæ—¥æ™‚: 2025-12-04 10:30:00 JST                          â”‚
â”‚                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  é€ä¿¡å…ƒIP: 203.0.113.45                                     â”‚
â”‚  å¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: /api/auth/login                        â”‚
â”‚  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)...   â”‚
â”‚                                                              â”‚
â”‚  è©³ç´°æƒ…å ±:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ {                                                     â”‚   â”‚
â”‚  â”‚   "attemptCount": 15,                                â”‚   â”‚
â”‚  â”‚   "windowMinutes": 5,                                â”‚   â”‚
â”‚  â”‚   "targetEmail": "admin@example.com",                â”‚   â”‚
â”‚  â”‚   "failedPasswords": ["***", "***", "***"]           â”‚   â”‚
â”‚  â”‚ }                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  å¯¾å¿œå±¥æ­´:                                                   â”‚
â”‚  - 2025-12-04 10:30:05 ãƒ¡ãƒ¼ãƒ«é€šçŸ¥é€ä¿¡                       â”‚
â”‚  - æœªå¯¾å¿œ                                                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç¢ºèªæ¸ˆã¿   â”‚ â”‚ IPã‚’ãƒ–ãƒ­ãƒƒã‚¯     â”‚ â”‚ èª¤æ¤œçŸ¥ã¨ã—ã¦é™¤å¤–â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ session/route.ts      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–çµ±åˆæ¸ˆã¿
â”‚   â”‚   â”œâ”€â”€ callback/route.ts     # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–çµ±åˆæ¸ˆã¿
â”‚   â”‚   â””â”€â”€ logout/route.ts       # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–çµ±åˆæ¸ˆã¿
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ security-events/
â”‚           â”œâ”€â”€ route.ts          # GET: ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§, PATCH: ä¸€æ‹¬ç¢ºèª
â”‚           â”œâ”€â”€ [id]/
â”‚           â”‚   â””â”€â”€ route.ts      # GET: è©³ç´°, PATCH: ç¢ºèªæ¸ˆã¿ãƒãƒ¼ã‚¯
â”‚           â””â”€â”€ stats/
â”‚               â””â”€â”€ route.ts      # GET: çµ±è¨ˆæƒ…å ±
â”œâ”€â”€ _components/admin/
â”‚   â””â”€â”€ sa-dashboard/
â”‚       â”œâ”€â”€ index.ts              # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”‚       â””â”€â”€ SecurityMonitor.tsx   # ç›£è¦–UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
lib/
â””â”€â”€ server/
    â”œâ”€â”€ security-monitor.ts       # æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
    â”œâ”€â”€ security-middleware.ts    # APIãƒ©ãƒƒãƒ‘ãƒ¼ãƒ»è‡ªå‹•ç›£è¦–
    â””â”€â”€ security-notifier.ts      # ãƒ¡ãƒ¼ãƒ«é€šçŸ¥é€ä¿¡
migrations/
â””â”€â”€ 026-security-events.sql       # DBã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»é–¢æ•°ãƒ»RLSï¼‰
```

---

## 7. å®Ÿè£…æ‰‹é †

### Phase 1: åŸºç›¤æ•´å‚™ âœ… å®Œäº†
1. [x] `security_events` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ `026-security-events.sql`ï¼‰
2. [x] `rate_limit_tracking` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
3. [x] `ip_blocklist` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
4. [x] åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²é–¢æ•°

### Phase 2: æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ âœ… å®Œäº†
5. [x] ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ¤œçŸ¥ï¼ˆ`trackAuthFailure`ï¼‰
6. [x] ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ¤œçŸ¥ï¼ˆ`checkRateLimit` - ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå®Ÿè£…ï¼‰
7. [x] æ¨©é™æ˜‡æ ¼è©¦è¡Œæ¤œçŸ¥ï¼ˆ`recordPrivilegeEscalation`ï¼‰
8. [x] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œçŸ¥ï¼ˆ`detectSqlInjection`ï¼‰
9. [x] ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ¤œçŸ¥ï¼ˆ`detectPathTraversal`ï¼‰
10. [x] ä¸å¯©ãªUserAgentæ¤œçŸ¥ï¼ˆ`detectSuspiciousUserAgent`ï¼‰
11. [x] ã‚¯ãƒ­ã‚¹ãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥ï¼ˆ`recordCrossTenantAccess`ï¼‰

### Phase 3: APIçµ±åˆ âœ… å®Œäº†
12. [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä½œæˆï¼ˆ`lib/server/security-middleware.ts`ï¼‰
13. [x] `/api/auth/session` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»å…¥åŠ›æ¤œè¨¼
14. [x] `/api/auth/callback` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»å…¥åŠ›æ¤œè¨¼ãƒ»èªè¨¼å¤±æ•—è¿½è·¡
15. [x] `/api/auth/logout` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™
16. [x] `/api/admin/security-events` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»æ¨©é™æ˜‡æ ¼æ¤œçŸ¥
17. [x] `/api/admin/security-events/[id]` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»æ¨©é™æ˜‡æ ¼æ¤œçŸ¥
18. [x] `/api/contact` - å…¥åŠ›æ¤œè¨¼ï¼ˆSQLi/ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ¤œçŸ¥ï¼‰
19. [x] `/api/google/auth` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™
20. [x] `/api/google/sync` - å…¥åŠ›æ¤œè¨¼
21. [x] `/api/ai/chat` - å…¥åŠ›æ¤œè¨¼ï¼ˆSQLiæ¤œçŸ¥ï¼‰
22. [x] `/api/invitations` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»å…¥åŠ›æ¤œè¨¼
23. [x] `/api/admin/users` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»å…¥åŠ›æ¤œè¨¼
24. [x] `/api/admin/tenants` - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»å…¥åŠ›æ¤œè¨¼

### Phase 4: é€šçŸ¥æ©Ÿèƒ½ âœ… å®Œäº†
25. [x] Criticalå³æ™‚é€šçŸ¥ï¼ˆ`sendSecurityAlertEmail`ï¼‰
26. [x] æ—¥æ¬¡ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆï¼ˆ`sendDailySecurityDigest`ï¼‰
27. [ ] Warningé›†ç´„é€šçŸ¥ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### Phase 4.5: è¿½åŠ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ âœ… å®Œäº†
28. [x] CSRFä¿è­·ï¼ˆ`lib/server/csrf.ts` - Double Submit Cookieæ–¹å¼ï¼‰
29. [x] ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¹—ã£å–ã‚Šæ¤œçŸ¥ï¼ˆIP/UAå¤‰æ›´æ¤œçŸ¥ï¼‰
30. [x] ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆï¼ˆ`migrations/027-session-fingerprint.sql`ï¼‰

### Phase 5: UIå®Ÿè£… âœ… å®Œäº†
31. [x] SAã‚¿ãƒ–ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
32. [x] ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ä»˜ãï¼‰
33. [x] çµ±è¨ˆã‚«ãƒ¼ãƒ‰ï¼ˆCritical/Warning/Info/ä»Šæ—¥è¨ˆï¼‰
34. [x] ç¢ºèªæ¸ˆã¿ãƒãƒ¼ã‚¯æ©Ÿèƒ½ï¼ˆå€‹åˆ¥ãƒ»ä¸€æ‹¬ï¼‰
35. [x] CSSã‚’ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼ˆCSSå¤‰æ•°ï¼‰ã«çµ±ä¸€

### Phase 6: ãƒ†ã‚¹ãƒˆãƒ»é‹ç”¨
36. [ ] E2Eãƒ†ã‚¹ãƒˆ
37. [ ] è² è·ãƒ†ã‚¹ãƒˆï¼ˆèª¤æ¤œçŸ¥ç¢ºèªï¼‰
38. [ ] é‹ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

---

## 8. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº

### 8.1 åˆ©ç”¨ã™ã‚‹æ—¢å­˜æ©Ÿèƒ½

| æ©Ÿèƒ½ | ãƒ•ã‚¡ã‚¤ãƒ« | åˆ©ç”¨æ–¹æ³• |
|------|---------|---------|
| ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ | `lib/server/alerting.ts` | `sendManualAlert()` |
| ãƒ­ã‚°å‡ºåŠ› | `lib/server/logger.ts` | `apiLogger.warn/error()` |
| èªè¨¼ | `lib/server/auth.ts` | `getSession()` |
| ç›£æŸ»ãƒ­ã‚° | `audit_logs` ãƒ†ãƒ¼ãƒ–ãƒ« | é–¢é€£ä»˜ã‘ |

### 8.2 ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢çµ±åˆ

```typescript
// middleware.ts ã«è¿½åŠ 
import { recordSecurityEvent } from '@/lib/server/security-monitor';

// å„APIãƒ«ãƒ¼ãƒˆã§ä½¿ç”¨
export async function POST(request: NextRequest) {
  // èªè¨¼å¤±æ•—æ™‚
  await recordSecurityEvent({
    eventType: 'auth_failure',
    severity: 'info',
    sourceIp: request.ip,
    endpoint: '/api/auth/login',
    details: { reason: 'invalid_credentials' }
  });
}
```

---

## 9. é‹ç”¨ã‚¬ã‚¤ãƒ‰

### 9.1 ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œãƒ•ãƒ­ãƒ¼

```
Criticalæ¤œçŸ¥
    â†“
ãƒ¡ãƒ¼ãƒ«å—ä¿¡
    â†“
SAãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è©³ç´°ç¢ºèª
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¾å¿œåˆ¤æ–­                             â”‚
â”‚ â”œâ”€ æ”»æ’ƒç¢ºå®š â†’ IPãƒ–ãƒ­ãƒƒã‚¯/å ±å‘Š        â”‚
â”‚ â”œâ”€ èª¤æ¤œçŸ¥   â†’ é™¤å¤–è¨­å®š               â”‚
â”‚ â””â”€ è¦èª¿æŸ»   â†’ ãƒ­ã‚°è©³ç´°åˆ†æ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç¢ºèªæ¸ˆã¿ãƒãƒ¼ã‚¯
    â†“
å¿…è¦ã«å¿œã˜ã¦ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Š
```

### 9.2 é–¾å€¤ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

é‹ç”¨é–‹å§‹å¾Œã€èª¤æ¤œçŸ¥ãŒå¤šã„å ´åˆã¯é–¾å€¤ã‚’èª¿æ•´:

```typescript
// lib/server/security-monitor.ts
export const SECURITY_THRESHOLDS = {
  bruteForce: {
    attempts: 10,      // 10å› â†’ 15å›ã«èª¿æ•´å¯èƒ½
    windowMinutes: 5,
  },
  rateLimit: {
    requestsPerMinute: 100,
    burstLimit: 20,
  },
  // ...
};
```

---

## 10. å°†æ¥æ‹¡å¼µ

- [ ] Slack/Discordé€šçŸ¥å¯¾å¿œ
- [ ] IPãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆè‡ªå‹•æ›´æ–°
- [ ] æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ç•°å¸¸æ¤œçŸ¥
- [ ] SOCé€£æºï¼ˆWebhookï¼‰
- [ ] GeoIPæƒ…å ±ã®ä»˜ä¸
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆWebSocketï¼‰

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2025-12-04 | 1.0 | åˆç‰ˆä½œæˆ |
| 2025-12-04 | 2.0 | Phase 1-5 å®Ÿè£…å®Œäº†ã€APIçµ±åˆã€UIå®Œæˆ |
| 2025-12-04 | 2.1 | CSRFä¿è­·ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¹—ã£å–ã‚Šæ¤œçŸ¥è¿½åŠ ã€å…¨APIã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æ‹¡å¤§é©ç”¨ |
| 2025-12-05 | 2.2 | å®Ÿè£…çŠ¶æ³ç¢ºèªã€å…¨Phaseå®Œäº†ç¢ºèª |

---

## å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆ2025-12-05 ç¢ºèªæ¸ˆã¿ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² | ç¢ºèªçŠ¶æ³ |
|---------|------|----------|
| `lib/server/security-monitor.ts` | æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ² | âœ… 699è¡Œ |
| `lib/server/security-middleware.ts` | APIãƒ©ãƒƒãƒ‘ãƒ¼ãƒ»è‡ªå‹•ç›£è¦– | âœ… |
| `lib/server/security-notifier.ts` | ãƒ¡ãƒ¼ãƒ«é€šçŸ¥é€ä¿¡ | âœ… |
| `migrations/026-security-events.sql` | DBã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»é–¢æ•°ãƒ»RLSï¼‰ | âœ… 349è¡Œ |
| `migrations/027-session-fingerprint.sql` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ | âœ… |
