# Phase 11：Action Map レイヤー実装（戦術・指示レイヤー）v11.2

**Version:** 11.2
**Status:** Ready for Implementation
**Claude Code 用ランブック**
**Last Updated:** 2025-11-29

---

## 0. 前提（必ず最初に読むファイル）

作業開始前に、必ず以下を読み込んでから処理を始めること：

**必読ドキュメント:**
- **DOCS/FDC-GRAND-GUIDE.md**
- **DOCS/HOW-TO-DEVELOP.md**
- **DOCS/PHASE9-ENCRYPTION-AND-API-RUNBOOK.md**（Phase 9完了が前提）
- **DOCS/PHASE10-TODO-ELASTIC-RUNBOOK.md**（Phase 10完了が前提）

### Phase 9 & Phase 10 完了確認（Phase 11 開始の前提条件）：

Phase 11 を開始する前に、以下が完了していることを確認すること：

**Phase 9 完了確認:** ✅ 全項目完了
- [x] JWT認証が動作している（dev / 本番）
- [x] 暗号化基盤が整備されている（Encryption Allocation Table確定）
- [x] 既存API（Phase 8まで）のE2Eテストが全てpass
- [x] Performance Specification v1.0 が確定している
- [x] workspace_data 250KB容量制限ポリシーが確定している

**Phase 10 完了確認:** ✅ 全項目完了（2025-11-28）
- [x] **4象限ボード（TODO拡張）が動作している**
  - 日本語ラベル併記（♠ 緊急かつ重要 / ♥ 重要なこと / ♦ 緊急なだけ / ♣ 未来創造）
  - 実装: `app/_components/todo/TodoBoard.tsx`
- [x] **Googleカレンダー連携が動作している**
  - 実装: `lib/google/calendar-client.ts`, `lib/google/tasks-client.ts`
- [x] **Elastic Habits（松竹梅）が実装されている**
  - ストリークカウンター: `calculateStreak()`, `getTaskBadges()`
  - 実装: `app/_components/todo/ElasticHabitsPanel.tsx`
- [x] **梅習慣マスタが実装されている**
  - 5分固定習慣の CRUD
  - 実装: `app/_components/todo/UmeHabitManager.tsx`
- [x] **TimeAllocationBar が実装されている**
  - 5色バーによる時間有効活用度可視化
  - 実装: `app/_components/todo/TimeAllocationBar.tsx`
- [x] **アーカイブ機能が実装されている**
  - 週次（日曜）: `archiveWeeklyLogs()`
  - 月次（月初）: `archiveMonthlyLogs()`
- [x] **Phase 10のE2Eテストが全てpass**
- [x] **workspace_data が225KB以下**（実測 P95: 751 bytes）
- [x] **Phase 10のパフォーマンス基準を満たしている**
  - 4象限ボード表示: P95 < 1.2秒
  - TODO作成・編集: P95 < 800ms

**✅ Phase 9 & 10 完了確認済み - Phase 11 開始可能**

---

### 特に守るべきルール：

- **依存方向**：`js/core → js/tabs → js/main.ts` の一方向のみ。逆依存は禁止。
- **localStorage**：必ず `storage.js` 経由で扱う。直接 `localStorage.*` は使用しない。
- **DOM操作**：`DOM.get()` / `updateUI()` 等の既存ユーティリティ経由で行う。`document.*` 直呼びはしない。
- **既存 UI / SVG**：破壊的変更は禁止。レイアウトは維持し、必要最小限の追加・拡張のみ行う。

### フェーズ進行：

- Phase 11 は **11-x サブフェーズ単位**で進行する。
- 各サブフェーズごとに**レポートして一度停止し、人間の承認なしに次へ進まない**。

---

## 1. Phase 11 で実現する世界（全体ゴール）

### 1-1. 機能ゴール（上司視点）

Workspace 内の「上司ロール（isManager）」のユーザーは、部下に対して **Action Map（戦術計画）** を作成できる。

Action Map は以下の構造を持つ：

- **上位ゴール**（例：Q1 新規案件 10件獲得）
- **アクションライン**（例：リード獲得 / 商談化 / 既存深堀り）
- **各アクションライン配下の「Action Item（具体タスク）」群**
  - 各 Action Item に「担当者（部下）」「期限」「優先度」「ステータス」を設定
  - Action Item は **TODO タブの Task と 1:N で紐づく**
    - Action Item → 複数の TODO ブロックを紐付け可能（例：毎週30分の実行ブロックなど）
    - TODO 側で完了・延期すると、Action Item の進捗に反映される

### 1-2. 機能ゴール（部下視点）

部下は、自分にアサインされた Action Map を：

- **「マップ（ツリー / ボード）」として俯瞰**
- **「TODO タブ」として日々の時間ブロックで実行**

自分の TODO を見れば：

- ただの「作業リスト」ではなく
- **「どの Action Item のため」「どのゴールにつながっているか」が分かる**

### 1-3. 進捗管理

Action Item は次の情報を持つ：

- **status**: `not_started` / `in_progress` / `blocked` / `done`
- **紐づく TODO Task 群の進捗率（完了率）**
- **期日までの残日数**

**ゴール／アクションライン単位で、ロールアップされた進捗率を可視化**する。

---

## 2. ドメイン設計（core レイヤーの拡張）

### 2-1. Action Map の概念

Workspace 内で：

- **1 Workspace に複数の Action Map** を持てる
- Action Map は「上司が作る"キャンペーン"」のようなもの

#### 型イメージ（`core/action-map.ts`）

```typescript
export type ActionMapId = string;
export type ActionItemId = string;

export type ActionMap = {
  id: ActionMapId;
  title: string;             // 例: 「Q1 新規リード 10件獲得プラン」
  description?: string;
  ownerUserId: string;       // 上司（作成者）
  targetPeriodStart?: string; // ISO 日付
  targetPeriodEnd?: string;
  createdAt: string;
  updatedAt: string;
  isArchived?: boolean;

  // 進捗集計（配下 Action Item から自動計算）
  progressRate?: number;     // 0〜100
};

export type ActionItem = {
  id: ActionItemId;
  actionMapId: ActionMapId;

  parentItemId?: ActionItemId | null;  // ツリー構造用。小さな Action を親の配下にぶら下げる
  title: string;
  description?: string;

  assigneeUserId: string;             // 部下
  dueDate?: string;                   // ISO 日付
  priority?: 'low' | 'medium' | 'high';

  status: 'not_started' | 'in_progress' | 'blocked' | 'done';

  // TODO タスクとの連携
  linkedTaskIds?: string[];           // js/core/state.ts の Task の id を参照
  progressRate?: number;              // 0〜100, linkedTask の完了率から自動更新

  createdAt: string;
  updatedAt: string;
};
```

### 2-2. 保存先と容量分析

**保存場所**:
- **既存の `workspace_data` JSON 配下**に `actionMaps` / `actionItems` として追加
- **Phase 10 の容量制限 250KB** の中で収まる前提で設計
- 軽量化のため、大量の Action Map/Item は想定しない（1 Workspace あたり Action Map 最大 50件程度を目安）

**容量計算（理論値）**:
- ActionMap: 50件想定 × 400 bytes/件 = 20 KB
- ActionItem: 200件想定 × 300 bytes/件 = 60 KB
- **Phase 11 追加合計**: 80 KB

**現状分析**（Phase 10完了時点 - 2025-11-28 実測）:
- `workspace_data` **実測 P95: 751 bytes**（目標200KB以下を大幅クリア）
- Phase 11 追加後: 751 bytes + 80 KB = **約81 KB** → **250KB制限内で十分余裕あり**

> **注記**: 当初の推定値（225KB）は最大想定値であり、実測値は大幅に小さい。
> 容量超過リスクは事実上解消済み。アーカイブ機能は将来的な安全策として実装する。

**Phase 11-0 での確認事項**（2025-11-29 更新）:
- [x] 現在の workspace_data サイズを実測（Phase 10 完了時点）→ **751 bytes**
- [x] Phase 10 の Task 拡張分を含めた合計サイズを確認 → **問題なし**
- [x] **容量超過リスク**: **解消済み**（実測値ベースで十分余裕あり）
- [ ] アーカイブ機能は将来的な安全策として Phase 11-5 以降で実装検討

### 2-3. 容量・ライフサイクルポリシー（Phase 11 正式仕様）

**workspace_data JSON の容量目標**:
- **通常運用時**: 200KB以下（推奨）
- **ハード上限**: 250KB（絶対制約、Phase 10から継承）

**アーカイブポリシー（Phase 11）**:
- **ActionMap**: 90日間更新がないものは `isArchived: true` に変更
- **アーカイブ時の動作**:
  - アーカイブされた ActionMap はデフォルト非表示
  - 「アーカイブ表示」フィルタから表示・復元可能
  - 配下の ActionItem も連動してアーカイブ（`parentActionMapArchived: true` フラグ）
  - アーカイブデータは将来的に workspace_data から分離（Phase 11-7で検討）

**データ最適化（上限値・Phase 11 必須実装）**:

| データ種別 | フィールド | 上限値 | 超過時の動作 |
|-----------|-----------|--------|-------------|
| ActionItem | linkedTaskIds | 20件 | UI警告「1つのAction Itemに紐づけられるTODOは最大20件までです」、保存不可 |
| ActionItem | description | 500文字 | UI警告「説明は500文字以内にしてください」、保存不可 |
| ActionMap | title | 100文字 | UI警告、保存不可 |
| ActionMap | description | 1000文字 | UI警告、保存不可 |

**Phase 10 のデータ最適化も併せて適用**:
- Task.subTasks: 10件
- Task.title: 200文字
- Task.description: 500文字

**将来的な選択肢（Phase 13以降で検討）**:
以下は現時点では実装しないが、容量問題が深刻化した場合の選択肢として残す：
- **案①**: 250KB → 300KB への制限緩和（技術的リスク要検証）
- **案②**: IndexedDB への移行（ブラウザストレージ拡張）
- **案③**: Workspace別ストレージ分離（複数JSONファイル化）
- **案④**: サーバーサイドDB（Postgres等）への移行

**Phase 11-0 での判断**:
- 250KB上限は維持（ハード制約として残す）
- 必須対策: ① アーカイブ機能、② データ最適化（上限値を仕様化）
- ③④は将来的な選択肢として文書化のみ

この方針は **Phase 12（OKR）でも継承**される。

---

## 3. UI / UX 設計（タブ構成）

### 3-1. タブ構成

- **既存タブ**：Dash / Leads / Clients / Reports / TODO / Settings...
- **新たに Action Map タブを追加**（`js/tabs/action-map.ts` 想定）

### 3-2. 上司の画面（Action Map タブ）

#### ビュー切り替え機能（UX強化 v11.1）

Action Map タブでは、以下の**2つのビューを切り替え可能**とする：

1. **ツリービュー**（デフォルト）: 階層構造で全体を俯瞰
2. **カンバンボードビュー**: ステータス別（未着手/進行中/ブロック/完了）でカード表示

```
┌────────────────────────────────────────────────────┐
│ Action Map タブ          [🌲 ツリー] [📋 カンバン]  │
└────────────────────────────────────────────────────┘
```

#### レイアウトモック：ツリービュー（ASCII Art）

```
┌─────────────────────────────────────────────────────────────────┐
│ Action Map タブ                               [+ 新規Map作成]  │
├───────────────┬─────────────────────────────────────────────────┤
│ Action Map    │ Action Map 詳細: Q1 新規リード 10件獲得プラン   │
│               │                                                 │
│ Q1 新規リード │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ 10件獲得      │ 📊 全体進捗: ████████░░ 75%                   │
│ 75% ✓         │ 期間: 2025-01-01 ~ 2025-03-31                  │
│ 2025-01〜03   │ オーナー: 山田太郎（Manager）                  │
│               │                                                 │
│ 営業力強化    │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│ 40% ⚠         │ Action Items (8)                   [+ 追加]    │
│ 2025-01〜03   │                                                 │
│               │ ┌─ 📋 リード獲得（親Item）                     │
│ コスト削減    │ │   ├─ テレアポリスト作成                      │
│ 20% ✗         │ │   │   👤 佐藤A  📅 01/15  ✅ 完了            │
│ 2025-02〜03   │ │   │   ⏰ 残り: - (完了)                      │
│               │ │   │   📝 TODO: 2件完了 / 2件  進捗: 100%    │
│ [+ 作成]      │ │   │   [TODO作成] [TODO紐付け] [編集] [削除]  │
│               │ │   │                                           │
│               │ │   ├─ 毎日30分テレアポ実施                    │
│               │ │   │   👤 佐藤A  📅 01/31  🔄 進行中          │
│               │ │   │   ⏰ 残り: 🟡 5日 (期限注意)             │
│               │ │   │   📝 TODO: 10件完了 / 20件  進捗: 50%    │
│               │ │   │   [TODO作成] [TODO紐付け] [編集]         │
│               │ │   │                                           │
│               │ │   └─ リード品質チェック                      │
│               │ │       👤 鈴木B  📅 01/20  ⏸ 未着手          │
│               │ │       ⏰ 残り: 🔴 期限切れ (-3日)            │
│               │ │       📝 TODO: 0件  進捗: 0%                 │
│               │ │       [TODO作成] [TODO紐付け] [編集]         │
│               │ │                                               │
│               │ ├─ 📋 商談化（親Item）                         │
│               │ │   ├─ 商談資料作成                            │
│               │ │   │   👤 田中C  📅 02/05  🔄 進行中          │
│               │ │   │   ⏰ 残り: 🟢 14日                       │
│               │ │   ├─ 初回商談実施                            │
│               │ │   │   👤 佐藤A  📅 02/15  ⏸ 未着手          │
│               │ │   └─ フォローアップ                          │
│               │ │       👤 鈴木B  📅 02/20  ⏸ 未着手          │
│               │ │                                               │
│               │ └─ 📋 既存深堀り（親Item）                     │
│               │     ├─ アップセル提案                          │
│               │     │   👤 田中C  📅 03/10  ⏸ 未着手          │
│               │     └─ クロスセル提案                          │
│               │         👤 鈴木B  📅 03/20  ⏸ 未着手          │
│               │                                                 │
│               │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│               │ 選択中 Action Item 詳細                         │
│               │ （下部に表示・編集フォーム展開）                │
└───────────────┴─────────────────────────────────────────────────┘
```

#### レイアウトモック：カンバンボードビュー（UX強化 v11.1）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Action Map: Q1 新規リード 10件獲得プラン    [🌲 ツリー] [📋 カンバン]       │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────┤
│ ⏸ 未着手 (3)    │ 🔄 進行中 (2)    │ 🚫 ブロック (1)  │ ✅ 完了 (2)          │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────┤
│ ┌─────────────┐ │ ┌─────────────┐ │ ┌─────────────┐ │ ┌─────────────────┐ │
│ │初回商談実施 │ │ │30分テレアポ │ │ │品質チェック │ │ │テレアポリスト   │ │
│ │👤 佐藤A     │ │ │👤 佐藤A     │ │ │👤 鈴木B     │ │ │👤 佐藤A         │ │
│ │📅 02/15    │ │ │📅 01/31    │ │ │📅 01/20    │ │ │📅 01/15 ✓      │ │
│ │⏰ 🟢 20日   │ │ │⏰ 🟡 5日    │ │ │⏰ 🔴 -3日   │ │ │進捗: 100%       │ │
│ │進捗: 0%    │ │ │進捗: 50%    │ │ │進捗: 0%    │ │ └─────────────────┘ │
│ └─────────────┘ │ └─────────────┘ │ └─────────────┘ │                     │
│                 │                 │                 │ ┌─────────────────┐ │
│ ┌─────────────┐ │ ┌─────────────┐ │                 │ │商談資料完成     │ │
│ │フォローアップ│ │ │商談資料作成 │ │                 │ │👤 田中C         │ │
│ │👤 鈴木B     │ │ │👤 田中C     │ │                 │ │📅 02/01 ✓      │ │
│ │📅 02/20    │ │ │📅 02/05    │ │                 │ │進捗: 100%       │ │
│ │⏰ 🟢 25日   │ │ │⏰ 🟢 10日   │ │                 │ └─────────────────┘ │
│ │進捗: 0%    │ │ │進捗: 80%    │ │                 │                     │
│ └─────────────┘ │ └─────────────┘ │                 │                     │
│                 │                 │                 │                     │
│ ┌─────────────┐ │                 │                 │                     │
│ │アップセル   │ │                 │                 │                     │
│ │👤 田中C     │ │                 │                 │                     │
│ │📅 03/10    │ │                 │                 │                     │
│ │⏰ 🟢 38日   │ │                 │                 │                     │
│ │進捗: 0%    │ │                 │                 │                     │
│ └─────────────┘ │                 │                 │                     │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────┘

💡 カードはドラッグ&ドロップでステータス変更可能
```

#### 残日数の視覚的警告（UX強化 v11.1）

期限までの残日数に応じて、以下の色分けを自動適用：

| 残日数 | 表示 | 色 | 意味 |
|--------|------|-----|------|
| 8日以上 | 🟢 | 緑 | 余裕あり |
| 4〜7日 | 🟡 | 黄 | 期限注意 |
| 1〜3日 | 🟠 | オレンジ | 要対応 |
| 0日以下 | 🔴 | 赤 | 期限切れ |

#### ドラッグ&ドロップでアサイン変更（UX強化 v11.1）

- **カンバンボードビュー**では、カードをドラッグしてステータス変更可能
- **ツリービュー**では、Action Item をドラッグして担当者変更可能（メンバーリストにドロップ）

#### フォーカスモード（UX強化 v11.1）

選択した Action Item だけを大きく表示し、TODO編集ができるモード：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 🎯 フォーカスモード: 毎日30分テレアポ実施               [✕ 閉じる]          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 📊 進捗: ███████████░░░░░░░░░ 50%  (10/20 TODO完了)                        │
│                                                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                             │
│ 👤 担当: 佐藤A                                                              │
│ 📅 期限: 2025-01-31 (残り 🟡 5日)                                          │
│ 🏷️ 優先度: High                                                            │
│ 📝 説明: 1日30分のテレアポを継続し、リード獲得につなげる                    │
│                                                                             │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                             │
│ 📋 紐づくTODO一覧                                        [+ TODO作成]       │
│                                                                             │
│ ┌────────────────────────────────────────────────────────────────────────┐ │
│ │ ✅ 01/21 09:00-09:30  テレアポ実施 [♠ 緊急かつ重要]                    │ │
│ │ ✅ 01/22 09:00-09:30  テレアポ実施 [♠ 緊急かつ重要]                    │ │
│ │ ✅ 01/23 09:00-09:30  テレアポ実施 [♠ 緊急かつ重要]                    │ │
│ │ ...                                                                    │ │
│ │ ⬜ 01/29 09:00-09:30  テレアポ実施 [♠ 緊急かつ重要]                    │ │
│ │ ⬜ 01/30 09:00-09:30  テレアポ実施 [♠ 緊急かつ重要]                    │ │
│ │ ⬜ 01/31 09:00-09:30  テレアポ実施 [♠ 緊急かつ重要]                    │ │
│ └────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ [編集] [TODO一括作成] [既存TODO紐付け]                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 予定vs実績のガントチャート風表示（UX強化 v11.1 オプション）

Action Map 詳細に、期間を通じたペース配分が見える化されるガントチャート風表示を追加：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 📅 タイムライン表示                                                          │
├──────────────────────┬──────────────────────────────────────────────────────┤
│ Action Item          │ 1月                    2月                    3月   │
│                      │ ──────────────────────────────────────────────────  │
├──────────────────────┼──────────────────────────────────────────────────────┤
│ テレアポリスト作成   │ ████████ (完了)                                      │
│ 30分テレアポ実施     │ ████████████████████░░░░░░░░ (50%)                   │
│ 品質チェック         │     ░░░░ (遅延)                                      │
│ 商談資料作成         │           ████████████████░░░░ (80%)                 │
│ 初回商談実施         │                     ░░░░░░░░░░░░                     │
│ フォローアップ       │                           ░░░░░░░░░░░░               │
└──────────────────────┴──────────────────────────────────────────────────────┘

凡例: ████ = 完了  ░░░░ = 予定  (赤) = 遅延
```

#### レイアウト詳細

- **左カラム**：Action Map 一覧（List）
  - タイトル、対象期間、進捗バー、ステータス（進行中 / アーカイブ）
  - クリックで右側に詳細を表示

- **右メイン**：選択中の Action Map 詳細
  - **上部**：ゴール概要
    - タイトル、期間、オーナー
    - 全体進捗バー（配下 Action Item の progressRate 平均）
  - **中央**：Action Item ツリー/カンバン（切り替え可能）
    - 各Item に: アイコン、タイトル、担当者、期限、ステータス、進捗、TODO件数
    - **残日数の視覚的警告**（🟢🟡🟠🔴）
    - ボタン: TODO作成、TODO紐付け、編集、削除
  - **下部**：選択中 Action Item の詳細／TODO 連携情報
    - 編集フォーム展開（インライン編集）
    - フォーカスモードへの切り替えボタン

#### 主要操作

- Action Map の**新規作成／編集／アーカイブ**
- Action Item の**追加／編集／削除**
- Action Item の**担当者選択**（Workspace メンバーから）
  - **ドラッグ&ドロップでアサイン変更**（UX強化）
- Action Item に**紐づく TODO の作成／既存 TODO の紐付け**

### 3-3. 部下の画面（Action Map / TODO 両側）

- **Action Map タブ**では：
  - 自分が `assignee` の Action Item だけをフィルタ表示する「**マイアクション**」ビュー
- **TODO タブ**では：
  - 個々の Task カードに「**Action Item バッジ**」を表示
    - 例：`[AM] Q1リード獲得/テレアポ 30分` のようなラベル
  - Task 詳細に「**紐づく Action Item へのリンク**」を追加

---

## 4. 振る舞い・フロー（TODO との連携）

### 4-1. Action Item → TODO Task 生成フロー

1. 上司が Action Item を作成（タイトル・担当者・期限など）
2. **「TODO ブロックを作成」ボタン**を押すと、モーダルで：
   - `suit`（♠/♥/♦/♣）の候補（多くは♠ or ♥）
     - **日本語ラベルで選択**（♠ 緊急かつ重要 / ♥ 重要なこと / ♦ 緊急なだけ / ♣ 未来創造）
   - `startAt` / `durationMinutes`
   - `subTasks`（この Action Item を実現する具体作業）
   を入力
3. 保存すると：
   - **Task を新規作成**（Phase 10 の Task 型準拠）
   - `ActionItem.linkedTaskIds` に `Task.id` を push

### 4-2. 既存 TODO Task → Action Item に紐付け

- TODO タブから：
  - Task 詳細内に「**Action Item に紐付け**」ボタン
  - ダイアログで、現在の Workspace 内の Action Item リストから選択
- 選択したら `ActionItem.linkedTaskIds` に `Task.id` を追加

### 4-3. 進捗同期（実装詳細）

#### 更新タイミング

**即時更新**（イベントドリブン）:
- **TODO Task の status が変更されたとき**
  → 紐づく Action Item の progressRate を即座に再計算
- **Action Item の status が手動変更されたとき**
  → Action Map の progressRate を即座に再計算

#### 実装方法

```typescript
// TODO タブ（lib/hooks/useTaskViewModel.ts）で Task 完了時
function onTaskStatusChange(task: Task): void {
  // 既存の処理...

  // Phase 11 追加: 紐づく Action Item を更新
  const relatedActionItems = findActionItemsByTaskId(task.id);

  relatedActionItems.forEach(item => {
    const updated = recomputeActionItemProgress(item, getAllTasks());
    updateActionItem(updated);
  });

  // Action Map の進捗も再計算
  relatedActionItems.forEach(item => {
    const map = getActionMapById(item.actionMapId);
    if (map) {
      const updatedMap = recomputeActionMapProgress(map, getAllActionItems());
      updateActionMap(updatedMap);
    }
  });

  // UI 更新
  refreshActionMapTab();
}

// Action Item の進捗再計算
function recomputeActionItemProgress(actionItem: ActionItem, tasks: Task[]): ActionItem {
  const linked = tasks.filter(t => actionItem.linkedTaskIds?.includes(t.id));

  if (linked.length === 0) {
    return { ...actionItem, progressRate: 0 };
  }

  const doneCount = linked.filter(t => t.status === 'done').length; // Task に status フィールド必須
  const rate = Math.round((doneCount / linked.length) * 100);

  let status: ActionItem['status'] = actionItem.status;
  if (rate === 100) status = 'done';
  else if (rate > 0) status = 'in_progress';
  else status = 'not_started';

  return {
    ...actionItem,
    progressRate: rate,
    status,
    updatedAt: new Date().toISOString(),
  };
}

// Action Map の進捗再計算（ロールアップ）
function recomputeActionMapProgress(actionMap: ActionMap, actionItems: ActionItem[]): ActionMap {
  const items = actionItems.filter(item => item.actionMapId === actionMap.id);

  if (items.length === 0) {
    return { ...actionMap, progressRate: 0 };
  }

  const totalProgress = items.reduce((sum, item) => sum + (item.progressRate || 0), 0);
  const rate = Math.round(totalProgress / items.length);

  return {
    ...actionMap,
    progressRate: rate,
    updatedAt: new Date().toISOString(),
  };
}
```

#### パフォーマンス考慮

- **影響範囲を限定**: 変更された Task に紐づく Action Item のみを更新（全体走査しない）
- **バッチ更新は不要**: 即時更新で十分（250KB制限内では性能問題なし）
- **計算量**: O(N) where N = 紐づくActionItemの数（通常1〜3件、最大10件想定）
- **UI更新の最適化**: 必要な部分のみ再レンダリング（React.memo等を活用）

#### エラーハンドリング

- **Task が削除された場合**: linkedTaskIds から自動削除、progressRate 再計算
- **Action Item が削除された場合**: 紐づく Task の「AMバッジ」を削除
- **Action Map が削除された場合**: 配下の Action Item も連鎖削除（または orphan として残す）

---

## 5. 権限・ロール

### ActionMap / ActionItem の CRUD 権限：

> **ロール定義（2025-11-29 明確化）**:
> - `isManager` = `workspace_members.role` が `'ADMIN'` または `'OWNER'`
> - 既存の `lib/utils/permissions.ts` の `canEdit()` / `canManageMembers()` を活用

| 操作 | 権限 |
|------|------|
| **作成** | `ADMIN` または `OWNER` ロール（= isManager） |
| **編集** | `ownerUserId` または `ADMIN` / `OWNER` |
| **削除** | `ownerUserId` または `ADMIN` / `OWNER` |
| **閲覧** | 同一 Workspace メンバー全員（ただし「マイアクション」ビューは自分が `assignee` のもののみ） |

### TODO Task 側

- 従来ルールを踏襲しつつ、
- **他人の Task に Action Item を紐付ける操作は上司のみ可**、などの制御も検討余地

---

## 6. Phase 11 サブフェーズ構成案

Phase 10 のパターンに合わせて、Phase 11 も **11-0〜** で刻みます。

### 11-0：PHASE11-ACTION-MAP-DESIGN（設計ドキュメント作成）

**目的**：Action Map 概念・データモデル・TODO連携の全体像を1つのドキュメントに整理し、実装前にレビューを受ける。

**成果物**：`DOCS/PHASE11-ACTION-MAP-DESIGN.md`

**必須セクション**:

#### 1. 用語定義と役割
- **Action Map**: 上司が作成する戦術計画（例: Q1新規リード10件獲得プラン）
- **Action Item**: Action Map 配下の具体的なタスク（例: テレアポリスト作成）
- **上司 → 部下 → TODO → カレンダー**の流れをシーケンス図で説明:
  ```
  上司（Manager）
    ↓ Action Map 作成
    ↓ Action Item 作成＋部下にアサイン
  部下（Member）
    ↓ Action Item から TODO 作成
    ↓ TODO を 4象限ボードで管理（Phase 10）
    ↓ Google カレンダーと連携
  実行・完了
    ↓ TODO 完了
    ↓ Action Item 進捗更新
    ↓ Action Map 進捗ロールアップ
  上司
    ↓ 進捗を可視化・確認
  ```
- 具体例を3つ以上（営業、開発、人事など異なる部門）

#### 2. データモデル
- ActionMap型, ActionItem型の最終版（SECTION 2-1 参照）
- workspace_data への追加構造（JSON形式で例示）:
  ```json
  {
    "actionMaps": [
      {
        "id": "am_001",
        "title": "Q1 新規リード 10件獲得プラン",
        "ownerUserId": "user_manager",
        "targetPeriodStart": "2025-01-01",
        "targetPeriodEnd": "2025-03-31",
        "progressRate": 60
      }
    ],
    "actionItems": [
      {
        "id": "ai_001",
        "actionMapId": "am_001",
        "parentItemId": null,
        "title": "テレアポリスト作成",
        "assigneeUserId": "user_member_a",
        "dueDate": "2025-01-15",
        "priority": "high",
        "status": "done",
        "linkedTaskIds": ["task_001", "task_002"],
        "progressRate": 100
      }
    ]
  }
  ```
- 既存データとの互換性保証（Phase 10 以前のデータが壊れないこと）

#### 3. TODO連携ポリシー
- **Action Item → TODO 生成時の初期値設定ルール**:
  - `suit`: 優先度に応じて自動設定（high → ♠ 緊急かつ重要, medium → ♥ 重要なこと, low → ♦ 緊急なだけ）
  - `durationMinutes`: デフォルト 30分（上司が推奨時間を設定可能）
  - `subTasks`: Action Item の description を自動コピー（オプション）
  - `googleCalendarEventId`: 生成時に自動連携（Phase 10 の機能を活用）
- **既存 TODO を後付けで紐付けるルール**:
  - 部下が自分の TODO にのみ紐付け可能
  - 上司は部下の TODO を代理で紐付け可能（権限による）
  - 1つの TODO は複数の Action Item に紐付け不可（1:1または1:Nの関係）
- **進捗同期のタイミング**:
  - TODO status 変更時: 即座に Action Item の progressRate を再計算
  - Action Item 更新時: 即座に Action Map の progressRate を再計算

#### 4. 権限ポリシー（詳細版）

**CRUD権限マトリクス**:

| 操作 | OWNER | ADMIN | MEMBER |
|------|-------|-------|--------|
| ActionMap作成 | ✓ | ✓ | ✗ |
| ActionMap編集（自分） | ✓ | ✓ | ✗ |
| ActionMap編集（他人） | ✓ | ✗ | ✗ |
| ActionMap削除（自分） | ✓ | ✓ | ✗ |
| ActionMap削除（他人） | ✓ | ✗ | ✗ |
| ActionMap閲覧 | ✓ | ✓ | ✓ |
| ActionItem作成 | ✓ | ✓（自分のMap） | ✗ |
| ActionItem編集（自分作成） | ✓ | ✓ | ✗ |
| ActionItem編集（自分がassignee） | ✓ | ✓ | ✓（status/progressのみ） |
| ActionItem編集（他人） | ✓ | ✗ | ✗ |
| ActionItem削除 | ✓ | ✓（自分のMap） | ✗ |
| TODO紐付け（自分のTODO） | ✓ | ✓ | ✓ |
| TODO紐付け（他人のTODO） | ✓ | ✓（部下のみ） | ✗ |

#### 5. UI/UXモック
- Action Map タブのレイアウト（ASCII art、後述）
- **ツリービュー / カンバンボードビューの切り替え**（UX強化）
- **残日数の視覚的警告**（🟢🟡🟠🔴）（UX強化）
- **フォーカスモード**（UX強化）
- **ガントチャート風表示**（オプション）（UX強化）
- Action Item ツリー表示
- TODO連携UI（作成/紐付けモーダル）
- ダッシュボード連携ウィジェット

#### 6. 進捗集計ロジック
- **Action Item の progressRate 計算式**:
  ```typescript
  progressRate = (完了TODO数 / 全TODO数) × 100
  ```
- **Action Map の progressRate 計算式（ロールアップ）**:
  ```typescript
  progressRate = 平均(配下ActionItemのprogressRate)
  ```
- **ステータス自動判定ルール**:
  - progressRate === 100 → status = 'done'
  - progressRate > 0 → status = 'in_progress'
  - progressRate === 0 && dueDate過ぎた → status = 'blocked'
  - それ以外 → status = 'not_started'

#### 7. 容量見積もり
- Phase 11 追加容量: 80 KB
- Phase 10までの合計: 225 KB
- **合計**: 305 KB → **250KB制限超過**
- **軽量化策**:
  - アーカイブ機能の実装
  - linkedTaskIds の最大件数制限
  - description の文字数制限

#### 8. パフォーマンス目標
- Action Map タブ初回表示: P95 < 1.5秒
- Action Item 進捗計算（再計算処理）: P95 < 100ms
- TODO連携操作（生成/紐付け）: P95 < 800ms
- ツリー表示（Action Item 200件）: P95 < 1.0秒
- **カンバンボード切り替え: P95 < 300ms**（UX強化）

#### 9. E2Eテストスコープ
- 上司→部下の一連フロー（Action Map作成→Item作成→TODO生成→完了→進捗確認）
- 進捗同期（TODO完了 → ActionItem更新 → ActionMap更新）
- 権限チェック（OWNER / ADMIN / MEMBER別）
- ツリー構造（親子ActionItem）
- **カンバンボードビュー操作**（UX強化）
- **フォーカスモード操作**（UX強化）
- 既存機能の回帰（Phase 10のTODO機能、Leads/Clients等）

#### 10. リスク・懸念事項
- **容量超過リスク**: 250KB制限を超える可能性（対策: アーカイブ実装）
- **UX課題**: 上司と部下の画面分離が分かりにくい可能性
- **Phase 10 との依存**: TODO の status フィールドが必要（Phase 10で未実装の場合は追加）
- **パフォーマンス**: Action Item 200件時のツリー表示速度
- **進捗同期の整合性**: TODO削除時の Action Item への影響

**完了条件**:
- [ ] 上記10セクションをすべて記載
- [ ] レビュー承認を得ること
- [ ] 容量超過問題の解決策を決定すること
- [ ] 次フェーズ（11-1）の実装が明確にイメージできること

**コード変更は禁止**。レポート後、承認を待つ。

---

### 11-1：core レイヤー拡張（Action Map モデル）

**目的**：Action Map を `workspace_data` に安全に載せる。

**対象**：

- `js/core/state.ts`（WorkspaceData 型拡張）
- `js/core/action-map.ts`（新規ファイル）
- `js/core/storage.js`（読み書き対応）

**作業**：

- `WorkspaceData` に `actionMaps: ActionMap[]`、`actionItems: ActionItem[]` を追加
- ロード時に旧データでもエラーにならないようフォールバック
- 単体テストが書けるなら最低限のシリアライズ／デシリアライズテスト

---

### 11-2：Action Map タブ（一覧＋詳細 UI ベース）

**目的**：Action Map の CRUD と、Action Item の CRUD を行う UI の土台を作る。

**対象**：

- `js/tabs/action-map.ts`（新規）
- 対応 HTML / Tab 切り替え

**要点**：

- 左に Action Map 一覧、右に選択中 Action Map 詳細の**2カラム**
- **ビュー切り替えボタン**（ツリー/カンバン）を実装
- Action Map の：
  - 新規作成モーダル（タイトル・期間・説明）
  - 編集・アーカイブ
- Action Item 一覧（まだ TODO 連携は後回し）

---

### 11-3：Action Item ツリー＋担当アサイン＋カンバンボード

**目的**：Action Item を**階層構造**＋**担当者付き**で管理できるようにし、**カンバンボードビュー**を追加する。

- 右ペインに**ツリー表示**（親子インデント）
- **カンバンボードビュー**の実装（ステータス別4列）
- **残日数の視覚的警告**（🟢🟡🟠🔴）の実装
- Action Item の：
  - 追加（親指定あり／なし）
  - 編集（タイトル・説明・担当者・期限・優先度）
  - ステータス変更（ドロップダウン or ドラッグ&ドロップ）
  - **ドラッグ&ドロップでアサイン変更**

**この段階では TODO 連携はまだ付けない**。

---

### 11-4：TODO 連携（Action Item ↔ Task）

**目的**：Action Item から TODO を生成／紐付けし、進捗を同期できるようにする。

**対象**：

- `js/tabs/action-map.ts`
- `js/tabs/todo.ts`（Task 詳細に「Action Item 紐付け」UI を追加）
- `js/core/state.ts`（`ActionItem.linkedTaskIds` と Task 側の status 確認）

**要点**：

- Action Item 詳細に：
  - 「**この Action から TODO を作成**」ボタン
  - 「**既存 TODO を紐付け**」ボタン
- TODO 作成モーダルでは Phase 10 のフィールドを再利用
  - **日本語ラベルで象限を選択**（♠ 緊急かつ重要 / ♥ 重要なこと / ♦ 緊急なだけ / ♣ 未来創造）
- Task 側カードに「**AM**」バッジ＋ホバーで Action Item タイトル表示
- 進捗同期ロジック実装（イベントベース or 集計関数）

---

### 11-5：進捗集計＆ダッシュボード連携（軽量版）＋フォーカスモード

**目的**：Action Map の進捗を Dashboard/Action Map 上で可視化し、フォーカスモードを実装する。

- Action Map 詳細上部に：
  - 全体進捗バー（Action Item の `progressRate` 平均）
  - ステータス別カウント
- **フォーカスモード**の実装：
  - 選択したAction Itemだけを大きく表示
  - TODO一覧の表示・編集が可能
- **ガントチャート風表示**（オプション）の実装
- 必要であれば Dashboard に下記のような軽いウィジェットを追加：
  - 「今週の自分の Action Item：完了数 / 全体数」
  - 「自分に紐づく TODO のうち、Action Map 由来の比率」

---

### 11-6：E2E テスト & 回帰確認

> **運用方針（2025-11-29 決定）**:
> E2Eテストは **Phase 11, 12 完了後にまとめて実施**する。
> Phase 11 単体での E2E 実行は任意とし、Phase 12 完了時点で全テスト一括実行を行う。

**目的**：Phase 11 の全機能が正常に動作し、Phase 10 までの機能を壊していないことを確認。

#### テストシナリオ

**シナリオ1: ハッピーパス（上司→部下→TODO→進捗）**

1. 上司（ADMIN）が Action Map を作成
   - タイトル: 「Q1 新規リード 10件獲得プラン」
   - 期間: 2025-01-01 ~ 2025-03-31
2. Action Item を 3つ作成:
   - Item1: テレアポリスト作成（担当: 佐藤A、期限: 01/15、優先度: high）
   - Item2: 毎日30分テレアポ（担当: 佐藤A、期限: 01/31、優先度: high）
   - Item3: リード品質チェック（担当: 鈴木B、期限: 01/20、優先度: medium）
3. Item1 から TODO を作成（♠ 緊急かつ重要 30分ブロック、09:00-09:30）
4. **検証**:
   - TODO が作成される
   - suit='spade'（優先度 high → ♠ 緊急かつ重要）
   - Item1.linkedTaskIds に TODO.id が追加される
5. 部下Aが TODO を完了
6. **検証**:
   - Item1 の status が 'done' に更新される
   - Item1 の progressRate が 100% になる
   - Action Map の progressRate が 33% になる（1/3完了）

**シナリオ2: 既存TODO紐付け**

1. 部下Aが先に TODO を作成（♥ 重要なこと 30分ブロック「テレアポ準備」）
2. 上司が後から Action Item を作成（テレアポ実施）
3. 部下Aが TODO詳細から「Action Itemに紐付け」ボタンをクリック
4. Action Item 一覧から「テレアポ実施」を選択
5. **検証**:
   - ActionItem.linkedTaskIds に TODO.id が追加される
   - TODO カードに「AM」バッジが表示される
   - ホバーで Action Item タイトルが表示される

**シナリオ3: 複数TODO紐付け（1 Action Item に複数TODO）**

1. Action Item を作成（毎日30分テレアポ）
2. 20個の TODO ブロックを作成（毎日30分×20日間、各♠ 緊急かつ重要ブロック）
3. すべての TODO を同じ Action Item に紐付け
4. **検証**: linkedTaskIds に 20個の TODO.id が含まれる
5. 10個の TODO を完了
6. **検証**:
   - Action Item の progressRate が 50% になる
   - status が 'in_progress' になる

**シナリオ4: 権限チェック**

1. MEMBER ロールでログイン
2. Action Map 作成を試みる
3. **検証**: エラーまたは「権限がありません」メッセージ
4. ADMIN ロールでログイン
5. Action Map 作成
6. **検証**: 成功
7. 他人（別ADMIN）の Action Map を編集しようとする
8. **検証**: エラー（作成者 または OWNER のみ可能）
9. 部下にアサインされた Action Item の status を変更
10. **検証**: 成功（assignee は status/progress のみ編集可能）

**シナリオ5: ツリー構造（親子 Action Item）**

1. Action Item「リード獲得」を作成（parentItemId: null）
2. その配下に子Item「テレアポ」を作成（parentItemId: 親ItemのID）
3. さらに子Item「メール営業」を作成
4. **検証**:
   - 子Item の parentItemId が親Item の id になる
   - UI でインデント表示される（ツリー構造）
5. 子Item の TODO を完了
6. **検証**:
   - 子Item の進捗が100%になる
   - 親Item の進捗は変わらない（親子の進捗は独立）

**シナリオ6: Action Map アーカイブ**

1. Action Map を完了（全 Action Item が done）
2. 「アーカイブ」ボタンをクリック
3. **検証**:
   - isArchived = true になる
   - 一覧から非表示になる
   - 「アーカイブ表示」フィルタで表示可能
   - 紐づくTODOは削除されない

**シナリオ7: ダッシュボード連携**

1. 部下Aが自分にアサインされたAction Item を3つ持つ（1つ完了、2つ進行中）
2. Dashboard を表示
3. **検証**:
   - 「今週の自分のAction Item」ウィジェットが表示される
   - 完了数 1 / 全体数 3 が正しい
   - 進捗バーが表示される

**シナリオ8: カレンダー連携統合（Phase 10 + Phase 11）**

1. Action Item から TODO を作成（♠ 緊急かつ重要 30分、カレンダー連携ON）
2. **検証**:
   - TODO が作成される
   - Googleカレンダーにイベント "[♠] {Action Item タイトル}" が作成される
   - task.googleCalendarEventId が保存される
3. TODO の時間を変更
4. **検証**: カレンダーイベントも更新される

**シナリオ9: カンバンボードビュー操作（UX強化）**

1. Action Map詳細画面で「カンバン」ビューに切り替え
2. **検証**: ステータス別4列（未着手/進行中/ブロック/完了）でAction Itemが表示される
3. 「未着手」のカードを「進行中」列にドラッグ&ドロップ
4. **検証**: Action Item の status が 'in_progress' に更新される
5. 残日数の色分けが正しい（🟢🟡🟠🔴）

**シナリオ10: フォーカスモード操作（UX強化）**

1. Action Itemをクリックして「フォーカスモード」を開く
2. **検証**: 選択したAction Itemの詳細と紐づくTODO一覧が表示される
3. フォーカスモード内でTODOを完了
4. **検証**: Action Itemの進捗が即座に更新される
5. フォーカスモード内で新規TODOを作成
6. **検証**: TODOが作成され、Action Itemに自動紐付けされる

**シナリオ11: 既存機能の回帰テスト**

Phase 10 の主要E2Eテストを再実行:
- [ ] TODO CRUD（4象限ボード含む、日本語ラベル表示確認）
- [ ] Elastic Habits（松/竹/梅、ストリークカウンター）
- [ ] Googleカレンダー連携（インポート含む）
- [ ] subTasks管理
- [ ] Leads / Clients CRUD
- [ ] Dashboard 表示（Phase 10 指標も正常）
- [ ] Workspace 切り替え
- [ ] Settings 画面

**すべてのテストが Phase 11 実装後も pass すること**

#### E2Eテスト実装

**ファイル**: `tests/e2e/action-map.spec.ts`

**必須テストケース**:
- ✅ Action Map CRUD
- ✅ Action Item CRUD
- ✅ Action Item ツリー構造（親子）
- ✅ TODO連携（生成/紐付け）
- ✅ 進捗同期（TODO → ActionItem → ActionMap）
- ✅ 権限チェック（OWNER / ADMIN / MEMBER）
- ✅ アーカイブ機能
- ✅ ダッシュボード連携
- ✅ カレンダー連携統合（Phase 10 + 11）
- ✅ **カンバンボードビュー操作**（UX強化）
- ✅ **フォーカスモード操作**（UX強化）
- ✅ **残日数の視覚的警告表示**（UX強化）
- ✅ 既存機能回帰

**テスト実行**:
```bash
npm run test:e2e -- action-map.spec.ts
```

**合格基準**: すべてのテストが pass すること

---

## 7. 進め方の共通パターン（全サブフェーズで徹底）

各サブフェーズ（11-0 / 11-1 / …）は、必ず次の順で行う：

1. **Design（設計）**
   対象ファイルと変更内容をテキストで整理（この段階ではコードを書かない）。

2. **Implement（実装）**
   `core → tabs → main` と既存ルールを守りながら、差分を実装。

3. **Test（テスト）**
   手動テスト＋関連テスト（E2E / unit）があれば実行し、必要なら修正。

4. **Refine（微調整）**
   UIの違和感、型の不整合などを最小限の修正で整える。

5. **Report（レポート & STOP）**
   - サブフェーズ番号（例：11-2）
   - 変更ファイルと主な差分（可能なら行番号）
   - 設計意図と理由
   - 影響範囲
   - テスト内容と結果
   - 残課題・次サブフェーズへの引き継ぎ

   をテキストで報告し、**必ず一度停止する**。

---

## 8. Phase 11 完了基準（DOD）

Phase 11 は以下をすべて満たした時点で完了とし、Phase 12 への移行が可能となる。

### 必須項目（Phase 12開始の前提条件）

- ✅ **機能実装完了**
  - Action Map CRUD（作成・編集・削除・アーカイブ）
  - Action Item CRUD（ツリー構造・担当アサイン）
  - **カンバンボードビュー**（UX強化）
  - **残日数の視覚的警告**（UX強化）
  - **フォーカスモード**（UX強化）
  - **ドラッグ&ドロップでアサイン/ステータス変更**（UX強化）
  - TODO連携（生成/紐付け）
  - 進捗集計（TODO → ActionItem → ActionMap）
  - ダッシュボード連携（軽量版）

- ✅ **E2Eテスト全てpass**
  - `tests/e2e/action-map.spec.ts` が全て成功
  - 既存機能の回帰テストが全て成功（Phase 10のTODO機能含む）
  - **注記（2025-11-29）**: E2Eテストは **Phase 11, 12 完了後にまとめて実施**する方針

- ✅ **workspace_data が容量制限内**
  - Phase 11完了時点の実測値: **200KB以下推奨**（250KB制限の80%以内）
  - 超過している場合は**アーカイブ機能を実装**（Phase 11-0で判断、11-6までに実装）
  - アーカイブポリシー実装済み（90日間更新なしで自動アーカイブ）

- ✅ **パフォーマンス基準を満たす（必須）**
  - Action Map タブ初回表示: **P95 < 1.5秒**
  - Action Item 進捗計算（再計算処理）: **P95 < 100ms**
  - TODO連携操作（生成/紐付け）: **P95 < 800ms**
  - ツリー表示（Action Item 200件）: **P95 < 1.0秒**
  - **カンバンボード切り替え: P95 < 300ms**（UX強化）
  - **Phase 10の基準も維持**（4象限ボード P95 < 1.2秒 等）

- ✅ **コード品質基準を満たす**
  - HOW-TO-DEVELOP.md の基本ルール違反: 0件
  - 依存方向（core → tabs → main）遵守
  - localStorage 直接アクセス: 0件

### Phase 12以降への引き継ぎ事項
- workspace_data 容量実測値（Phase 11完了時点）
- パフォーマンス計測結果
- アーカイブ戦略の実装状況
- Action Map → OKR 連携の準備（Phase 12で実装）

**重要:** パフォーマンス基準または容量制限を満たさない場合は Phase 11 未完了とし、Phase 12 へ進まないこと。基準を満たすまで改善を継続する。

---

## 9. UX強化機能サマリー（v11.1 追加）

Phase 11 で実装する UX 強化機能の一覧：

| # | 機能 | 対象サブフェーズ | 効果 |
|---|------|-----------------|------|
| 1 | カンバンボードビュー | 11-3 | ステータス別表示で進捗把握が容易 |
| 2 | 残日数の視覚的警告 | 11-3 | 期限見落とし防止 |
| 3 | ドラッグ&ドロップでアサイン変更 | 11-3 | 効率的な担当者変更 |
| 4 | フォーカスモード | 11-5 | 集中して作業に取り組める |
| 5 | ガントチャート風表示（オプション） | 11-5 | 期間全体のペース配分可視化 |

---

## 10. まとめ

- Phase 11 は「**Action Map = 上司の指示レイヤー**」「**TODO = 実行レイヤー**」という分離で設計
- `core/state` に ActionMap/ActionItem を追加し、TODO の Task と id で参照連携する
- UI は：
  - **Action Map タブ**：上司の設計・指示・進捗確認
    - **ツリービュー / カンバンボードビュー切り替え**（UX強化）
    - **フォーカスモード**（UX強化）
  - **TODO タブ**：部下の実行・日程管理（Phase 10 の4象限＆カレンダー連携を活かす）
- 実装は **11-0〜11-6** のサブフェーズで、**Design → Implement → Test → Refine → Report** の型を踏襲する

---

## 11. Claude Code への運用上のお願い

1. **サブフェーズ単位で必ず止まること**
   例：「11-3 まで完了しました。差分とテスト結果を報告するので、次に進めてよいか判断してください。」

2. **差分ベースで実装すること**
   ファイル丸ごと書き換えではなく、必要な箇所だけを変更する。

3. **テストを軽視しないこと**
   少なくとも TODO／Action Map 関連の E2E が通っているかを確認する。
   落ちた場合は原因と修正案をレポートに含める。

4. **Design → Implement → Test → Refine → Report の順番を必ず守ること**
   設計をテキストで出し、人間の目で確認してから、一気に実装しない。

---

---

## 12. TODO画面設計（Phase 10-D → Phase 11 連携）

### 12-1. 現状課題と設計方針

#### 現状課題

Phase 10-D で4象限ボードを実装したが、以下の課題が残っている：

1. **「今日何をやるか」が不明確**
   - 4象限には全タスクが混在
   - 今日フォーカスすべきタスクが識別できない

2. **Google Calendar との役割重複**
   - Google Calendar の「Block off time for tasks」機能（2025年11月17日リリース）が時間ブロック管理を担当
   - FDC 側で時間ブロックを二重管理する意味が薄い

3. **Action Map との接続がない**
   - TODO が「どの上位ゴールに貢献するか」が見えない
   - 部下が「なぜこの作業をするか」を理解しにくい

#### 設計方針

```
┌─────────────────────────────────────────────────────────────┐
│ FDC の役割                                                   │
├─────────────────────────────────────────────────────────────┤
│ ✅ 4象限分類（緊急度×重要度）                                 │
│ ✅ Elastic Habits（松竹梅）のストリーク管理                   │
│ ✅ Action Map → OKR → TODO の階層可視化                      │
│ ✅ 「今日のフォーカス」選択                                   │
├─────────────────────────────────────────────────────────────┤
│ Google Calendar/Tasks の役割                                 │
├─────────────────────────────────────────────────────────────┤
│ 📅 時間ブロックの管理（Block off time for tasks）             │
│ 📅 リマインダー・通知                                        │
│ 📅 実績としてのカレンダー記録                                │
└─────────────────────────────────────────────────────────────┘
```

### 12-2. 3レイヤービュー設計

TODO画面を3つのビューで構成し、ユーザーの文脈に応じて切り替え可能にする。

#### ビュー1: 今日のフォーカス（Daily Focus）

```
┌─────────────────────────────────────────────────────────────────┐
│ 📅 今日のフォーカス（2025-01-28 火）          [4象限] [Action Map]│
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ♠ 緊急かつ重要（Do First）                                      │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ ☐ テレアポ 10件実施                     🔥 5日連続          ││
│ │   ← Q1リード獲得/テレアポ強化                               ││
│ └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│ ♥ 重要なこと（Habits）                  🔥 ストリーク表示       │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ ☐ 英語学習 30分（竹）                   🔥 12日連続         ││
│ │ ☐ 読書 15分（梅でもOK）                 🔥 3日連続          ││
│ └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━│
│ 今日のサマリー: 3件完了 / 5件                                   │
│ [+ 今日のタスクを追加] [バックログから選択]                      │
└─────────────────────────────────────────────────────────────────┘
```

**特徴:**
- `isTodayFocus: true` のタスクのみ表示
- Elastic Habits のストリーク強調
- Action Map へのリンク（← Q1リード獲得...）

#### ビュー2: 4象限バックログ（現行ボード）

```
┌─────────────────────────────────────────────────────────────────┐
│ 📋 バックログ（4象限）                    [今日] [Action Map]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│        ┌───────────────────┬───────────────────┐               │
│   緊   │ ♠ 緊急かつ重要     │ ♥ 重要なこと      │   重           │
│   急   │ (3件)             │ (5件)             │   要           │
│        ├───────────────────┼───────────────────┤               │
│        │ ♦ 緊急なだけ       │ ♣ 未来創造        │               │
│        │ (2件)             │ (4件)             │               │
│        └───────────────────┴───────────────────┘               │
│                                                                 │
│ [🎯 今日のフォーカスに追加]                                      │
└─────────────────────────────────────────────────────────────────┘
```

**特徴:**
- 全タスクを4象限で俯瞰
- タスクをドラッグして「今日のフォーカス」に追加
- Phase 10-D で実装済みのボードを活用

#### ビュー3: Action Map ドリルダウン

```
┌─────────────────────────────────────────────────────────────────┐
│ 🗺️ Action Map ドリルダウン                  [今日] [4象限]       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 📊 Q1 新規リード 10件獲得プラン                    進捗: 60%    │
│ ├─ 📋 リード獲得（親Action Item）                  進捗: 80%    │
│ │   ├─ ☑ テレアポリスト作成                       ✓ 完了       │
│ │   ├─ ☐ 毎日30分テレアポ                        進捗: 50%    │
│ │   │   └─ [TODO] テレアポ 10件実施               ← 今日      │
│ │   │   └─ [TODO] テレアポ 10件実施               1/29        │
│ │   │   └─ [TODO] テレアポ 10件実施               1/30        │
│ │   └─ ☐ リード品質チェック                       未着手      │
│ ├─ 📋 商談化                                       進捗: 30%    │
│ │   └─ ...                                                     │
│ └─ 📋 既存深堀り                                   進捗: 0%     │
│                                                                 │
│ [🎯 今日のフォーカスに追加] [千切ってTODO作成]                   │
└─────────────────────────────────────────────────────────────────┘
```

**特徴:**
- Action Map → Action Item → TODO の階層表示
- 「なぜこの作業をするか」が一目で分かる
- Action Item から TODO を「千切る」操作

### 12-3. 「千切る」パターン（Action Item → TODO 分割）

Action Item から TODO を作成する際の分割パターン：

#### パターン1: 期間分割（時間軸で千切る）

```
Action Item: 「毎日30分テレアポ」（1/21〜1/31）
      ↓ 千切る（期間分割）
TODO: 1/21 テレアポ 30分
TODO: 1/22 テレアポ 30分
...
TODO: 1/31 テレアポ 30分
```

**ユースケース:**
- 習慣化したい作業（Elastic Habits 対象）
- 定期的なルーティン

#### パターン2: 工程分割（プロセスで千切る）

```
Action Item: 「提案書作成」（期限: 2/15）
      ↓ 千切る（工程分割）
TODO: ① 要件ヒアリング整理
TODO: ② 構成案作成
TODO: ③ 本文執筆
TODO: ④ レビュー・修正
TODO: ⑤ 最終確認・提出
```

**ユースケース:**
- プロジェクト型の成果物作成
- 明確な工程がある作業

#### パターン3: 数量分割（ボリュームで千切る）

```
Action Item: 「顧客100件にメール送信」
      ↓ 千切る（数量分割）
TODO: メール送信 1-25件目（1/21）
TODO: メール送信 26-50件目（1/22）
TODO: メール送信 51-75件目（1/23）
TODO: メール送信 76-100件目（1/24）
```

**ユースケース:**
- 大量の繰り返し作業
- 1日で終わらない作業量

#### パターン4: 優先度分割（重要度で千切る）

```
Action Item: 「営業資料アップデート」
      ↓ 千切る（優先度分割）
TODO: [♠] 価格表更新（緊急・重要）
TODO: [♥] 事例ページ追加（重要・非緊急）
TODO: [♣] デザイン刷新（将来投資）
```

**ユースケース:**
- 優先度が異なる複数の作業を含む
- 一部だけ先に着手したい

### 12-4. UI 操作フロー

#### 「今日のフォーカス」への追加フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 4象限バックログ or Action Map ドリルダウン                       │
│                                                                 │
│ タスクカードをクリック → コンテキストメニュー表示                │
│ ┌─────────────────────────┐                                     │
│ │ 🎯 今日のフォーカスに追加 │ ← クリック                        │
│ │ ✏️ 編集                  │                                     │
│ │ 🗑️ 削除                  │                                     │
│ └─────────────────────────┘                                     │
│                                                                 │
│ → タスクに isTodayFocus: true がセットされる                    │
│ → 「今日のフォーカス」ビューに表示される                        │
└─────────────────────────────────────────────────────────────────┘
```

#### 「千切る」操作フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ Action Map ドリルダウン                                         │
│                                                                 │
│ Action Item をクリック → 「千切ってTODO作成」ボタン              │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 🔪 千切りモード選択                                          ││
│ │                                                             ││
│ │ ○ 期間分割（毎日/毎週の繰り返し）                           ││
│ │   開始: [2025-01-21]  終了: [2025-01-31]                    ││
│ │   頻度: [毎日 ▼]                                            ││
│ │                                                             ││
│ │ ○ 工程分割（ステップに分ける）                              ││
│ │   ステップ: [テキストエリア - 改行区切り]                   ││
│ │                                                             ││
│ │ ○ 数量分割（数で分ける）                                    ││
│ │   総数: [100]  1回あたり: [25]                              ││
│ │                                                             ││
│ │ ○ 優先度分割（象限に振り分け）                              ││
│ │   タスク名と象限を入力...                                   ││
│ │                                                             ││
│ │ [キャンセル]                        [TODO作成]              ││
│ └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 12-5. データモデル拡張

```typescript
// Task 型への追加フィールド（lib/types/todo.ts）
export interface Task {
  // 既存フィールド...

  // Phase 11 追加: 今日のフォーカス
  isTodayFocus?: boolean;       // 今日のフォーカスに含まれるか
  focusDate?: string;           // フォーカス対象日（ISO日付）

  // Phase 11 追加: Action Map 連携
  actionItemId?: string;        // 紐づく Action Item の ID
  actionMapId?: string;         // 紐づく Action Map の ID（冗長だが高速化のため）

  // Phase 11 追加: 千切り情報
  tearPattern?: 'period' | 'process' | 'quantity' | 'priority';
  tearIndex?: number;           // 千切った中の何番目か
  tearTotal?: number;           // 千切った総数
}
```

### 12-6. 実装優先順位

Phase 11 で段階的に実装：

| 優先度 | 機能 | サブフェーズ | 備考 |
|--------|------|-------------|------|
| P0 | isTodayFocus フラグ | 11-4 | Task 型拡張のみ |
| P0 | 「今日のフォーカス」ビュー | 11-4 | 基本表示 |
| P1 | Action Map ドリルダウン | 11-5 | ツリー表示 |
| P1 | 千切りモーダル（期間分割） | 11-4 | Elastic Habits との連携 |
| P2 | 千切りモーダル（工程/数量分割） | 11-5 | UI実装 |
| P2 | 千切りモーダル（優先度分割） | 11-5 | 4象限との連携 |
| P3 | ビュー切り替えアニメーション | 11-6 | UX polish |

### 12-7. Google Calendar 連携（Phase 10-D 継承）

FDC から Google Calendar への連携は以下の方針：

```
FDC TODO                    Google Calendar
───────────────────────────────────────────
タスク作成                →  Google Tasks に同期
「今日のフォーカス」に追加 →  「Block off time」で時間ブロック確保
タスク完了                →  Tasks 完了 + カレンダー実績記録
```

**注意:** 時間ブロックの詳細管理（開始時刻、所要時間）は Google Calendar に委譲。FDC では4象限分類とストリーク管理に集中。

---

**以上、Phase 11 Action Map レイヤー実装ランブック v11.1**
