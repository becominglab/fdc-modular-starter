# Phase 9.93 ランブック：バグ修正 & 完全整合性確保（統括版）

**最終更新:** 2025-11-25
**ステータス:** 待機中（Phase 9.92 完了後に開始）
**アプローチ:** Phase 9.92 で移行したすべてのタブについて、UI差異・ロジック差異・Next.js固有の不具合をゼロにする

---

## 必読ドキュメント（作業開始前に必ず確認）

| ドキュメント | パス | 確認項目 |
|-------------|------|---------|
| **グランドガイド** | `docs/FDC-GRAND-GUIDE.md` | プロジェクト全体方針、AIチーム運用ルール |
| **開発ガイド** | `docs/guides/DEVELOPMENT.md` | 基本ルール、ファイル命名規則、コーディング規約 |

---

## 並列ワークストリーム構成

Phase 9.93 は **4つの並列ワークストリーム** に分割されています。各ワークストリームは独立して実行可能です（D のみ A, B, C 完了後）。

| ワークストリーム | ドキュメント | 内容 | 依存 |
|----------------|-------------|------|------|
| **A: レガシー隔離** | `PHASE9.93-A-LEGACY-CLEANUP.md` | レガシーコード隔離、ESLint禁止ルール、CI自動検出 | なし |
| **B: パフォーマンス** | `PHASE9.93-B-PERFORMANCE.md` | バンドル最適化、RSC PoC、CSS移行方針、CI閾値チェック | なし |
| **C: UI検証** | `PHASE9.93-C-UI-VERIFICATION.md` | UI差異検出・修正、Visual Regression導入 | なし |
| **D: UAT・ゲート** | `PHASE9.93-D-UAT-GATE.md` | UAT実施、技術/品質/承認ゲート、Phase 10移行 | A, B, C |

### 実行フロー

```
                    ┌─────────────────────┐
                    │  Phase 9.92 完了    │
                    └──────────┬──────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
    │     A       │     │     B       │     │     C       │
    │  レガシー隔離 │     │ パフォーマンス│     │   UI検証    │
    │   (1-1.5h)  │     │   (6-8h)    │     │  (10-15h)   │
    └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
           │                   │                   │
           └───────────────────┼───────────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │         D           │
                    │   UAT・ゲート        │
                    │     (10-14h)        │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │    Phase 10 開始    │
                    └─────────────────────┘
```

### 各ワークストリームへのリンク

- **[A: レガシー隔離](./PHASE9.93-A-LEGACY-CLEANUP.md)** - CL-01〜04、ESLint、CI
- **[B: パフォーマンス](./PHASE9.93-B-PERFORMANCE.md)** - バンドル、RSC、CSS、CI
- **[C: UI検証](./PHASE9.93-C-UI-VERIFICATION.md)** - 差異検出・修正、Visual Regression
- **[D: UAT・ゲート](./PHASE9.93-D-UAT-GATE.md)** - UAT、技術/品質/承認ゲート

---

## 0. フェーズ概要

### 0.0 Phase 9.93 開始の前提条件（ゲート）

**Phase 9.93 を開始するには、以下の条件がすべて満たされていること：**

| チェック項目 | 確認方法 | 合格基準 |
|-------------|---------|---------|
| Phase 9.92-1〜10 の DOD 達成 | 各タブの DOD チェックリストを確認 | 全項目チェック済み |
| `npm run type-check` | コマンド実行 | エラー 0 件 |
| `npm run build` | コマンド実行 | 警告 0 件、成功 |
| E2E テスト（全体） | `npm run test:e2e` | 全 Pass |
| 技術負債インベントリ | `docs/TECH-DEBT-INVENTORY.md` 存在確認 | ファイル存在 |

**ゲート未達の場合**: Phase 9.92 に差し戻し、未達項目を解消してから再度ゲートを通過する。

### 0.1 Phase 9.93 の役割とスコープ

**Phase 9.93 は「Phase 9.92（全タブ再生）の後に実施するバグ修正フェーズ」です。**

#### フェーズの位置づけ

```
Phase 9.9   → 緊急バグ修正 & ガバナンス強化（権限・リード管理・SAタブ）
Phase 9.91  → 大規模クリーンアップ & 構造改革（レガシーコード隔離・ドキュメント標準化）
Phase 9.92  → 全タブ再生プロジェクト（既存UIを維持したまま、全10タブをReactに移行）
Phase 9.93  → 【本フェーズ】バグ修正 & 完全整合性確保 ← ★ここ
Phase 10    → TODO機能本格実装（9.93 完了後に開始）
```

#### Phase 9.93 の目的

Phase 9.92 の移行過程で発生する以下の問題をすべて解消する：

1. **UI差異**: 旧UIとの見た目の不一致（色・サイズ・レイアウト・アニメーション）
2. **ロジック差異**: 旧JSロジックとのズレ（集計結果・ステータス移行・データ処理）
3. **Next.js / React 特有の不具合**: SSR/CSR、useEffect、依存関係、型エラーなど
4. **パフォーマンス最適化**: バンドルサイズ削減、初期ロード時間改善
5. **将来の拡張性確保**: コード分割戦略、RSC PoC、CSS レイヤー出口戦略

#### Phase 9.9 / 9.91 の残務の統合

**Phase 9.9 および Phase 9.91 で未処理だった残務は、すべて Phase 9.93 で処理します。**

以下の表は、Phase 9.9 / 9.91 の残務を「Phase 9.92 に引き継ぐもの」と「Phase 9.93 に引き継ぐもの」に分類したものです：

| 元フェーズ | タスクID | タスク名 | 分類 | Phase 9.92 / 9.93 での扱い |
|-----------|---------|---------|------|--------------------------|
| **Phase 9.9** | FIX-01 | Admin Role Fix | **9.93（バグ修正）** | 権限表示ロジックの検証・修正 |
| Phase 9.9 | L-01 | Lead Status | **9.92（UI実装）** → 9.93（検証） | 4ステータス制の実装と動作確認 |
| Phase 9.9 | L-02 | Lost Tab | **9.92（UI実装）** → 9.93（検証） | 失注タブの実装と動作確認 |
| Phase 9.9 | C-01 | Won Transition | **9.92（ロジック実装）** → 9.93（検証） | 成約→既存客フローの実装と検証 |
| Phase 9.9 | C-02 | Contract Date | **9.92（UI実装）** → 9.93（検証） | 契約日フィールドの実装と検証 |
| Phase 9.9 | GOV-04 | SA Dashboard | **9.92（UI実装）** → 9.93（検証） | SAタブの実装と動作確認 |
| **Phase 9.9** | GOV-05 | 3-2-1 Rule | **9.93（バグ修正）** | 権限階層ロジックの検証 |
| **Phase 9.9** | TEST-01 | E2E Verification | **9.93（テスト実装）** | E2Eテストの実装・実行 |
| **Phase 9.91** | CL-01 | Legacy Archiving | **9.93（検証）** | レガシーコードの完全隔離確認 |
| **Phase 9.91** | CL-02 | Root Cleaning | **9.93（検証）** | ルートディレクトリの浄化確認 |
| **Phase 9.91** | CL-03 | Docs Renaming | **9.93（検証）** | `docs/` リネーム確認 |
| **Phase 9.91** | CL-04 | Config Update | **9.93（検証）** | ビルド設定の整合性確認 |

**Phase 9.93 の責務（まとめ）**:
- ✅ **Phase 9.92 で実装されたUI/ロジックの動作確認と修正**
- ✅ **Phase 9.9 / 9.91 で未実装だったバグ修正・検証系タスクの実施**
- ✅ **すべてのテストの実装・実行**
- ✅ **ビルド・型チェックの警告ゼロ化**

**Phase 9.9 の残務（詳細）**:
- リードステータス刷新（4ステータス制）の完全動作確認
- 失注タブの動作検証
- 成約→既存客の自動連携検証
- SAタブの動作検証
- 3-2-1 ルール（権限階層）の UI 強制確認
- E2E テストの実装・実行

**Phase 9.91 の残務（詳細）**:
- レガシーコードの完全隔離確認
- ルートディレクトリの浄化確認
- `DOCS/` → `docs/` リネーム（実施済みなら確認のみ）
- パス参照の整合性確認
- `npm run build` / `npm run type-check` の警告ゼロ化

### 0.2 完了条件（DOD）

Phase 9.93 を「完了」とみなす条件：

#### UI要件
- [ ] すべてのタブが旧UIとスクリーンショット比較で95%以上一致する
- [ ] レスポンシブデザインが正しく動作する（モバイル・タブレット・デスクトップ）
- [ ] ガラスモーフィズム効果が正しく適用されている
- [ ] ホバー・フォーカス・アニメーションが旧UIと一致する

#### ロジック要件
- [ ] 旧JSロジック（`archive/phase9-legacy-js/tabs/*.ts`）と動作が100%一致する
- [ ] すべてのデータ集計（KPI・ファネル・失注理由など）が正しい
- [ ] ステータス遷移（リード・クライアント）が旧UIと同じ挙動をする
- [ ] API レスポンスの型が正しく定義されている

#### 技術要件
- [ ] `npm run build` が警告ゼロで成功する
- [ ] `npm run type-check` がエラーゼロで成功する
- [ ] すべての E2E テスト（既存 + 新規）が Pass する
- [ ] console に警告・エラーが出ない（開発環境・本番環境）

#### Phase 9.9 / 9.91 残務要件
- [ ] リードステータス刷新が完全動作する
- [ ] 失注タブが正しく動作する
- [ ] 成約→既存客の自動連携が動作する
- [ ] SAタブが正しく表示・動作する
- [ ] 3-2-1 ルール（権限階層）が UI で強制される
- [ ] レガシーコードが完全隔離されている
- [ ] ルートディレクトリが整理されている

#### パフォーマンス要件（追加）
- [ ] 初期バンドルサイズが Phase 9.92 比で 30% 以上削減されている
- [ ] Lighthouse Performance スコアが 80 以上である
- [ ] 重いタブに `next/dynamic` が適用されている

**★ パフォーマンス基準値の記録（Phase 9.92 完了時に必須）**:

Phase 9.93 開始前に、以下の基準値を記録すること。この値が「30%削減」の比較対象となる。

| 指標 | Phase 9.92 完了時の値 | Phase 9.93 目標値 | 記録日 |
|------|----------------------|------------------|--------|
| 初期バンドルサイズ（main.js） | ______ KB | ______ KB（-30%） | YYYY-MM-DD |
| 初期バンドルサイズ（合計） | ______ KB | ______ KB（-30%） | YYYY-MM-DD |
| Lighthouse Performance | ______ / 100 | 80 / 100 以上 | YYYY-MM-DD |
| First Contentful Paint (FCP) | ______ ms | ______ ms | YYYY-MM-DD |
| Largest Contentful Paint (LCP) | ______ ms | ______ ms | YYYY-MM-DD |

**基準値の計測方法**:
```bash
# バンドルサイズの計測
npm run build
ls -lh .next/static/chunks/*.js | head -20

# または next-bundle-analyzer を使用
ANALYZE=true npm run build

# Lighthouse の計測
npx lighthouse http://localhost:3000/dashboard --output=json --output-path=./lighthouse-phase992.json
```

**記録責任者**: Phase 9.92 リード担当が、Phase 9.92 完了時に上記表を埋める

#### 将来拡張性要件（新規）
- [ ] コード分割戦略が実装されている
- [ ] RSC PoC が完了し、結果がドキュメント化されている
- [ ] CSS 移行方針（Tailwind or CSS Modules）が決定されている
- [ ] `docs/TECH-DEBT-INVENTORY.md` の技術負債が 50% 以上解消されている

#### UAT（ユーザー受入テスト）要件（分析レポートからの提言）
- [ ] 実際の業務フローでの試用を実施している
- [ ] 「旧仕様通り動いているが、Reactになったら使いにくい」部分がないか確認済み
- [ ] ステークホルダーからの承認を得ている
- [ ] 発見されたUX改善点が文書化されている（Phase 10 以降で対応）

---

## 1. Phase 9.9 / 9.91 残務の統合リスト

### 1.1 Phase 9.9 残務の統合

#### FIX-01: Admin Role Fix（設定画面消失バグ修正）

**元のタスク**: `Sidebar` 表示ロジック修正 + Admin Seed 再実行

**Phase 9.93 での対応**:
- [ ] `admin@example.com` が `fdc_admin` (Global Role) に設定されているか確認
- [ ] `Sidebar` で「設定」タブが全員に表示されるか確認
- [ ] `Sidebar` で「管理者」「SA」タブが `fdc_admin` のみに表示されるか確認
- [ ] 一般ユーザーでログアウトできるか確認

**検証方法**:
1. `admin@example.com` でログイン → 「設定」「管理者」「SA」タブが見えることを確認
2. 一般ユーザーでログイン → 「設定」タブのみ見えることを確認

---

#### L-01: Lead Status（リードステータス刷新）

**元のタスク**: ステータスを「未接触/反応あり/商談中/成約」の4つに限定

**Phase 9.93 での対応**:
- [ ] リード管理画面が4カラム（未接触・反応あり・商談中・成約）になっているか確認
- [ ] カンバンビューで正しくドラッグ&ドロップできるか確認
- [ ] リストビューで正しくステータス変更できるか確認
- [ ] `LeadStatus` 型定義が正しいか確認

**検証方法**:
1. `/leads` にアクセス → 4カラムが表示されることを確認
2. リードを作成 → 各カラムにドラッグ&ドロップできることを確認
3. ステータス変更 → API が正しく呼び出されることを確認

---

#### L-02: Lost Tab（失注タブ）

**元のタスク**: 新規タブ `/leads/lost` の作成

**Phase 9.93 での対応**:
- [ ] `/leads/lost` ページが存在するか確認
- [ ] `status === 'LOST'` のリードが一覧表示されるか確認
- [ ] 「敗者復活（ステータスを未接触に戻す）」ボタンが動作するか確認
- [ ] 失注アンケート結果が表示されるか確認

**検証方法**:
1. リードを「失注」に変更 → `/leads/lost` に表示されることを確認
2. 「敗者復活」ボタンをクリック → ステータスが「未接触」に戻ることを確認

---

#### C-01: Won Transition（成約→既存客の自動連携）

**元のタスク**: WON 時に Clients テーブルへコピー作成

**Phase 9.93 での対応**:
- [ ] リードを「成約」にすると、`clients` テーブルに自動的にコピーされるか確認
- [ ] コピーされた既存客の基本情報（社名・担当者・連絡先）が正しいか確認
- [ ] `contract_date` が `NULL` で作成されているか確認

**検証方法**:
1. リードを「成約」に変更 → `/clients` に表示されることを確認
2. 既存客の詳細を確認 → 基本情報が正しくコピーされていることを確認

---

#### C-02: Contract Date（契約日管理）

**元のタスク**: Clients に `contract_date` 追加

**Phase 9.93 での対応**:
- [ ] 既存客編集モーダルに「契約日 (Contract Date)」入力欄があるか確認
- [ ] 契約日を入力 → 保存されるか確認
- [ ] 契約日が表示されるか確認

**検証方法**:
1. 既存客を編集 → 契約日入力欄が存在することを確認
2. 契約日を入力・保存 → 正しく保存されることを確認

---

#### GOV-04: SA Dashboard（スーパーアドミンタブ）

**元のタスク**: 全ユーザーの「現在ログイン中のWS」一覧表示

**Phase 9.93 での対応**:
- [ ] `/admin/sa` ページが存在するか確認
- [ ] `fdc_admin` のみアクセスできるか確認
- [ ] 全ユーザーの現在のワークスペースが一覧表示されるか確認
- [ ] 最終アクセス日時が表示されるか確認

**検証方法**:
1. `fdc_admin` でログイン → `/admin/sa` にアクセスできることを確認
2. 一般ユーザーでログイン → `/admin/sa` にアクセスできないことを確認
3. SA画面で全ユーザーの稼働状況が見えることを確認

---

#### GOV-05: 3-2-1 Rule（権限階層の強制）

**元のタスク**: ロール間操作制限ロジック (`canManageRole`) 実装

**Phase 9.93 での対応**:
- [ ] `lib/core/roles.ts` に `canManageRole(myRole, targetRole)` が実装されているか確認
- [ ] Admin(3) > EXEC(2) > MANAGER(1) > MEMBER(0) の階層が正しいか確認
- [ ] 招待モーダルで、自分が招待可能なロールのみ表示されるか確認
- [ ] MANAGER が EXEC を招待できないことを確認

**検証方法**:
1. MANAGER でログイン → 招待モーダルを開く → EXEC が選択肢に出ないことを確認
2. EXEC でログイン → 招待モーダルを開く → MANAGER/MEMBER のみ選択できることを確認
3. Admin でログイン → すべてのロールを選択できることを確認

---

#### TEST-01: E2E Verification（E2Eテスト実装）

**元のタスク**: 権限・リード遷移・ガバナンスの自動テスト実装

**Phase 9.93 での対応**:
- [ ] `tests/e2e/governance-and-leads.spec.ts` が存在するか確認
- [ ] Case 1 (Sidebar): Admin と一般ユーザーのタブ表示差異を検証
- [ ] Case 2 (Lead Flow): リード作成 → WON → Client タブに存在することを確認
- [ ] Case 3 (Lost Flow): リード作成 → LOST → Lostタブに移動 → 敗者復活を確認
- [ ] Case 4 (3-2-1 Rule): MANAGER でログインし、招待モーダルに「EXEC」が表示されないことを確認
- [ ] すべてのテストが Pass することを確認

**検証方法**:
1. `npm run test:e2e` を実行 → すべてのテストが Pass することを確認

---

### 1.2 Phase 9.91 残務の統合

#### CL-01: Legacy Archiving（レガシーコードの隔離）

**元のタスク**: `js/`, `dist/`, `legacy-php/` を `archive/` へ移動

**Phase 9.93 での対応**:
- [ ] ルートに `js/` フォルダが存在しないことを確認
- [ ] `archive/phase9-legacy-js/` にレガシーコードが移動されていることを確認
- [ ] `npm run build` が、移動した `js/` を参照せずに成功することを確認

**検証方法**:
1. `ls -la` でルートディレクトリを確認 → `js/` が存在しないことを確認
2. `npm run build` を実行 → import エラーが出ないことを確認

---

#### CL-02: Root Cleaning（ルートディレクトリの浄化）

**元のタスク**: スクリプト群を `scripts/` へ集約、`index.html` 退避

**Phase 9.93 での対応**:
- [ ] `test-crud.js`, `test-connection.js` が `scripts/db/` に移動されているか確認
- [ ] `benchmark.js` が `scripts/performance/` に移動されているか確認
- [ ] `index.html` が `archive/legacy-index.html` に退避されているか確認
- [ ] ルートディレクトリのファイル数が 15個以下になっているか確認

**検証方法**:
1. `ls -la` でルートディレクトリを確認 → ファイル数が 15個以下であることを確認

---

#### CL-03: Docs Renaming（ドキュメント構造の標準化）

**元のタスク**: `DOCS/` を `docs/` へリネーム

**Phase 9.93 での対応**:
- [ ] フォルダが `docs` になっているか確認
- [ ] `docs/FDC-GRAND-GUIDE.md` 内の内部リンク（`DOCS/...`）が `docs/...` に置換されているか確認
- [ ] `docs/PHASE10-TODO-ELASTIC-RUNBOOK.md` 内のリンクが修正されているか確認

**検証方法**:
1. `ls -la` でルートディレクトリを確認 → `docs` フォルダが存在することを確認
2. `grep -r "DOCS/" docs/` を実行 → リンク切れがないことを確認

---

#### CL-04: Config Update（設定整合性の確保）

**元のタスク**: `package.json`, `tsconfig.json` のパス修正

**Phase 9.93 での対応**:
- [ ] `package.json` の `scripts` 欄で、移動したファイルを参照している箇所が修正されているか確認
- [ ] `tsconfig.json` の `include`/`exclude` で、`archive` が除外され、`scripts` が含まれているか確認
- [ ] プロジェクト全体で `from '../../js/...'` のような旧パス参照がないか確認

**検証方法**:
1. `npm run build` を実行 → エラーが出ないことを確認
2. `npm run type-check` を実行 → エラーが出ないことを確認
3. `grep -r "from '.*js/" app/ lib/` を実行 → 旧パス参照がないことを確認

---

## 2. バグ分類フレームワーク

Phase 9.93 では、すべてのバグを以下の3つのカテゴリに分類します。

### 2.1 UI差異（Visual Bugs）

**定義**: 旧UIとの見た目の不一致

**具体例**:
- 色が微妙に違う（例: プライマリカラーが `#00B8C4` ではなく `#00B8C5` になっている）
- サイズが違う（例: カードの角丸が `12px` ではなく `8px` になっている）
- レイアウトがズレている（例: グリッドの列数が違う、余白が違う）
- アニメーションが動かない（例: ホバー時の影の変化がない）
- レスポンシブが崩れている（例: モバイル表示でレイアウトが崩れる）

**検知方法**:
1. **スクリーンショット比較（標準手順）**:
   - 旧UI（`archive/phase9-legacy-root/index.html`）と新UI（Next.js）を同じブラウザサイズで表示
   - スクリーンショットを撮影して比較ツール（例: [diffchecker.com/image-diff](https://www.diffchecker.com/image-diff/)）で比較
   - 差異を特定

   **★ スクリーンショット比較の標準基準（CODEXレビュー対応）**:
   | 項目 | 基準値 |
   |------|--------|
   | ブラウザ | Chrome（最新版） |
   | ビューポート幅 | **1440px**（デスクトップ基準）、**768px**（タブレット）、**375px**（モバイル） |
   | 比較対象領域 | **ヘッダー・サイドバー除外**、コンテンツエリアのみ |
   | Diff閾値 | **5%以下**で合格（95%一致） |
   | 比較ツール | [diffchecker.com/image-diff](https://www.diffchecker.com/image-diff/) または Playwright Visual Comparison |
   | 除外対象 | 動的データ（日時、件数）、アニメーション中の状態 |

   **Playwright での自動比較（推奨）**:
   ```typescript
   // tests/e2e/visual-regression.spec.ts
   test('dashboard visual comparison', async ({ page }) => {
     await page.setViewportSize({ width: 1440, height: 900 });
     await page.goto('/dashboard');
     await expect(page).toHaveScreenshot('dashboard.png', {
       maxDiffPixelRatio: 0.05, // 5%以下の差異を許容
       mask: [page.locator('.dynamic-data')], // 動的データを除外
     });
   });
   ```

2. **CSS変数の確認**:
   - `app/globals.css` の `:root` 変数が旧UIの CSS と一致しているか確認
   - 色コードを一つずつ照合

3. **DevToolsでの検証**:
   - ブラウザの DevTools で要素を検証
   - Computed スタイルを確認し、旧UIの CSS と比較

**修正方法**:
1. 原因を特定（CSS変数 / コンポーネントスタイル / Tailwind クラス）
2. 旧UIの CSS をコピーして適用
3. スクリーンショット比較で差異がなくなるまで修正

---

### 2.2 ロジック差異（Logic Bugs）

**定義**: 旧JSロジックとのズレ

**具体例**:
- 集計結果が違う（例: KPI統計の「商談中」の件数が旧UIと異なる）
- ステータス移行が違う（例: リードを「成約」にしても既存客に自動コピーされない）
- データ処理が違う（例: ソート順が旧UIと異なる）
- フィルタリングが違う（例: TODOの優先度フィルタが動かない）
- 計算式が違う（例: 成約率の計算式が旧UIと異なる）

**検知方法**:
1. **レガシーコードとの比較**:
   - `archive/phase9-legacy-js/tabs/*.ts` を読み、旧ロジックを確認
   - 新しい ViewModel Hook のロジックと比較
   - 差異を特定

2. **実際のデータでの検証**:
   - 同じデータを旧UI・新UIで表示し、結果を比較
   - 例: 見込み客数が旧UI「150件」、新UI「148件」 → 差異を調査

3. **ユニットテストの実装**:
   - ViewModel Hook の集計ロジックをユニットテストで検証
   - 期待値と実際の値を比較

**修正方法**:
1. 原因を特定（集計ロジック / フィルタリング / ソート / 計算式）
2. 旧JSロジックを参照して、正しいロジックに修正
3. ユニットテスト or E2E テストで動作確認

---

### 2.3 Next.js / React 特有の不具合（Framework Bugs）

**定義**: SSR/CSR、useEffect、依存関係、型エラーなどの不具合

**具体例**:
- SSR エラー（例: `window is not defined`）
- useEffect の無限ループ（例: 依存配列に関数を入れてしまった）
- 型エラー（例: API レスポンスの型が `any` になっている）
- ハイドレーションエラー（例: サーバーとクライアントで表示内容が異なる）
- メモリリーク（例: useEffect のクリーンアップ処理がない）

**検知方法**:
1. **コンソールのチェック**:
   - ブラウザの開発者ツールのコンソールを確認
   - 警告・エラーメッセージを確認

2. **ビルドログのチェック**:
   - `npm run build` の出力を確認
   - 警告・エラーメッセージを確認

3. **TypeScript のチェック**:
   - `npm run type-check` の出力を確認
   - 型エラーを確認

**修正方法**:
1. 原因を特定（SSR / useEffect / 型 / ハイドレーション）
2. Next.js / React のベストプラクティスに従って修正
3. `npm run build` / `npm run type-check` でエラーがなくなるまで修正

---

## 2.5 技術負債解消フレームワーク（Phase 9.92 からの引き継ぎ）

Phase 9.92 で先送りした技術負債を、Phase 9.93 で計画的に解消する。

### 2.5.1 コード分割戦略の実装

**目的**: 初期バンドルサイズの削減、ページロード時間の改善

**方針決定（二択）**:
- [ ] **Option A: `next/dynamic` による遅延ロード** - 既存のタブ構造を維持しつつ、重いコンポーネントを動的インポート
- [ ] **Option B: route 分割** - `/(app)/dashboard/[tab]/page.tsx` 形式でルーティング単位で分割

**実装対象（優先度順）**:

| タブ | 分割優先度 | 理由 | 対象コンポーネント |
|------|------------|------|-------------------|
| Reports | 高 | グラフライブラリ（recharts）が重い | `ReportsPage`, `ChartComponents` |
| ZoomScript | 高 | 動画プレビュー機能 | `ZoomScriptPage`, `VideoPreview` |
| Templates | 中 | エディタコンポーネント | `TemplatesPage`, `TemplateEditor` |
| LeanCanvas | 中 | キャンバス描画 | `LeanCanvasPage` |

**実装例（`next/dynamic` の場合）**:
```tsx
// app/(app)/reports/page.tsx
import dynamic from 'next/dynamic';

const ReportsContent = dynamic(
  () => import('@/app/_components/reports/ReportsContent'),
  {
    loading: () => <div className="loading-skeleton">読み込み中...</div>,
    ssr: false
  }
);

export default function ReportsPage() {
  return <ReportsContent />;
}
```

**完了条件**:
- [ ] 対象タブに `next/dynamic` が適用されている
- [ ] 初期バンドルサイズが Phase 9.92 比で 30% 以上削減
- [ ] Lighthouse Performance スコア 80 以上
- [ ] タブ切り替え時のユーザー体験が損なわれていない

---

### 2.5.2 RSC/SSR 部分導入 PoC

**目的**: Server Components の効果検証、将来の RSC 本格導入への布石

**対象**: Reports タブ（集計データ取得）

**PoC ステップ**:

1. **現状分析**
   - `useReportsViewModel()` 内のデータ取得を確認
   - API レスポンスサイズ、取得頻度を記録

2. **Server Action 移行**
```tsx
   // lib/actions/reports.ts
   'use server';

   export async function getReportsSummary() {
     // Supabase からデータ取得
     // クライアントに送るデータを最小化
   }
```

3. **Server Component 化**
```tsx
   // app/(app)/reports/page.tsx
   import { getReportsSummary } from '@/lib/actions/reports';

   export default async function ReportsPage() {
     const summary = await getReportsSummary();
     return <ReportsContent initialData={summary} />;
   }
```

4. **パフォーマンス比較**
   | 指標 | クライアントフェッチ | RSC |
   |------|---------------------|-----|
   | TTFB | __ms | __ms |
   | LCP | __ms | __ms |
   | バンドルサイズ | __KB | __KB |

5. **結果ドキュメント化**
   - `docs/RSC-POC-REPORT.md` に結果を記録
   - Phase 10 以降への適用判断

**★ PoC 成功/失敗の判断基準**:

| 判定 | 条件 | 次のアクション |
|------|------|---------------|
| **成功** | LCP が 20% 以上改善 AND バンドルサイズが 15% 以上削減 | Phase 10 で Dashboard, Clients にも適用 |
| **部分的成功** | LCP または バンドルサイズのどちらかが改善 | Reports タブのみ RSC を維持、他タブは保留 |
| **失敗** | 改善効果が見られない、または悪化 | RSC 導入を見送り、クライアントフェッチを維持 |

**★ PoC 失敗時の代替計画**:

RSC が期待した効果を発揮しない場合、以下の代替策を検討する：

1. **代替策A: SWR/React Query によるキャッシュ最適化**
   - クライアントサイドでのキャッシュ戦略を強化
   - `stale-while-revalidate` パターンでUXを改善
   ```tsx
   import useSWR from 'swr';

   export function useReportsViewModel() {
     const { data, error, isLoading } = useSWR('/api/reports/summary', fetcher, {
       revalidateOnFocus: false,
       dedupingInterval: 60000, // 1分間のキャッシュ
     });
     // ...
   }
   ```

2. **代替策B: Incremental Static Regeneration (ISR)**
   - 集計データを定期的に再生成（例: 5分ごと）
   - 即時性よりパフォーマンスを優先するユースケースに適用
   ```tsx
   export const revalidate = 300; // 5分
   ```

3. **代替策C: Edge Functions での集計**
   - Vercel Edge Functions で集計処理を実行
   - 地理的に近いサーバーでの処理で latency を削減

**代替策の選定基準**:
- データの鮮度要件（リアルタイム性が必要か）
- ユーザー数（同時アクセス数）
- インフラコスト

**完了条件**:
- [ ] Reports タブで RSC PoC が完了している
- [ ] パフォーマンス比較結果が記録されている
- [ ] `docs/RSC-POC-REPORT.md` が作成されている
- [ ] Phase 10 への RSC 展開計画が明確化されている
- [ ] PoC 失敗時の代替計画が文書化されている

---

### 2.5.3 CSS レイヤー出口戦略

**目的**: globals.css 肥大化の防止、スタイルのスコープ化

**方針決定（二択）**:
- [ ] **Option A: Tailwind CSS** - ユーティリティファーストで統一、既存のクラス名を段階的に置換
- [ ] **Option B: CSS Modules** - コンポーネント単位でスコープ化、`*.module.css` ファイルを作成

**判断基準**:

| 観点 | Tailwind | CSS Modules |
|------|----------|-------------|
| 学習コスト | 高（クラス名を覚える） | 低（従来のCSS） |
| バンドルサイズ | 小（未使用クラス削除） | 中（スコープ化のみ） |
| デザイン変更 | 容易（クラス組み合わせ） | やや手間（CSS編集） |
| 既存CSSとの親和性 | 低（書き直し必要） | 高（移動のみ） |

**推奨**: 短期的には **CSS Modules**、中長期的に **Tailwind** への移行を視野に入れる

**移行ステップ（CSS Modules の場合）**:

1. **新規コンポーネント**: CSS Modules で実装
```tsx
   // app/_components/dashboard/KPICards.module.css
   .card {
     border-radius: 12px;
     /* ... */
   }

   // app/_components/dashboard/KPICards.tsx
   import styles from './KPICards.module.css';
   <div className={styles.card}>
```

2. **既存コンポーネント**: 優先度順に移行
   | コンポーネント | globals.css 行範囲 | 移行優先度 |
   |---------------|-------------------|-----------|
   | KPICards | Line XX-XX | 高 |
   | ConversionFunnel | Line XX-XX | 高 |
   | LeadKanban | Line XX-XX | 中 |

3. **globals.css の整理**: 移行完了後、該当ブロックを削除

**完了条件**:
- [ ] CSS 移行方針（Tailwind or CSS Modules）が決定されている
- [ ] 新規コンポーネントは選択した方式で実装されている
- [ ] globals.css のレガシーCSSブロックが 50% 以上削減されている
- [ ] クラス名衝突が発生していない

---

## 3. タブ別バグ診断シナリオ

各タブについて、以下のシナリオでバグを診断します。

### 3.1 ダッシュボードタブ

#### UI差異チェック

**シナリオ**:
1. ダッシュボードにアクセス
2. KPI統計カードの色・サイズ・配置を確認
3. コンバージョンファネルの色・プログレスバーの高さを確認
4. OKR進捗サマリーの表示を確認
5. TODO上位5件の表示を確認
6. 失注理由TOP3の色・プログレスバーを確認
7. アプローチ管理の表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

#### ロジック差異チェック

**シナリオ**:
1. テストデータを準備（見込み客10件、既存客5件）
2. ダッシュボードにアクセス
3. KPI統計の数値を確認
4. 手動で集計した結果と照合

**期待値**:
- 見込み客数、商談中、成約数、成約率が正しく計算される

#### Next.js / React 特有の不具合チェック

**シナリオ**:
1. ダッシュボードにアクセス
2. ブラウザのコンソールを確認
3. `npm run build` を実行してログを確認

**期待値**:
- コンソールに警告・エラーが出ない
- ビルドに警告・エラーが出ない

---

### 3.2 見込み客管理タブ（Leads）

#### UI差異チェック

**シナリオ**:
1. `/leads` にアクセス
2. リストビュー / カンバンビューの切り替えを確認
3. 各カラム（未接触・反応あり・商談中・成約）の色・サイズを確認
4. 見込み客カードの表示を確認
5. 追加フォームの表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

#### ロジック差異チェック

**シナリオ**:
1. 見込み客を追加
2. ステータスを変更（未接触 → 反応あり → 商談中 → 成約）
3. 失注に変更 → `/leads/lost` に表示されることを確認
4. 成約に変更 → `/clients` に表示されることを確認

**期待値**:
- ステータス変更がすべて正しく動作する
- 失注・成約の自動連携が動作する

#### Next.js / React 特有の不具合チェック

**シナリオ**:
1. `/leads` にアクセス
2. ブラウザのコンソールを確認
3. ドラッグ&ドロップを実行 → エラーが出ないことを確認

**期待値**:
- コンソールに警告・エラーが出ない

---

### 3.3 既存客管理タブ（Clients）

#### UI差異チェック

**シナリオ**:
1. `/clients` にアクセス
2. カルテ一覧の表示を確認
3. 次回ミーティング・契約期限の色分け表示を確認
4. 取引履歴の表示を確認
5. カルテ展開/折りたたみを確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

#### ロジック差異チェック

**シナリオ**:
1. 既存客を編集
2. 次回ミーティングを3日後に設定 → 黄色になることを確認
3. 次回ミーティングを過去の日付に設定 → 赤色になることを確認
4. 契約期限を30日後に設定 → 黄色になることを確認
5. 契約期限を過去の日付に設定 → 赤色になることを確認

**期待値**:
- 色分けがすべて正しく動作する

#### Next.js / React 特有の不具合チェック

**シナリオ**:
1. `/clients` にアクセス
2. ブラウザのコンソールを確認
3. 編集フォームを開閉 → エラーが出ないことを確認

**期待値**:
- コンソールに警告・エラーが出ない

---

### 3.4 MVV・OKRタブ

#### UI差異チェック

**シナリオ**:
1. `/mvv` にアクセス
2. MVV（Mission, Vision, Value）の表示を確認
3. OKR（Objective, Key Results）の表示を確認
4. 進捗バーの表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

#### ロジック差異チェック

**シナリオ**:
1. Objective を編集
2. Key Result を編集
3. 進捗が正しく計算されることを確認

**期待値**:
- 進捗計算が正しく動作する

---

### 3.5 ブランド指針タブ

#### UI差異チェック

**シナリオ**:
1. `/brand` にアクセス
2. Core Message の表示を確認
3. Tone & Manner の表示を確認
4. Words to Use / Avoid の表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

---

### 3.6 リーンキャンバスタブ

#### UI差異チェック

**シナリオ**:
1. `/lean` にアクセス
2. 9ブロックの表示を確認
3. 商品ラインナップの表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

---

### 3.7 TODO管理タブ

#### UI差異チェック

**シナリオ**:
1. `/todo` にアクセス
2. TODO一覧の表示を確認
3. 優先度アイコンの表示を確認
4. 期限の色分け表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

#### ロジック差異チェック

**シナリオ**:
1. TODOを追加
2. 優先度を設定
3. 期限を設定
4. ソート順を確認

**期待値**:
- ソート順が旧UIと一致する

---

### 3.8 Zoom会議タブ

#### UI差異チェック

**シナリオ**:
1. `/zoom-script` にアクセス
2. エモーション選択UIの表示を確認
3. スクリプト表示エリアを確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

---

### 3.9 テンプレート集タブ

#### UI差異チェック

**シナリオ**:
1. `/templates` にアクセス
2. テンプレート一覧の表示を確認
3. カテゴリ別表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

---

### 3.10 レポートタブ

#### UI差異チェック

**シナリオ**:
1. `/reports` にアクセス
2. 統計グラフの表示を確認
3. 表の表示を確認

**期待値**:
- すべて旧UIとスクリーンショット比較で95%以上一致する

#### ロジック差異チェック

**シナリオ**:
1. レポートを生成
2. 手動で計算した結果と照合

**期待値**:
- 統計が正しく計算される

---

## 4. バグ修正ワークフロー

### 4.1 バグ発見から修正までのフロー

```
1. バグ発見
   ↓
2. バグ分類（UI / ロジック / Next.js固有）
   ↓
3. 原因の切り分け
   ↓
4. 修正方針の決定
   ↓
5. 修正実装
   ↓
6. 検証
   ↓
7. DOD チェック
```

### 4.2 原因の切り分け手順

#### ステップ1: バグの再現

1. バグが発生する操作を特定
2. 再現手順を記録
3. スクリーンショット・動画を撮影

#### ステップ2: レイヤの特定

バグがどのレイヤで発生しているか特定：

- **UI レイヤ**: 見た目の問題（色・サイズ・レイアウト）
- **ViewModel レイヤ**: ロジックの問題（集計・フィルタ・ソート）
- **API レイヤ**: API の問題（レスポンスの型・エラーハンドリング）
- **データレイヤ**: データベースの問題（データの不整合）

#### ステップ3: コードの確認

1. 該当するコンポーネント / Hook を確認
2. 旧JSコード（`archive/phase9-legacy-js/tabs/*.ts`）と比較
3. 差異を特定

#### ステップ4: ログの確認

1. ブラウザのコンソールを確認
2. サーバーログを確認（`vercel logs` or ローカルサーバーログ）
3. エラーメッセージを記録

### 4.3 修正方針の決定

#### UI差異の場合

1. 旧UIのCSSをコピー
2. コンポーネントのスタイルを修正
3. CSS変数を確認

#### ロジック差異の場合

1. 旧JSロジックを参照
2. ViewModel Hook のロジックを修正
3. ユニットテストを実装

#### Next.js / React 特有の不具合の場合

1. Next.js / React のベストプラクティスを確認
2. useEffect の依存配列を修正
3. SSR エラーを回避（`typeof window !== 'undefined'` ガード）

### 4.4 修正実装のガイドライン

#### 既存Next.js構成を壊さない範囲での対応

1. **ViewModel Hook への統合**:
   - ロジック修正は必ず ViewModel Hook 内で実施
   - UI コンポーネントはロジックを持たない

2. **型定義の整備**:
   - API レスポンスの型は `lib/types/*.ts` で定義
   - `any` を使わない（やむを得ない場合は `// TODO: 型を具体化` を付ける）

3. **コンポーネント構造の維持**:
   - 既存のコンポーネント構造を変えない
   - 新しいコンポーネントを追加する場合は、`app/_components/` 以下に配置

4. **CSS変数の活用**:
   - `app/globals.css` の `:root` 変数を活用
   - インラインスタイルは最小限にする

### 4.5 検証手順

#### ステップ1: ローカル環境での確認

1. `npm run dev` でローカルサーバーを起動
2. 修正箇所を確認
3. 旧UIとスクリーンショット比較

#### ステップ2: ビルド確認

1. `npm run build` を実行
2. 警告・エラーがないことを確認

#### ステップ3: 型チェック

1. `npm run type-check` を実行
2. エラーがないことを確認

#### ステップ4: E2Eテスト

1. `npm run test:e2e` を実行
2. 関連するテストが Pass することを確認

#### ステップ5: ブラウザでの動作確認

1. 複数のブラウザ（Chrome, Firefox, Safari）で確認
2. レスポンシブ（モバイル・タブレット・デスクトップ）で確認

### 4.6 DOD チェック

修正が完了したら、以下のチェックリストを確認：

- [ ] UI が旧UIと95%以上一致する
- [ ] ロジックが旧JSロジックと100%一致する
- [ ] `npm run build` が警告ゼロで成功する
- [ ] `npm run type-check` がエラーゼロで成功する
- [ ] E2E テストが Pass する
- [ ] コンソールに警告・エラーが出ない

---

## 5. 完了条件（Definition of Done）

Phase 9.93 を「完了」とみなす条件：

### 5.1 UI要件

- [ ] すべてのタブが旧UIとスクリーンショット比較で95%以上一致する
- [ ] レスポンシブデザインが正しく動作する（モバイル・タブレット・デスクトップ）
- [ ] ガラスモーフィズム効果が正しく適用されている
- [ ] ホバー・フォーカス・アニメーションが旧UIと一致する
- [ ] すべての色が CSS変数（`var(--primary)` など）で定義されている
- [ ] すべてのサイズが旧UIの基準値と一致する

### 5.2 ロジック要件

- [ ] 旧JSロジック（`archive/phase9-legacy-js/tabs/*.ts`）と動作が100%一致する
- [ ] すべてのデータ集計（KPI・ファネル・失注理由など）が正しい
- [ ] ステータス遷移（リード・クライアント）が旧UIと同じ挙動をする
- [ ] すべてのフィルタリング・ソートが旧UIと同じ挙動をする
- [ ] すべての計算式（成約率・進捗率など）が正しい

### 5.3 技術要件

- [ ] `npm run build` が警告ゼロで成功する
- [ ] `npm run type-check` がエラーゼロで成功する
- [ ] すべての E2E テスト（既存 + 新規）が Pass する
- [ ] console に警告・エラーが出ない（開発環境・本番環境）
- [ ] API レスポンスの型が `lib/types/*.ts` で定義されている
- [ ] `any` 型を使用していない（やむを得ない場合は `// TODO: 型を具体化` を付ける）

### 5.4 Phase 9.9 残務要件

- [ ] リードステータス刷新が完全動作する（4カラム表示）
- [ ] 失注タブが正しく動作する（`/leads/lost`）
- [ ] 成約→既存客の自動連携が動作する
- [ ] SAタブが正しく表示・動作する（`/admin/sa`）
- [ ] 3-2-1 ルール（権限階層）が UI で強制される
- [ ] すべての E2E テストが Pass する

### 5.5 Phase 9.91 残務要件

- [ ] レガシーコードが完全隔離されている（`js/` フォルダが存在しない）
- [ ] ルートディレクトリが整理されている（ファイル数が 15個以下）
- [ ] `DOCS/` が `docs/` にリネームされている
- [ ] パス参照が正しい（旧パス `from '../../js/...'` が存在しない）

### 5.6 ドキュメント要件

- [ ] すべてのバグ修正が記録されている（バグ修正ログ）
- [ ] すべての ViewModel Hook がドキュメント化されている
- [ ] すべての API エンドポイントがドキュメント化されている

### 5.7 パフォーマンス要件

- [ ] ページ読み込み時間が旧UI以下である
- [ ] API レスポンス時間が旧UI以下である
- [ ] メモリリークが発生していない

### 5.8 技術負債解消要件（新規）

- [ ] コード分割戦略が実装されている（`next/dynamic` または route 分割）
- [ ] 初期バンドルサイズが Phase 9.92 比で 30% 以上削減されている
- [ ] Lighthouse Performance スコアが 80 以上である
- [ ] RSC PoC が完了し、`docs/RSC-POC-REPORT.md` が作成されている
- [ ] CSS 移行方針が決定され、新規実装に適用されている
- [ ] globals.css のレガシーCSSブロックが 50% 以上削減されている
- [ ] `docs/TECH-DEBT-INVENTORY.md` の技術負債が 50% 以上解消されている

### 5.9 UAT（ユーザー受入テスト）要件（分析レポートからの提言）

**背景**:
Phase 9.92/9.93 は「旧仕様の完全再現」を目指しているが、もし旧仕様自体に使いにくさやバグがあった場合、それも忠実に再現されてしまう。
そのため、単なる「バグ修正」だけでなく、**実際の業務フローでの試用（UAT）** を明示的に組み込む。

**★ 承認体制（CODEXレビュー対応）**:

| 役割 | 担当者 | 責務 |
|------|--------|------|
| **UAT承認者** | プロジェクトオーナー（PO）/ 望月 | 最終サインオフ、Phase 10 移行許可 |
| **UAT実施者** | 実際のエンドユーザー（営業担当者など） | 業務フローでの試用、フィードバック提供 |
| **UAT記録者** | Phase 9.93 リード担当 | `docs/UAT-FEEDBACK.md` への記録、優先度判断 |

**サインオフ手順**:
1. UAT実施者が全シナリオを試用
2. フィードバックを `docs/UAT-FEEDBACK.md` に記録
3. UAT記録者が重大度を判定（Critical / Major / Minor）
4. Critical / Major は Phase 9.93 内で修正
5. **UAT承認者がサインオフ**（日付・署名を `docs/UAT-FEEDBACK.md` 末尾に記載）
6. サインオフ完了後、Phase 10 移行可能

**完了条件**:
- [ ] 実際の業務フロー（リード登録→商談→成約→既存客管理）を通しで試用している
- [ ] 「旧仕様通り動いているが、Reactになったら使いにくい」部分を洗い出している
- [ ] ステークホルダー（実際のユーザー）からフィードバックを収集している
- [ ] 発見されたUX改善点が `docs/UAT-FEEDBACK.md` に文書化されている
- [ ] 重大なUX問題は Phase 9.93 内で修正、軽微な問題は Phase 10 以降で対応と判断されている
- [ ] **UAT承認者のサインオフが完了している**

**UATシナリオ（全10タブ網羅版）**:

| # | タブ | シナリオ名 | 具体的な操作手順 | 確認ポイント |
|---|------|-----------|-----------------|-------------|
| 1 | **Dashboard** | KPI確認フロー | ダッシュボードを開く → KPI統計を確認 → ファネル分析を確認 → TODO上位5件を確認 | 数値が正しく集計されているか |
| 2 | **Leads** | リード管理フロー | 新規リード登録 → ステータス変更（未接触→反応あり→商談中） → タグ追加 → 履歴追加 | ステータス変更がサーバーに保存されるか |
| 3 | **Leads** | 失注フロー | リードを「失注」に変更 → 失注アンケート入力 → `/leads/lost` で確認 → 敗者復活 | 失注アンケートが記録されるか |
| 4 | **Leads** | 成約フロー | リードを「成約」に変更 → `/clients` に自動コピーされることを確認 | 既存客への自動連携が動作するか |
| 5 | **Clients** | 既存客管理フロー | 既存客を編集 → 契約期限設定 → 次回ミーティング登録 → メモ追加 | 色分け表示が正しく動作するか |
| 6 | **MVV** | MVV編集フロー | Mission を編集 → Vision を編集 → Values を編集 → 保存 | 編集内容が正しく保存されるか |
| 7 | **MVV** | OKR編集フロー | Objective を編集 → Key Result を追加 → 進捗を更新 | 進捗計算が正しく動作するか |
| 8 | **Brand** | ブランド指針編集 | Core Message を編集 → Tone & Manner を編集 → Words to Use/Avoid を編集 | 編集内容が正しく保存されるか |
| 9 | **Lean** | リーンキャンバス編集 | 9ブロックを編集 → 商品を追加 → 商品を編集 → 商品を削除 | CRUD操作が正しく動作するか |
| 10 | **TODO** | TODO管理フロー | TODOを追加 → 優先度・期限を設定 → TODOを完了 → TODOを削除 | ソート順が正しいか |
| 11 | **Zoom** | スクリプト生成 | エモーションを選択 → スクリプト生成 → スクリプトをコピー | スクリプトが正しく生成されるか |
| 12 | **Templates** | テンプレート管理 | テンプレートを追加 → テンプレートを編集 → 使用履歴を確認 | 使用履歴が記録されるか |
| 13 | **Reports** | レポート確認 | アプローチ統計を確認 → コンバージョン率推移を確認 → 失注分析を確認 | グラフが正しく表示されるか |
| 14 | **Settings** | 設定変更 | プロフィール編集 → パスワード変更 → 通知設定変更 | 設定が正しく保存されるか |

**シナリオ実行チェックリスト**:
- [ ] シナリオ 1: Dashboard KPI確認フロー
- [ ] シナリオ 2: Leads リード管理フロー
- [ ] シナリオ 3: Leads 失注フロー
- [ ] シナリオ 4: Leads 成約フロー
- [ ] シナリオ 5: Clients 既存客管理フロー
- [ ] シナリオ 6: MVV MVV編集フロー
- [ ] シナリオ 7: MVV OKR編集フロー
- [ ] シナリオ 8: Brand ブランド指針編集
- [ ] シナリオ 9: Lean リーンキャンバス編集
- [ ] シナリオ 10: TODO TODO管理フロー
- [ ] シナリオ 11: Zoom スクリプト生成
- [ ] シナリオ 12: Templates テンプレート管理
- [ ] シナリオ 13: Reports レポート確認
- [ ] シナリオ 14: Settings 設定変更

**`docs/UAT-FEEDBACK.md` テンプレート**:
```markdown
# UAT フィードバック記録

## 実施情報
- 実施日: YYYY-MM-DD
- 実施者: [名前]
- 対象環境: [URL]

## フィードバック一覧

| # | シナリオ | 発見事項 | 重大度 | 対応フェーズ | ステータス |
|---|---------|---------|--------|-------------|-----------|
| 1 | リード管理 | ... | Major | 9.93 | 修正済み |
| 2 | ダッシュボード | ... | Minor | 10 | 未対応 |

## サインオフ
- [ ] UAT承認者サインオフ
- 承認者: ________________
- 日付: YYYY-MM-DD
- コメント:
```

---

## 6. 次フェーズへの接続（Phase 10）

### 6.1 Phase 9.93 完了後の状態

Phase 9.93 が完了すると、以下の状態になります：

**機能面**:
- ✅ すべてのタブが React に完全移行されている
- ✅ UI が旧UIと完全一致している
- ✅ ロジックが旧JSロジックと完全一致している
- ✅ Phase 9.9 / 9.91 の残務がすべて処理されている
- ✅ バグが完全にゼロである
- ✅ UAT（ユーザー受入テスト）が完了している

**パフォーマンス面**:
- ✅ 初期バンドルサイズが 30% 以上削減されている
- ✅ Lighthouse Performance スコアが 80 以上である
- ✅ 重いタブに `next/dynamic` が適用されている

**将来拡張性**:
- ✅ RSC PoC が完了し、Phase 10 以降への適用方針が明確化されている
- ✅ CSS 移行方針が決定し、新規実装に適用されている
- ✅ 技術負債インベントリが 50% 以上解消されている
- ✅ UATフィードバックが文書化され、Phase 10 での改善計画に反映されている

### 6.2 Phase 10 への引き継ぎ事項

**UATフィードバックの活用**:
- UATで発見された軽微なUX改善点を Phase 10 で対応
- `docs/UAT-FEEDBACK.md` を参照し、優先度順に改善を実施

**RSC 展開計画**:
- RSC PoC の結果に基づき、効果があった場合は他タブにも適用
- 優先順位: Reports → Dashboard → Clients

**CSS 移行の残作業**:
- globals.css の残り 50% を Phase 10 で段階的に移行
- 新規機能は選択した方式（Tailwind or CSS Modules）で実装

**TODO機能との統合**:
- `docs/PHASE10-TODO-ELASTIC-RUNBOOK.md` を参照
- Elastic Search 統合時に RSC を活用する余地あり

**Phase 10 開始前の確認**:
- [ ] Phase 9.93 の DOD がすべて満たされている
- [ ] `docs/PHASE10-TODO-ELASTIC-RUNBOOK.md` が存在する
- [ ] Phase 10 の要件が明確である

---

## 7. FDC-GRAND-GUIDE 更新テンプレート

Phase 9.93 完了時に `docs/FDC-GRAND-GUIDE.md` を以下のように更新してください：

```markdown
### Phase 9.9: 緊急バグ修正 & ガバナンス強化
**ステータス**: ✅ 完了
**目的**: 権限・リード管理・SAタブの実装
**残務**: Phase 9.93 で検証完了

### Phase 9.91: 大規模クリーンアップ & 構造改革
**ステータス**: ✅ 完了
**目的**: レガシーコード隔離、ドキュメント標準化
**残務**: Phase 9.93 で検証完了

### Phase 9.92: 全タブ再生プロジェクト
**ステータス**: ✅ 完了（全10タブReact移行完了）
**目的**: 旧UI完全再現 + 全10タブのReact/ViewModel化
**成果**: ダッシュボード、Leads、Clients、MVV、Brand、Lean、TODO、Zoom、Templates、Reportsの全タブが稼働

### Phase 9.93: 最終バグ修正 & 完全整合性確保
**ステータス**: ✅ 完了
**目的**: UI差異・ロジック差異・Next.js固有バグをゼロ化
**成果**:
- すべてのタブが旧UIと完全一致
- Phase 9.9/9.91 の残務すべて完了
- `npm run build` / `npm run type-check` エラーゼロ
- E2E テストすべて Pass

### Phase 10: TODO機能本格実装（Elastic Search統合）
**ステータス**: 🚧 実装中
**目的**: TODO管理の高度化、Elastic Action Map実装
**次のステップ**: `docs/PHASE10-TODO-ELASTIC-RUNBOOK.md` を参照
```

---

## 8. バグ修正ログ（記録用テンプレート）

Phase 9.93 で修正したバグは、以下のフォーマットで記録します。

### バグ修正ログテンプレート

```markdown
## バグ #001

**発見日**: 2025-11-25
**タブ**: ダッシュボード
**分類**: UI差異
**重要度**: 高

**症状**:
- KPI統計カードの角丸が `8px` になっている（正しくは `12px`）

**原因**:
- `app/_components/dashboard/KPICards.tsx` のスタイルで `rounded-lg` を使用していた
- Tailwind の `rounded-lg` は `8px` なので、`12px` にするには `rounded-xl` を使う必要がある

**修正内容**:
- `rounded-lg` を `rounded-xl` に変更

**検証結果**:
- ✅ スクリーンショット比較で差異なし
- ✅ `npm run build` 成功
- ✅ `npm run type-check` 成功

**関連ファイル**:
- `app/_components/dashboard/KPICards.tsx`
```

---

## 9. Claude Code への指示テンプレート

### Phase 9.93 キックオフ用

```markdown
あなたは Founders Direct Cockpit (FDC) プロジェクトの Phase 9.93 担当エンジニアです。

【状況】
Phase 9.92（全タブ再生）が完了しました。
Phase 9.93 では、Phase 9.92 で移行したすべてのタブについて、UI差異・ロジック差異・Next.js固有の不具合をゼロにします。

また、Phase 9.9 / 9.91 の残務もすべて処理します。

【作業指示】
1. `/Users/5dmgmt/プラグイン/foundersdirect` をプロジェクトルートとする
2. `docs/PHASE9.93-BUGFIX-RUNBOOK.md` を参照
3. 「3. タブ別バグ診断シナリオ」に従って、すべてのタブを診断する
4. 発見したバグを「2. バグ分類フレームワーク」に従って分類する
5. 「4. バグ修正ワークフロー」に従って、バグを修正する
6. 「5. 完了条件（DOD）」を満たすまで修正を繰り返す

【完了レポート】
バグ修正完了時に以下を報告：
- 修正したバグの数（UI差異 / ロジック差異 / Next.js固有）
- 修正内容の詳細（バグ修正ログ）
- DOD チェック結果
- Phase 10 への移行準備完了確認
```

### バグ修正個別タスク用

```markdown
あなたは FDC Phase 9.93 担当エンジニアです。

【バグ情報】
- タブ: ダッシュボード
- 分類: UI差異
- 症状: KPI統計カードの角丸が `8px` になっている（正しくは `12px`）

【作業指示】
1. 原因を特定してください
2. 修正方針を提案してください
3. 修正を実装してください
4. 検証してください（スクリーンショット比較・ビルド・型チェック）
5. バグ修正ログを記録してください

【完了レポート】
修正完了時に以下を報告：
- 原因
- 修正内容
- 検証結果
- バグ修正ログ
```

---

## 10. 残務引き継ぎ一覧表

### 10.1 タスク依存関係図

以下の図は、Phase 9.93 内のタスク間の依存関係を示します。依存関係がある場合は、先行タスクを完了してから後続タスクに着手してください。

```
┌─────────────────────────────────────────────────────────────────┐
│                     Phase 9.93 タスク依存関係図                    │
└─────────────────────────────────────────────────────────────────┘

【Phase 9.91 残務】                    【Phase 9.9 残務】
      │                                      │
      ▼                                      ▼
┌─────────────┐                      ┌─────────────┐
│   CL-01     │──────┐               │   FIX-01    │
│  Legacy     │      │               │  Admin Role │
│ Archiving   │      │               └──────┬──────┘
└─────────────┘      │                      │
      │              │                      ▼
      ▼              │               ┌─────────────┐
┌─────────────┐      │               │   GOV-05    │
│   CL-02     │      │               │  3-2-1 Rule │
│   Root      │      │               └──────┬──────┘
│  Cleaning   │      │                      │
└─────────────┘      │                      │
      │              │                      │
      ▼              │       ┌──────────────┼──────────────┐
┌─────────────┐      │       │              │              │
│   CL-03     │      │       ▼              ▼              ▼
│    Docs     │      │  ┌─────────┐   ┌─────────┐   ┌─────────┐
│  Renaming   │      │  │  L-01   │   │  C-01   │   │ GOV-04  │
└─────────────┘      │  │  Lead   │   │   Won   │   │   SA    │
      │              │  │ Status  │   │Transition│  │Dashboard│
      ▼              │  └────┬────┘   └────┬────┘   └─────────┘
┌─────────────┐      │       │              │
│   CL-04     │◀─────┘       ▼              ▼
│   Config    │         ┌─────────┐   ┌─────────┐
│   Update    │         │  L-02   │   │  C-02   │
└──────┬──────┘         │  Lost   │   │Contract │
       │                │   Tab   │   │  Date   │
       │                └─────────┘   └─────────┘
       │                      │              │
       │                      └──────┬───────┘
       │                             │
       ▼                             ▼
┌─────────────────────────────────────────────┐
│                  TEST-01                     │
│           E2E Verification                   │
│    (すべての機能タスク完了後に実施)            │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│              Phase 9.92 バグ修正             │
│   UI差異 → ロジック差異 → Next.js固有        │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│            技術負債解消（2.5節）              │
│  コード分割 → RSC PoC → CSS移行              │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│              UAT（5.9節）                    │
│   全タスク完了後、最終ユーザー受入テスト       │
└─────────────────────────────────────────────┘
```

### 10.2 推奨実行順序

| 順序 | タスクID | タスク名 | 依存先 | 推定工数 |
|------|---------|---------|--------|---------|
| 1 | CL-01 | Legacy Archiving | なし | 0.5h |
| 2 | CL-02 | Root Cleaning | CL-01 | 0.5h |
| 3 | CL-03 | Docs Renaming | CL-02 | 0.5h |
| 4 | CL-04 | Config Update | CL-01, CL-03 | 1h |
| 5 | FIX-01 | Admin Role Fix | なし | 1h |
| 6 | GOV-05 | 3-2-1 Rule | FIX-01 | 2h |
| 7 | L-01 | Lead Status | GOV-05 | 2h |
| 8 | L-02 | Lost Tab | L-01 | 2h |
| 9 | C-01 | Won Transition | GOV-05 | 2h |
| 10 | C-02 | Contract Date | C-01 | 1h |
| 11 | GOV-04 | SA Dashboard | GOV-05 | 2h |
| 12 | TEST-01 | E2E Verification | L-02, C-02, GOV-04 | 4h |
| 13 | - | UI差異修正 | TEST-01 | 8h |
| 14 | - | ロジック差異修正 | UI差異修正 | 4h |
| 15 | - | Next.js固有修正 | ロジック差異修正 | 4h |
| 16 | - | コード分割 | Next.js固有修正 | 4h |
| 17 | - | RSC PoC | コード分割 | 8h |
| 18 | - | CSS移行 | RSC PoC | 4h |
| 19 | - | UAT 実施 | CSS移行 | 8h |

### 10.3 Phase 9.9 から Phase 9.93 への引き継ぎ

| タスクID | タスク名 | 元の Phase | Phase 9.93 での扱い | 優先度 | 依存先 |
|---------|---------|-----------|-------------------|-------|--------|
| **FIX-01** | Admin Role Fix | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 高 | なし |
| **L-01** | Lead Status | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 高 | GOV-05 |
| **L-02** | Lost Tab | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 中 | L-01 |
| **C-01** | Won Transition | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 高 | GOV-05 |
| **C-02** | Contract Date | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 中 | C-01 |
| **GOV-04** | SA Dashboard | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 中 | GOV-05 |
| **GOV-05** | 3-2-1 Rule | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で検証・修正 | 高 | FIX-01 |
| **TEST-01** | E2E Verification | Phase 9.9 | 「1.1 Phase 9.9 残務の統合」で実装・実行 | 高 | L-02, C-02, GOV-04 |

### 10.4 Phase 9.91 から Phase 9.93 への引き継ぎ

| タスクID | タスク名 | 元の Phase | Phase 9.93 での扱い | 優先度 | 依存先 |
|---------|---------|-----------|-------------------|-------|--------|
| **CL-01** | Legacy Archiving | Phase 9.91 | 「1.2 Phase 9.91 残務の統合」で検証・確認 | 中 | なし |
| **CL-02** | Root Cleaning | Phase 9.91 | 「1.2 Phase 9.91 残務の統合」で検証・確認 | 中 | CL-01 |
| **CL-03** | Docs Renaming | Phase 9.91 | 「1.2 Phase 9.91 残務の統合」で検証・確認 | 低 | CL-02 |
| **CL-04** | Config Update | Phase 9.91 | 「1.2 Phase 9.91 残務の統合」で検証・確認 | 中 | CL-01, CL-03 |

### 10.5 Phase 9.92 から Phase 9.93 への引き継ぎ（バグ修正対象）

| カテゴリ | タスク | Phase 9.93 での扱い | 優先度 | 依存先 |
|---------|-------|-------------------|-------|--------|
| **UI差異** | 全10タブのスクリーンショット比較 | 「2.1 UI差異」で修正 | 高 | TEST-01 |
| **ロジック差異** | 全10タブのロジック検証 | 「2.2 ロジック差異」で修正 | 高 | UI差異修正 |
| **Next.js固有** | SSR/CSR、useEffect、型エラー修正 | 「2.3 Next.js / React 特有の不具合」で修正 | 高 | ロジック差異修正 |

---

**最終更新:** 2025-11-25
**次のアクション**: Phase 9.92 完了後、Phase 9.93 を開始する
