# Phase 9.9 ランブック：緊急バグ修正 & ガバナンス強化 v3.0（Phase 9.93 統合版）

**最終更新:** 2025-11-25
**ステータス:** ✅ **完了（クローズ済み）**
**フェーズ役割**: 緊急バグ修正 & ガバナンス強化（権限・リード管理・SAタブ）

---

## ⚠️ 重要なお知らせ

**Phase 9.9 は正式に完了しました。本フェーズはクローズ済みです。**

このフェーズで定義されたタスクのうち、**未処理の残務はすべて Phase 9.92（全タブ再生）および Phase 9.93（最終バグ修正）へ引き継がれます。**

### 残務の引き継ぎ先

- **UI/ロジック系の残務** → **Phase 9.92（全タブ再生プロジェクト）** に統合
  - リードステータス刷新（L-01）
  - 失注タブ実装（L-02）
  - 成約→既存客フロー（C-01, C-02）
  - SAダッシュボード（GOV-04）

- **バグ修正・整合性チェック系** → **Phase 9.93（最終バグ修正フェーズ）** に統合
  - Admin Role Fix（FIX-01）
  - 3-2-1 Rule 検証（GOV-05）
  - E2E テスト実装（TEST-01）

本ランブックは記録として保持し、残務管理は Phase 9.92 / 9.93 で実施します。

### Phase 9.9 → Phase 9.93 の引き継ぎ内容

Phase 9.9 で定義された以下の 8つのタスクは、Phase 9.93 で完全に処理されます：

| タスクID | タスク名 | Phase 9.93 での扱い |
|---------|---------|-------------------|
| **FIX-01** | Admin Role Fix | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **L-01** | Lead Status | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **L-02** | Lost Tab | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **C-01** | Won Transition | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **C-02** | Contract Date | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **GOV-04** | SA Dashboard | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **GOV-05** | 3-2-1 Rule | 「1.1 Phase 9.9 残務の統合」で検証・修正 |
| **TEST-01** | E2E Verification | 「1.1 Phase 9.9 残務の統合」で実装・実行 |

### 次のアクション

Phase 9.9 の残務を処理する場合は、**Phase 9.93 ランブック**（`docs/PHASE9.93-BUGFIX-RUNBOOK.md`）を参照してください。

---

## 1. 目的と緊急性（アーカイブ）

Phase 10（TODO機能）開始直前ですが、**「管理者がログアウトできない（設定画面が出ない）」** というクリティカルなバグが発覚しました。また、組織運営に必要な **「リード管理フローの刷新」** と **「厳格な権限階層（ガバナンス）」** の実装が必要となりました。

本フェーズは **緊急対応** として最優先で実行し、E2Eテストで品質を担保した上で Phase 10 へ移行します。

### 1.1 対応する課題（4つの柱）

1.  **権限バグ修正 (Critical)**: `admin@example.com` および一般ユーザーのUI表示不具合を解消。
2.  **リード管理刷新**: 4ステータス制への移行と「失注」の分離。
3.  **成約フロー**: リード成約 → 既存客（契約日管理）への移行プロセス確立。
4.  **SAガバナンス**: スーパーアドミンによる全監視と、3-2-1ルールによる権限階層の強制。

---

## 2. タスクカタログ（アーカイブ）

| ID | タスク名 | 目的/課題 | 実装内容 | 完了指標 (Metric) | Phase 9.93 での扱い |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **FIX-01** | **Admin Role Fix** | 設定画面消失バグ修正 | `Sidebar` 表示ロジック修正 + Admin Seed 再実行 | **全ユーザーで設定タブが表示される** | 検証・修正 |
| **L-01** | **Lead Status** | プロセス最適化 | ステータスを「未接触/反応あり/商談中/成約」の4つに限定 | **カンバンが4列になる** | 検証・修正 |
| **L-02** | **Lost Tab** | 失注データの分離 | 新規タブ `/leads/lost` の作成 | **失注リードが別画面で管理できる** | 検証・修正 |
| **C-01** | **Won Transition** | 成約→顧客の連携 | WON 時に Clients テーブルへコピー作成 | **成約すると顧客一覧に増える** | 検証・修正 |
| **C-02** | **Contract Date** | 正式顧客の定義 | Clients に `contract_date` 追加 | **契約日保存で正式顧客化** | 検証・修正 |
| **GOV-04** | **SA Dashboard** | リアルタイム監視 | 全ユーザーの「現在ログイン中のWS」一覧表示 | **SAタブで全稼働状況が見える** | 検証・修正 |
| **GOV-05** | **3-2-1 Rule** | 権限階層の強制 | ロール間操作制限ロジック (`canManageRole`) 実装 | **ManagerがExecを招待できない** | 検証・修正 |
| **TEST-01** | **E2E Verification** | 品質担保 | 権限・リード遷移・ガバナンスの自動テスト実装 | **新規テストが全て Pass する** | 実装・実行 |

---

## 3. サブフェーズ構成（アーカイブ）

### Phase 9.9-A: 権限・表示バグ修正 (Critical)

**目的**: システム利用の前提となる「設定アクセス」と「ログアウト」を可能にする。

**タスク**:
1.  **Seed Fix**: `scripts/seed-admin.ts` を修正・実行し、`admin@example.com` を確実に `fdc_admin` (Global Role) に設定する。
2.  **UI Logic Fix**: `app/_components/Sidebar.tsx` (またはLayout) を修正。
    - `Settings` (設定): **Global Role / Workspace Role に関わらず全員表示**。
    - `Admin` (管理者): `global_role === 'fdc_admin'` の場合のみ表示。
    - `SA` (スーパーアドミン): `global_role === 'fdc_admin'` の場合のみ表示。

**DOD**:
- [ ] `mochizuki` アカウントで「設定」「管理者」タブが見え、ログアウトできる。
- [ ] `gmail` 一般アカウントで「設定」タブが見える（「管理者」は見えない）。

**Phase 9.93 での扱い**:
- 「1.1 Phase 9.9 残務の統合 > FIX-01: Admin Role Fix」で検証・修正

---

### Phase 9.9-B: リードステータス刷新 & 失注タブ

**目的**: 営業フローを「未接触・反応あり・商談中・成約」の4段階に厳格化する。

**タスク**:
1.  **Schema Update**: `LeadStatus` 型定義を変更。
    - `UNCONTACTED` (未接触), `RESPONDED` (反応あり), `NEGOTIATION` (商談中), `WON` (成約), `LOST` (失注)。
2.  **Kanban UI**: リード管理画面 (`/leads`) を上記4カラム構成に変更。
3.  **Lost Tab**: 新規ページ `app/(app)/leads/lost/page.tsx` を作成。
    - `status === 'LOST'` のリードをリスト表示。
    - 「敗者復活（ステータスを未接触に戻す）」ボタンを設置。

**DOD**:
- [ ] リード画面が4カラムになっている。
- [ ] 「失注」にドラッグするとカンバンから消え、失注タブに移動する。

**Phase 9.93 での扱い**:
- 「1.1 Phase 9.9 残務の統合 > L-01: Lead Status」で検証・修正
- 「1.1 Phase 9.9 残務の統合 > L-02: Lost Tab」で検証・修正

---

### Phase 9.9-C: 成約 → 既存客 移行フロー

**目的**: 営業（Leads）からカスタマーサクセス（Clients）へのデータ連携。

**タスク**:
1.  **Auto Copy**: API `/api/leads/[id]/status` 更新処理内で、ステータスが `WON` になった場合、自動的に `clients` テーブルへ基本情報（社名・担当者・連絡先）をコピーする。
    - `contract_date` は `NULL` で作成。
2.  **Client UI**: 既存客編集モーダルに「契約日 (Contract Date)」入力欄を追加。

**DOD**:
- [ ] リードを「成約」にすると、既存客タブにデータがコピーされる。
- [ ] 既存客タブで契約日を保存できる。

**Phase 9.93 での扱い**:
- 「1.1 Phase 9.9 残務の統合 > C-01: Won Transition」で検証・修正
- 「1.1 Phase 9.9 残務の統合 > C-02: Contract Date」で検証・修正

---

### Phase 9.9-D: SAタブ & 権限階層 (Governance)

**目的**: スーパーアドミンによる全視界の確保と、組織階層の秩序維持。

**タスク**:
1.  **SA Tab**: `app/(app)/admin/sa/page.tsx` を作成（`fdc_admin` 専用）。
    - `sessions` テーブルをクエリし、全ユーザーの「現在のワークスペース」と「最終アクセス」を一覧表示。
2.  **3-2-1 Rule**: `lib/core/roles.ts` に `canManageRole(myRole, targetRole)` を実装。
    - Admin(3) > EXEC(2) > MANAGER(1) > MEMBER(0)
    - 上位者は下位者のみ操作可能。
3.  **UI適用**:
    - 招待モーダル: 自分が招待可能なロールのみ選択肢に表示。

**DOD**:
- [ ] SAタブでリアルタイム監視ができる。
- [ ] 権限階層が UI で強制される。

**Phase 9.93 での扱い**:
- 「1.1 Phase 9.9 残務の統合 > GOV-04: SA Dashboard」で検証・修正
- 「1.1 Phase 9.9 残務の統合 > GOV-05: 3-2-1 Rule」で検証・修正

---

### Phase 9.9-E: E2E テスト検証 (Quality Assurance)

**目的**: 複雑化した権限とステータス遷移が正しく動作することを自動テストで保証する。

**タスク**:
1.  **Test File**: `tests/e2e/governance-and-leads.spec.ts` を新規作成。
2.  **Test Cases**:
    - **Case 1 (Sidebar)**: Adminユーザーと一般ユーザーでログインし、タブの表示/非表示を検証。
    - **Case 2 (Lead Flow)**: リード作成 → ステータス変更 → WON → Client タブにデータが存在することを確認。
    - **Case 3 (Lost Flow)**: リード作成 → LOST → Lostタブに移動 → 敗者復活を確認。
    - **Case 4 (3-2-1 Rule)**: MANAGER でログインし、招待モーダルに「EXEC」が表示されないことを確認。

**DOD**:
- [ ] `npm run test:e2e` で新規テストが全て Pass する。

**Phase 9.93 での扱い**:
- 「1.1 Phase 9.9 残務の統合 > TEST-01: E2E Verification」で実装・実行

---

## 4. Phase 9.93 への移行

### 4.1 Phase 9.9 の残務を処理する場合

Phase 9.9 の残務（未処理タスク）を処理する場合は、以下の手順に従ってください：

1. **Phase 9.93 ランブックを開く**:
   - `docs/PHASE9.93-BUGFIX-RUNBOOK.md` を参照

2. **該当するタスクを確認**:
   - 「1. Phase 9.9 / 9.91 残務の統合リスト > 1.1 Phase 9.9 残務の統合」で該当するタスクを確認

3. **検証方法を実施**:
   - 各タスクの「検証方法」に従って、動作を確認

4. **不具合があれば修正**:
   - 「4. バグ修正ワークフロー」に従って修正

5. **DOD を満たすまで繰り返す**:
   - 「5. 完了条件（DOD）> 5.4 Phase 9.9 残務要件」を満たすまで修正を繰り返す

### 4.2 Phase 9.93 で使用する Claude Code への指示テンプレート

```markdown
あなたは Founders Direct Cockpit (FDC) プロジェクトの Phase 9.93 担当エンジニアです。

【作業内容】
Phase 9.9 の残務を処理します。

【タスク】
- FIX-01: Admin Role Fix
- L-01: Lead Status
- L-02: Lost Tab
- C-01: Won Transition
- C-02: Contract Date
- GOV-04: SA Dashboard
- GOV-05: 3-2-1 Rule
- TEST-01: E2E Verification

【作業指示】
1. `docs/PHASE9.93-BUGFIX-RUNBOOK.md` を参照
2. 「1.1 Phase 9.9 残務の統合」に従って、各タスクを検証・修正
3. 「5.4 Phase 9.9 残務要件」を満たすまで修正を繰り返す

【完了レポート】
- 検証結果
- 修正内容（あれば）
- DOD チェック結果
```

---

## 5. アーカイブ情報

### 5.1 Phase 9.9 の実装状況（参考）

Phase 9.9 は以下のサブフェーズで構成されていました：

- **Phase 9.9-A**: 権限・表示バグ修正 (Critical)
- **Phase 9.9-B**: リードステータス刷新 & 失注タブ
- **Phase 9.9-C**: 成約 → 既存客 移行フロー
- **Phase 9.9-D**: SAタブ & 権限階層 (Governance)
- **Phase 9.9-E**: E2E テスト検証 (Quality Assurance)

### 5.2 Phase 9.9 の開発プロンプト（参考）

Phase 9.9 の実装時に使用していたプロンプトは、Phase 9.93 で統合されました。

Phase 9.93 の開発プロンプトは、`docs/PHASE9.93-BUGFIX-RUNBOOK.md` の「8. Claude Code への指示テンプレート」を参照してください。

---

## 6. FDC-GRAND-GUIDE 更新テンプレート

Phase 9.9 完了時に `docs/FDC-GRAND-GUIDE.md` を以下のように更新してください：

```markdown
### Phase 9.9: 緊急バグ修正 & ガバナンス強化
**ステータス**: ✅ 完了（残務は Phase 9.92/9.93 に委譲）
**目的**: 権限・リード管理・SAタブの実装
**残務**: Phase 9.93 で最終検証・修正を実施

### Phase 9.91: 大規模クリーンアップ & 構造改革
**ステータス**: ✅ 完了（残務は Phase 9.92/9.93 に委譲）
**目的**: レガシーコード隔離、ドキュメント標準化
**残務**: Phase 9.93 で最終検証を実施

### Phase 9.92: 全タブ再生プロジェクト
**ステータス**: 🚧 実装中
**目的**: 旧UI完全再現 + 全10タブのReact/ViewModel化
**アプローチ**: 1タブずつ順次移行（ダッシュボード → Leads → Clients → ...）

### Phase 9.93: 最終バグ修正 & 完全整合性確保
**ステータス**: ⏸️ 待機中（Phase 9.92 完了後に開始）
**目的**: UI差異・ロジック差異・Next.js固有バグをゼロ化
**スコープ**: Phase 9.9/9.91 残務 + Phase 9.92 移行で発生した差異修正

### Phase 10: TODO機能本格実装（Elastic Search統合）
**ステータス**: ⏸️ 待機中（Phase 9.93 完了後に開始）
**目的**: TODO管理の高度化、Elastic Action Map実装
```

---

**最終更新:** 2025-11-25
**次のアクション**: Phase 9.93 ランブック（`docs/PHASE9.93-BUGFIX-RUNBOOK.md`）を参照し、Phase 9.9 の残務を処理してください。
