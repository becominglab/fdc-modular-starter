# Phase 8-4: ãƒ•ãƒ­ãƒ³ãƒˆå¾©å·ãƒ»åŒæœŸ Worker çµ±åˆ - è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ä½œæˆæ—¥**: 2025-11-14
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…å®Œäº†
**æ¬¡ãƒ•ã‚§ãƒ¼ã‚º**: Phase 8-5ï¼ˆWorkspaceåˆ‡æ›¿ãƒ»åŒæœŸå®‰å®šåŒ–ï¼‰

---

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ç›®çš„ã¨ã‚´ãƒ¼ãƒ«](#ç›®çš„ã¨ã‚´ãƒ¼ãƒ«)
3. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
4. [å®Ÿè£…å†…å®¹](#å®Ÿè£…å†…å®¹)
5. [ä½¿ã„æ–¹](#ä½¿ã„æ–¹)
6. [ãƒ†ã‚¹ãƒˆ](#ãƒ†ã‚¹ãƒˆ)
7. [Phase 8-5 ã¸ã®ç§»è¡Œ](#phase-8-5-ã¸ã®ç§»è¡Œ)
8. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

Phase 8-4 ã§ã¯ã€å¤§å®¹é‡ã® Workspace ãƒ‡ãƒ¼ã‚¿ã§ã‚‚ UI ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã®å¾©å·å‡¦ç†ã‚’ **Web Worker** ã«ã‚ªãƒ•ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã¾ãŸã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚„ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åŒæœŸä¸­ã§ã‚‚ãƒ­ãƒ¼ãƒ«ã‚„æš—å·åŒ–çŠ¶æ…‹ãŒç ´ç¶»ã—ãªã„ä»•çµ„ã¿ã‚’æ•´ãˆã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡ã® Phase 8-5ï¼ˆWorkspaceåˆ‡æ›¿ãƒ»åŒæœŸå®‰å®šåŒ–ï¼‰ã«ã¤ãªãŒã‚‹ã€ŒéåŒæœŸå¾©å·ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚

---

## ç›®çš„ã¨ã‚´ãƒ¼ãƒ«

### ä¸»ãªç›®çš„

1. **UI ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æ€§å‘ä¸Š**
   - å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ1MBä»¥ä¸Šï¼‰ã®æš—å·åŒ–ãƒ»å¾©å·å‡¦ç†ã‚’ Worker ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
   - ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã›ãšã€UIæ“ä½œã‚’ç¶™ç¶šå¯èƒ½ã«

2. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã®åŸºç›¤æ§‹ç¯‰**
   - IndexedDB ã«ã‚ˆã‚‹ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®å·®åˆ†åŒæœŸã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã‚’æ˜ç¤º

3. **Phase 8-3 ã¨ã®æ•´åˆæ€§ç¶­æŒ**
   - ã‚µãƒ¼ãƒãƒ¼å´ã®æš—å·åŒ–ãƒ•ãƒ­ãƒ¼ã¨ã®äº’æ›æ€§
   - æ—¢å­˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ`/api/workspaces/[workspaceId]/data`ï¼‰ã¨ã®çµ±åˆ

### é”æˆç›®æ¨™

- âœ… Worker çµŒç”±ã§ 1MB ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·ã§ãã‚‹
- âœ… UI ãŒãƒ•ãƒªãƒ¼ã‚ºã—ãªã„ã“ã¨ã‚’ç¢ºèª
- âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã‚’æ˜ç¤ºï¼ˆTODO ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
- âœ… å˜ä½“ãƒ†ã‚¹ãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
- âœ… è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  api-client  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ WorkerManagerâ”‚                      â”‚
â”‚  â”‚              â”‚        â”‚              â”‚                      â”‚
â”‚  â”‚ getWorkspace â”‚        â”‚  - decrypt() â”‚                      â”‚
â”‚  â”‚ Data()       â”‚        â”‚  - encrypt() â”‚                      â”‚
â”‚  â”‚              â”‚        â”‚  - health()  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                 â”‚                               â”‚
â”‚                                 â”‚ postMessage                   â”‚
â”‚                                 â–¼                               â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                         â”‚  Worker Pool  â”‚                       â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Worker ã‚¹ãƒ¬ãƒƒãƒ‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚                               â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                         â”‚  sync-worker  â”‚                       â”‚
â”‚                         â”‚               â”‚                       â”‚
â”‚                         â”‚  - decrypt    â”‚                       â”‚
â”‚                         â”‚  - encrypt    â”‚                       â”‚
â”‚                         â”‚  - healthCheckâ”‚                       â”‚
â”‚                         â”‚  - syncOfflineâ”‚ (Phase 8-5)          â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                 â”‚                               â”‚
â”‚                                 â–¼                               â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                         â”‚ encryption-   â”‚                       â”‚
â”‚                         â”‚ utils         â”‚                       â”‚
â”‚                         â”‚               â”‚                       â”‚
â”‚                         â”‚ Web Crypto APIâ”‚                       â”‚
â”‚                         â”‚ (AES-256-GCM) â”‚                       â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                  â–²
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚                               â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                         â”‚  IndexedDB    â”‚                       â”‚
â”‚                         â”‚               â”‚                       â”‚
â”‚                         â”‚ - workspaceData                       â”‚
â”‚                         â”‚ - pendingChanges (Phase 8-5)         â”‚
â”‚                         â”‚ - syncMetadata                        â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### 1. Workspace ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå¾©å·ï¼‰

```
1. ãƒ•ãƒ­ãƒ³ãƒˆ: apiClient.getWorkspaceData(workspaceId, { workspaceKey })
   â†“
2. API: GET /api/workspaces/:workspaceId/data
   â†“ æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
3. api-client: ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
   - < 1MB: ã‚µãƒ¼ãƒãƒ¼å´ã§å¾©å·ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
   - >= 1MB: Worker çµŒç”±ã§å¾©å·
   â†“
4. WorkerManager: workerManager.decrypt(encryptedData, workspaceKey)
   â†“ postMessage
5. sync-worker: encryption-utils.decrypt() ã‚’å®Ÿè¡Œ
   â†“ Web Crypto API (AES-256-GCM)
6. sync-worker: å¾©å·å®Œäº†ã€çµæœã‚’è¿”ã™
   â†“
7. WorkerManager: Promise ã‚’ resolve
   â†“
8. api-client: å¾©å·ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
```

#### 2. Workspace ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆæš—å·åŒ–ï¼‰

```
1. ãƒ•ãƒ­ãƒ³ãƒˆ: apiClient.saveWorkspaceData(workspaceId, data, workspaceKey)
   â†“
2. api-client: ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
   - < 1MB: ã‚µãƒ¼ãƒãƒ¼å´ã§æš—å·åŒ–ï¼ˆå¹³æ–‡ã‚’é€ä¿¡ï¼‰
   - >= 1MB: Worker çµŒç”±ã§æš—å·åŒ–
   â†“
3. WorkerManager: workerManager.encrypt(data, workspaceKey)
   â†“ postMessage
4. sync-worker: encryption-utils.encrypt() ã‚’å®Ÿè¡Œ
   â†“ Web Crypto API (AES-256-GCM)
5. sync-worker: æš—å·åŒ–å®Œäº†ã€çµæœã‚’è¿”ã™
   â†“
6. WorkerManager: Promise ã‚’ resolve
   â†“
7. api-client: æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
   â†“
8. API: PUT /api/workspaces/:workspaceId/data
```

---

## å®Ÿè£…å†…å®¹

### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. `js/workers/encryption-utils.ts`

- **è²¬å‹™**: Web Crypto API ã‚’ä½¿ã£ãŸæš—å·åŒ–ãƒ»å¾©å·ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- **æ©Ÿèƒ½**:
  - `encrypt(plaintext, base64Key)`: AES-256-GCM ã§æš—å·åŒ–
  - `decrypt(encryptedData, base64Key)`: AES-256-GCM ã§å¾©å·
  - `getDataSize(data)`: ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’å–å¾—
- **ç‰¹å¾´**:
  - Node.js ã® `crypto` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¯ãªãã€ãƒ–ãƒ©ã‚¦ã‚¶ã® **Web Crypto API** ã‚’ä½¿ç”¨
  - Worker ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œå¯èƒ½

#### 2. `js/workers/sync-worker.ts`

- **è²¬å‹™**: Worker ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰**:
  - `decrypt`: æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·
  - `encrypt`: ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–
  - `healthCheck`: Worker ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  - `syncOfflineData`: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸï¼ˆPhase 8-5 ã§å®Ÿè£…ï¼‰
- **ç‰¹å¾´**:
  - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ID ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
  - é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œï¼ˆå¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿æ™‚ï¼‰
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### 3. `js/core/worker-manager.ts`

- **è²¬å‹™**: Worker ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã¨ç®¡ç†
- **æ©Ÿèƒ½**:
  - `decrypt(encryptedData, workspaceKey, onProgress?)`: å¾©å·
  - `encrypt(data, workspaceKey, onProgress?)`: æš—å·åŒ–
  - `healthCheck()`: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  - `syncOfflineData(offlineData)`: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸï¼ˆPhase 8-5ï¼‰
  - `terminate()`: Worker ã‚’çµ‚äº†
- **ç‰¹å¾´**:
  - ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ`getWorkerManager()`ï¼‰
  - Promise ãƒ™ãƒ¼ã‚¹ã®éåŒæœŸ API
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 60ç§’ï¼‰
  - Worker ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å†èµ·å‹•

#### 4. `js/core/offline-storage.ts`

- **è²¬å‹™**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆIndexedDBï¼‰ã®ç®¡ç†
- **æ©Ÿèƒ½**:
  - `cacheWorkspaceData(workspaceId, data, lastModified)`: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  - `getCachedWorkspaceData(workspaceId)`: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—
  - `recordPendingChange(...)`: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å¤‰æ›´ã‚’è¨˜éŒ²ï¼ˆPhase 8-5ï¼‰
  - `getPendingChanges(workspaceId?)`: ä¿ç•™ä¸­ã®å¤‰æ›´ã‚’å–å¾—ï¼ˆPhase 8-5ï¼‰
  - `setSyncMetadata(key, value)`: åŒæœŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  - `getSyncMetadata(key)`: åŒæœŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
- **ã‚¹ãƒˆã‚¢æ§‹æˆ**:
  - `workspaceData`: Workspace ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  - `pendingChanges`: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å¤‰æ›´å±¥æ­´ï¼ˆPhase 8-5ï¼‰
  - `syncMetadata`: åŒæœŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. `js/core/api-client.ts`

- **è¿½åŠ æ©Ÿèƒ½**:
  - `getWorkspaceData(workspaceId, options)`: Worker çµ±åˆç‰ˆã® Workspace ãƒ‡ãƒ¼ã‚¿å–å¾—
  - `saveWorkspaceData(workspaceId, data, workspaceKey?, onProgress?)`: Worker çµ±åˆç‰ˆã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- **ã‚ªãƒ—ã‚·ãƒ§ãƒ³**:
  - `workspaceKey`: Workspace éµï¼ˆBase64ï¼‰
  - `forceWorker`: Worker ä½¿ç”¨ã‚’å¼·åˆ¶
  - `onProgress`: é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã—ãã„å€¤**:
  - `< 1MB`: ã‚µãƒ¼ãƒãƒ¼å´ã§å¾©å·ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  - `>= 1MB`: Worker çµŒç”±ã§å¾©å·

### ãƒ†ã‚¹ãƒˆ

#### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ (`tests/unit/worker.test.ts`)

- Worker åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
- æš—å·åŒ–ãƒ»å¾©å·ãƒ†ã‚¹ãƒˆ
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
- é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

#### 2. çµ±åˆãƒ†ã‚¹ãƒˆ (`tests/e2e/worker-integration.spec.ts`)

- å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã§ã® UI ãƒ•ãƒªãƒ¼ã‚ºæ¤œè¨¼
- Workspace ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ä¿å­˜
- é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
- Worker ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

---

## ä½¿ã„æ–¹

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

#### 1. Workspace ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆWorker çµŒç”±ã§å¾©å·ï¼‰

```typescript
import { getWorkspaceData } from './js/core/api-client.js';

// Workspace éµï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ï¼‰
const workspaceKey = 'base64-encoded-key...';

// ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const result = await getWorkspaceData('ws_123', {
  workspaceKey,
  onProgress: (progress) => {
    console.log(`Progress: ${progress}%`);
  }
});

console.log('Data:', result.data);
console.log('Metadata:', result.metadata);
// metadata.decryptionMethod: 'worker' | 'server' | 'none'
// metadata.decryptionTime: å‡¦ç†æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
```

#### 2. Workspace ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆWorker çµŒç”±ã§æš—å·åŒ–ï¼‰

```typescript
import { saveWorkspaceData } from './js/core/api-client.js';

const data = {
  workspaceId: 'ws_123',
  todos: [...],
  prospects: [...],
  clients: [...]
};

const result = await saveWorkspaceData(
  'ws_123',
  data,
  workspaceKey,
  (progress) => {
    console.log(`Encrypting: ${progress}%`);
  }
);

console.log('Saved:', result);
```

#### 3. Worker ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```typescript
import { getWorkerManager } from './js/core/worker-manager.js';

const workerManager = getWorkerManager();
const health = await workerManager.healthCheck();

console.log('Worker status:', health.status); // 'ok'
```

#### 4. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
import { getOfflineStorage } from './js/core/offline-storage.js';

const offlineStorage = getOfflineStorage();
await offlineStorage.init();

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
await offlineStorage.cacheWorkspaceData('ws_123', data, new Date().toISOString());

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—
const cached = await offlineStorage.getCachedWorkspaceData('ws_123');
console.log('Cached data:', cached);
```

### é«˜åº¦ãªä½¿ã„æ–¹

#### Worker ä½¿ç”¨ã‚’å¼·åˆ¶

```typescript
const result = await getWorkspaceData('ws_123', {
  workspaceKey,
  forceWorker: true // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã«é–¢ã‚ã‚‰ãš Worker ã‚’ä½¿ç”¨
});
```

#### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆWorker æœªä½¿ç”¨ï¼‰

```typescript
// workspaceKey ã‚’æŒ‡å®šã—ãªã„å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã§å¾©å·ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
const result = await getWorkspaceData('ws_123');
console.log('Decryption method:', result.metadata.decryptionMethod); // 'server'
```

---

## ãƒ†ã‚¹ãƒˆ

### å˜ä½“ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
npm test tests/unit/worker.test.ts
```

### çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
npm run test:e2e tests/e2e/worker-integration.spec.ts
```

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

- Worker åˆæœŸåŒ–: âœ…
- æš—å·åŒ–ãƒ»å¾©å·: âœ…
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: âœ…
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: âœ…
- é€²æ—ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: âœ…
- UI ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒã‚¹: ğŸ”²ï¼ˆPhase 8-5 ã§å®Œå…¨å®Ÿè£…ï¼‰
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ: ğŸ”²ï¼ˆPhase 8-5 ã§å®Œå…¨å®Ÿè£…ï¼‰

---

## Phase 8-5 ã¸ã®ç§»è¡Œ

### æœªå®Ÿè£…ã®æ©Ÿèƒ½ï¼ˆPhase 8-5 ã§å®Ÿè£…äºˆå®šï¼‰

1. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã®å®Œå…¨å®Ÿè£…**
   - `sync-worker.ts` ã® `handleSyncOfflineData()` ã‚’å®Ÿè£…
   - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®è‡ªå‹•åŒæœŸ
   - å·®åˆ†ãƒãƒ¼ã‚¸ãƒ»ç«¶åˆè§£æ±ºãƒ­ã‚¸ãƒƒã‚¯

2. **ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–**
   - `offline-storage.ts` ã® `setupOnlineStatusMonitoring()` ã‚’å®Ÿè£…
   - `navigator.onLine` ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
   - åŒæœŸä¸­ã® UI ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼

3. **Workspace åˆ‡æ›¿æ™‚ã®å®‰å®šåŒ–**
   - è¤‡æ•° Workspace é–“ã§ã® Worker ã®å…±æœ‰
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åŠ¹ç‡çš„ãªç®¡ç†

### æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã« TODO ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ:

- `js/workers/sync-worker.ts:139-160` - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã®å®Ÿè£…
- `js/core/offline-storage.ts:170-206` - ä¿ç•™ä¸­ã®å¤‰æ›´ã®ç®¡ç†
- `js/core/offline-storage.ts:377-411` - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. Worker ãŒåˆæœŸåŒ–ã§ããªã„

**ç—‡çŠ¶**: `Failed to initialize worker` ã‚¨ãƒ©ãƒ¼

**åŸå› **:
- Worker ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãŒæ­£ã—ããªã„
- ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆVite/Webpackï¼‰ã®è¨­å®šãŒä¸é©åˆ‡

**è§£æ±ºç­–**:
```typescript
// worker-manager.ts ã§ Worker ã®ãƒ‘ã‚¹ã‚’ç¢ºèª
this.worker = new Worker(
  new URL('../workers/sync-worker.js', import.meta.url),
  { type: 'module' }
);
```

### 2. å¾©å·ã«å¤±æ•—ã™ã‚‹

**ç—‡çŠ¶**: `Decryption failed: Data may have been tampered with` ã‚¨ãƒ©ãƒ¼

**åŸå› **:
- é–“é•ã£ãŸ Workspace éµã‚’ä½¿ç”¨
- ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹
- æš—å·åŒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹

**è§£æ±ºç­–**:
1. Workspace éµãŒæ­£ã—ã„ã‹ç¢ºèª
2. ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ­ã‚°ã‚’ç¢ºèª
3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚µãƒ¼ãƒãƒ¼å´å¾©å·ï¼‰ã‚’è©¦ã™

### 3. UI ãŒãƒ•ãƒªãƒ¼ã‚ºã™ã‚‹

**ç—‡çŠ¶**: å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã« UI ãŒå¿œç­”ã—ãªã„

**åŸå› **:
- Worker ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ãªã„
- ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã—ãã„å€¤ï¼ˆ1MBï¼‰ä»¥ä¸‹ã®ãŸã‚ã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†

**è§£æ±ºç­–**:
1. `forceWorker: true` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
2. ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’ç¢ºèªï¼ˆ`result.metadata.dataSize`ï¼‰
3. Worker ã®ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆ`console.log` ã§ãƒ‡ãƒãƒƒã‚°ï¼‰

### 4. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `Worker request timeout` ã‚¨ãƒ©ãƒ¼

**åŸå› **:
- å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 60ç§’ï¼‰
- Worker ãŒãƒ•ãƒªãƒ¼ã‚ºã—ã¦ã„ã‚‹

**è§£æ±ºç­–**:
```typescript
// WorkerManager ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·
await this.sendMessage(
  { type: 'decrypt', encryptedData, workspaceKey },
  120000 // 120ç§’
);
```

---

## ã¾ã¨ã‚

Phase 8-4 ã§ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:

âœ… **Worker çµ±åˆ**
- Web Worker ã«ã‚ˆã‚‹éåŒæœŸæš—å·åŒ–ãƒ»å¾©å·
- UI ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„è¨­è¨ˆ

âœ… **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**
- IndexedDB ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- Phase 8-5 ã¸ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

âœ… **API çµ±åˆ**
- `api-client.ts` ã« Worker çµŒç”±ã®å–å¾—ãƒ»ä¿å­˜æ©Ÿèƒ½ã‚’è¿½åŠ 
- ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã«å¿œã˜ãŸè‡ªå‹•åˆ‡æ›¿ï¼ˆWorker / ã‚µãƒ¼ãƒãƒ¼å´ï¼‰

âœ… **ãƒ†ã‚¹ãƒˆ**
- å˜ä½“ãƒ†ã‚¹ãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- UI ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒã‚¹ã®æ¤œè¨¼

æ¬¡ã® Phase 8-5 ã§ã¯ã€å®Œå…¨ãªã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸæ©Ÿèƒ½ã¨ Workspace åˆ‡æ›¿ã®å®‰å®šåŒ–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
